'use strict';var TITLE_SCREEN=false;var LOADING_SCREEN=false;var LEVEL_GEN=true;var DEBUG_MODE=false;var UP=0,RIGHT=1,DOWN=2,LEFT=3;var OPEN=0,CLOSED=1;var entity_player=0,entity_mob=1;var physical_solid=true,physical_non_solid=false;var display_opaque=true,display_transparent=false;var entity_active_range=20;var CENTER_SQUARE=0,TOP_LEFT=1,BOTTOM_RIGHT=2,UPPER_BOUND=3,LOWER_BOUND=4;var PERM=.5;var xxcomp=[1,0,0,-1,-1,0,0,1];var xycomp=[0,1,-1,0,0,-1,1,0];var yxcomp=[0,1,1,0,0,-1,-1,0];var yycomp=[1,0,0,1,-1,0,0,-1];var light_range=10,light_max=light_range-1;var light_intensity=.25,light_red=255,light_green=190,light_blue=0;var shadow_intensity=0.4,shadow_stop=4,shadow_red=10,shadow_green=0,shadow_blue=40;var light_fill_string='rgba('+light_red+','+light_green+','+light_blue+','+light_intensity+')';var light_level_to_light=[];var light_level_to_shadow=[];for(var i=0;i<light_range;i++){light_level_to_light.unshift('rgba('+floor(light_red-light_red/(light_range-1)*i)+','+floor(light_green-light_green/(light_range-1)*i)+','+floor(light_blue-light_blue/(light_range-1)*i)+','+floor(100*(light_intensity-light_intensity/(light_range-1)*i))/100+')');if(i>shadow_stop){light_level_to_shadow.push('rgba(0,0,0,0)')}else{light_level_to_shadow.push('rgba('+floor(shadow_red-shadow_red/shadow_stop*i)+','+floor(shadow_green-shadow_green/shadow_stop*i)+','+floor(shadow_blue-shadow_blue/shadow_stop*i)+','+floor(100*(shadow_intensity-shadow_intensity/shadow_stop*i))/100+')')}}light_level_to_light[light_level_to_light.length-1]=light_level_to_light[light_level_to_light.length-2];var light_level_player=4,light_level_torch=light_max-2;var direction_up=0,direction_right=1,direction_down=2,direction_left=3;var square_floor=0,square_wall=1,square_door=2,square_stair_down=3,square_stair_up=4,square_loot=5;var texture_floor=0,texture_wall=1,texture_door_closed=2,texture_door_open=3,texture_loot_closed=4,texture_loot_open=5,texture_stair_up=6,texture_stair_down=7;var texture_default=0,texture_alt1=1,texture_alt2=2,texture_alt3=3,texture_alt4=4,texture_alt5=5,texture_alt6=6,texture_alt7=7,texture_alt8=8,texture_alt9=9,texture_side_top=10,texture_side_right=11,texture_side_bottom=12,texture_side_left=13,texture_in_corner_top_right=14,texture_in_corner_bottom_right=15,texture_in_corner_bottom_left=16,texture_in_corner_top_left=17,texture_out_corner_top_right=18,texture_out_corner_bottom_right=19,texture_out_corner_bottom_left=20,texture_out_corner_top_left=21,texture_U_top=22,texture_U_right=23,texture_U_bottom=24,texture_U_left=25,texture_cross=26,texture_num_alts=27;var texture_probability_distribution=[];texture_probability_distribution[0]=55;texture_probability_distribution[1]=texture_probability_distribution[0]+34;texture_probability_distribution[2]=texture_probability_distribution[1]+21;texture_probability_distribution[3]=texture_probability_distribution[2]+13;texture_probability_distribution[4]=texture_probability_distribution[3]+8;texture_probability_distribution[5]=texture_probability_distribution[4]+5;texture_probability_distribution[6]=texture_probability_distribution[5]+3;texture_probability_distribution[7]=texture_probability_distribution[6]+2;texture_probability_distribution[8]=texture_probability_distribution[7]+1;texture_probability_distribution[9]=texture_probability_distribution[8]+1;var texture_probability_max=texture_probability_distribution[texture_probability_distribution.length-1];var ui_heart=0,ui_empty_heart=1;var component_position=0,component_movement=1,component_display=2,component_texture=3,component_animation=4,component_actions=5,component_physical=6,component_sprint=7,component_direction=8,component_map=9,component_health=10,component_light=11,component_strength=12,component_dexterity=13,component_magic=14,component_level=15,component_depth=16,component_stair=17,component_combat=18,component_ai=19,component_light_emitter=20,component_collision=21;var event_new_game=0,event_reset_game=1,event_window_resized=2,event_player_generated=3,event_down_level=4,event_up_level=5,event_new_level=6,event_level_loaded=7,event_entities_loaded=8,event_begin_level=9,event_player_moved=10,event_entity_moved=11,event_player_start_sprinting=12,event_player_stop_sprinting=13,event_open_door=14,event_successful_action=20,event_failed_action=21,event_new_animation=30,event_hitstun=31,event_begin_combat=40,event_end_combat=41,event_entity_attacked=42,event_player_melee_attack=43,event_player_spin_attack=44,event_player_take_damage=45,event_entity_spawned=50,event_spawn_enemy_close=51,event_title_screen=999,event_game_over=1000;var animation_idle=0,animation_move_up=1,animation_move_right=2,animation_move_down=3,animation_move_left=4,animation_sprint_up=5,animation_sprint_right=6,animation_sprint_down=7,animation_sprint_left=8,animation_melee_attack_up=9,animation_melee_attack_right=10,animation_melee_attack_down=11,animation_melee_attack_left=12,animation_spin_attack=13;var action_none=-1,action_move=0,action_move_up=1,action_move_right=2,action_move_down=3,action_move_left=4,action_sprint=10,action_sprint_up=11,action_sprint_right=12,action_sprint_down=13,action_sprint_left=14,action_melee_attack=20,action_melee_attack_up=21,action_melee_attack_right=22,action_melee_attack_down=23,action_melee_attack_left=24,action_spin_attack=25;var keyCode_to_action=[];keyCode_to_action[87]=action_move_up;keyCode_to_action[68]=action_move_right;keyCode_to_action[83]=action_move_down;keyCode_to_action[65]=action_move_left;keyCode_to_action[69]=action_melee_attack;keyCode_to_action[81]=action_spin_attack;keyCode_to_action[38]=action_move_up;keyCode_to_action[39]=action_move_right;keyCode_to_action[40]=action_move_down;keyCode_to_action[37]=action_move_left;var action_to_priority=[];action_to_priority[action_none]=0;action_to_priority[action_move_up]=3;action_to_priority[action_move_left]=3;action_to_priority[action_move_down]=3;action_to_priority[action_move_right]=3;action_to_priority[action_melee_attack]=4;action_to_priority[action_spin_attack]=4;var movement_to_sprint=[];movement_to_sprint[action_move_up]=action_sprint_up;movement_to_sprint[action_move_right]=action_sprint_right;movement_to_sprint[action_move_down]=action_sprint_down;movement_to_sprint[action_move_left]=action_sprint_left;var sprint_to_movement=[];sprint_to_movement[action_sprint_up]=action_move_up;sprint_to_movement[action_sprint_right]=action_move_right;sprint_to_movement[action_sprint_down]=action_move_down;sprint_to_movement[action_sprint_left]=action_move_left;var action_to_length=[];action_to_length[action_move_up]=100;action_to_length[action_move_right]=100;action_to_length[action_move_down]=100;action_to_length[action_move_left]=100;action_to_length[action_sprint]=60;action_to_length[action_melee_attack_up]=250;action_to_length[action_melee_attack_right]=250;action_to_length[action_melee_attack_down]=250;action_to_length[action_melee_attack_left]=250;action_to_length[action_spin_attack]=300;var action_to_direction=[];action_to_direction[action_move_up]=direction_up;action_to_direction[action_move_right]=direction_right;action_to_direction[action_move_down]=direction_down;action_to_direction[action_move_left]=direction_left;action_to_direction[action_sprint_up]=direction_up;action_to_direction[action_sprint_right]=direction_right;action_to_direction[action_sprint_down]=direction_down;action_to_direction[action_sprint_left]=direction_left;var direction_to_attack=[];direction_to_attack[direction_up]=action_melee_attack_up;direction_to_attack[direction_right]=action_melee_attack_right;direction_to_attack[direction_down]=action_melee_attack_down;direction_to_attack[direction_left]=action_melee_attack_left;var direction_to_movement=[];direction_to_movement[direction_up]=action_move_up;direction_to_movement[direction_right]=action_move_right;direction_to_movement[direction_down]=action_move_down;direction_to_movement[direction_left]=action_move_left;var direction_to_action=[];direction_to_action[action_move+direction_up]=action_move_up;direction_to_action[action_move+direction_right]=action_move_right;direction_to_action[action_move+direction_down]=action_move_down;direction_to_action[action_move+direction_left]=action_move_left;var action_to_animation=[];action_to_animation[action_none]=animation_idle;action_to_animation[action_move_up]=animation_move_up;action_to_animation[action_move_right]=animation_move_right;action_to_animation[action_move_down]=animation_move_down;action_to_animation[action_move_left]=animation_move_left;action_to_animation[action_sprint_up]=animation_sprint_up;action_to_animation[action_sprint_right]=animation_sprint_right;action_to_animation[action_sprint_down]=animation_sprint_down;action_to_animation[action_sprint_left]=animation_sprint_left;action_to_animation[action_melee_attack_up]=animation_melee_attack_up;action_to_animation[action_melee_attack_right]=animation_melee_attack_right;action_to_animation[action_melee_attack_down]=animation_melee_attack_down;action_to_animation[action_melee_attack_left]=animation_melee_attack_left;action_to_animation[action_spin_attack]=animation_spin_attack;var animation_strings_to_constants=[];animation_strings_to_constants['animation_idle']=animation_idle;animation_strings_to_constants['animation_move_up']=animation_move_up;animation_strings_to_constants['animation_move_right']=animation_move_right;animation_strings_to_constants['animation_move_down']=animation_move_down;animation_strings_to_constants['animation_move_left']=animation_move_left;animation_strings_to_constants['animation_sprint_up']=animation_sprint_up;animation_strings_to_constants['animation_sprint_right']=animation_sprint_right;animation_strings_to_constants['animation_sprint_down']=animation_sprint_down;animation_strings_to_constants['animation_sprint_left']=animation_sprint_left;animation_strings_to_constants['animation_melee_attack_up']=animation_melee_attack_up;animation_strings_to_constants['animation_melee_attack_right']=animation_melee_attack_right;animation_strings_to_constants['animation_melee_attack_down']=animation_melee_attack_down;animation_strings_to_constants['animation_melee_attack_left']=animation_melee_attack_left;animation_strings_to_constants['animation_spin_attack']=animation_spin_attack;var action_strings_to_constants=[];action_strings_to_constants['action_none']=action_none;action_strings_to_constants['action_move_up']=action_move_up;action_strings_to_constants['action_move_right']=action_move_right;action_strings_to_constants['action_move_down']=action_move_down;action_strings_to_constants['action_move_left']=action_move_left;action_strings_to_constants['action_sprint_up']=action_sprint_up;action_strings_to_constants['action_sprint_right']=action_sprint_right;action_strings_to_constants['action_sprint_down']=action_sprint_down;action_strings_to_constants['action_sprint_left']=action_sprint_left;action_strings_to_constants['action_melee_attack_up']=action_melee_attack_up;action_strings_to_constants['action_melee_attack_right']=action_melee_attack_right;action_strings_to_constants['action_melee_attack_down']=action_melee_attack_down;action_strings_to_constants['action_melee_attack_left']=action_melee_attack_left;action_strings_to_constants['action_spin_attack']=action_spin_attack;
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var System=function(){function System(componentRequirements){_classCallCheck(this,System);this.objects=[];this.componentRequirements=componentRequirements}_createClass(System,[{key:"init",value:function init(engine){}},{key:"addObject",value:function addObject(object){if(this.componentRequirements.length>0&&!this.objects.includes(object)&&Utility.checkComponents(object,this.componentRequirements)){this.objects.push(object)}}},{key:"removeObject",value:function removeObject(object){if(this.objects.indexOf(object)!==-1){this.objects.splice(this.objects.indexOf(object),1)}}},{key:"clearObjects",value:function clearObjects(){this.objects=[]}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){}}]);return System}();
'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var PoppsEngine=function(){function PoppsEngine(data){var _this=this;_classCallCheck(this,PoppsEngine);var config=data.config;var room_pool=data.room_pool;var stair_room_pool=data.stair_room_pool;var images=data.images.textures;var ui=data.images.ui;var player_data=data.player_data;var entity_data=data.entity_data;var boss_data=data.boss_data;this.systems=[];this.systems.push(new InputSystem);this.systems.push(new DisplaySystem(config.display,images));this.systems.push(new VisionSystem(config.vision));this.systems.push(new LightSystem(config.light));this.systems.push(new ActionSystem);this.systems.push(new MovementSystem);this.systems.push(new LevelSystem(config.level,room_pool,stair_room_pool));this.systems.push(new EntitySystem(config.entities,player_data,entity_data,boss_data));this.systems.push(new AnimationSystem(config.animation));this.systems.push(new CombatSystem);this.systems.push(new HealthSystem(config.health));this.systems.push(new AISystem(config.ai));this.systems.push(new SprintSystem);this.UISystem=new UISystem(config.ui,data.images.ui);this.systems.push(this.UISystem);this.init();window.requestAnimationFrame(function(){return _this.tick()});if(TITLE_SCREEN){this.sendEvent(event_title_screen)}else{this.sendEvent(event_new_game)}}_createClass(PoppsEngine,[{key:'init',value:function init(){this.clearObjects();this.UIOnly=true;this.events=[];this.DUNGEON={depth:0,player:undefined,map:undefined,levels:[],entities:[]};var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.systems[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var system=_step.value;system.init(this)}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}window.addEventListener('resize',this.sendEvent(event_window_resized))}},{key:'pause',value:function pause(){this.UIOnly=true}},{key:'resume',value:function resume(){this.UIOnly=false}},{key:'tick',value:function tick(){var _this2=this;this.handleEvents(this.events);if(this.UIOnly){this.UISystem.run(this)}else{var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=this.systems[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var s=_step2.value;s.run(this)}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}}window.requestAnimationFrame(function(){return _this2.tick()})}},{key:'sendEvent',value:function sendEvent(e){var data=arguments.length>1&&arguments[1]!==undefined?arguments[1]:undefined;var ticks=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;if(ticks==0){this.runEvent([e,data])}else{this.events.push([e,data,ticks])}}},{key:'handleEvents',value:function handleEvents(events){for(var i=events.length-1;i>=0;i--){if(events[i][2]>0){events[i][2]--}else{this.runEvent(events[i]);events.splice(i,1)}}}},{key:'runEvent',value:function runEvent(e){if(DEBUG_MODE){this.printEvent(e)}this.handleEvent(e[0],e[1]);var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=this.systems[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var s=_step3.value;s.handleEvent(this,e[0],e[1])}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}}},{key:'handleEvent',value:function handleEvent(event,data){switch(event){case event_new_game:this.resume();break;case event_reset_game:this.init();break;case event_game_over:this.pause();break;case event_down_level:this.DUNGEON.depth++;break;case event_up_level:this.DUNGEON.depth--;break;case event_new_level:this.DUNGEON.entities.push([]);break;}}},{key:'addObject',value:function addObject(object){var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=this.systems[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var s=_step4.value;s.addObject(object)}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return()}}finally{if(_didIteratorError4){throw _iteratorError4}}}if(object instanceof Player){this.DUNGEON.player=object}if(object instanceof Level){this.DUNGEON.levels[object.depth.depth]=object;this.DUNGEON.map=object.map.map}if(object instanceof Entity){if(!this.DUNGEON.entities[object.depth.depth].includes(object)){this.DUNGEON.entities[object.depth.depth].push(object)}}}},{key:'removeObject',value:function removeObject(object){var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=this.systems[Symbol.iterator](),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var s=_step5.value;s.removeObject(object)}}catch(err){_didIteratorError5=true;_iteratorError5=err}finally{try{if(!_iteratorNormalCompletion5&&_iterator5.return){_iterator5.return()}}finally{if(_didIteratorError5){throw _iteratorError5}}}if(object instanceof Mob){if(this.DUNGEON.entities[object.depth.depth].includes(object)){this.DUNGEON.entities[object.depth.depth].splice(this.DUNGEON.entities[object.depth.depth].indexOf(object),1)}}}},{key:'clearObjects',value:function clearObjects(){var _iteratorNormalCompletion6=true;var _didIteratorError6=false;var _iteratorError6=undefined;try{for(var _iterator6=this.systems[Symbol.iterator](),_step6;!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=true){var s=_step6.value;s.clearObjects()}}catch(err){_didIteratorError6=true;_iteratorError6=err}finally{try{if(!_iteratorNormalCompletion6&&_iterator6.return){_iterator6.return()}}finally{if(_didIteratorError6){throw _iteratorError6}}}}},{key:'printEvent',value:function printEvent(e){for(key in window){if(e[0]==window[key]&&key.includes('event_')){console.log(key)}}}},{key:'getDepth',value:function getDepth(){return this.DUNGEON.depth}},{key:'getPlayer',value:function getPlayer(){return this.DUNGEON.player}},{key:'getMap',value:function getMap(){return this.DUNGEON.map}},{key:'getLevel',value:function getLevel(){return this.DUNGEON.levels[this.DUNGEON.depth]}},{key:'getEntities',value:function getEntities(){return this.DUNGEON.entities[this.DUNGEON.depth]}}]);return PoppsEngine}();
'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var Utility=function(){function Utility(){_classCallCheck(this,Utility)}_createClass(Utility,null,[{key:'collision',value:function collision(o1,o2){return!(o1.top>=o2.bottom||o1.right<=o2.left||o1.bottom<=o2.top||o1.left>=o2.right)}},{key:'checkComponents',value:function checkComponents(object,requirements){for(var i=0;i<requirements.length;i++){if(object.components.indexOf(requirements[i])===-1)return false}return true}},{key:'entityActionSuccessful',value:function entityActionSuccessful(entity){entity.actions.busy=action_length[entity.actions.currentAction];entity.animation.newAnimation=true;entity.animation.animation=action_to_animation[entity.actions.currentAction];entity.actions.failedAction=action_none;entity.actions.lastAction=entity.actions.currentAction;entity.actions.currentAction=action_none}},{key:'entityActionFailed',value:function entityActionFailed(entity){entity.actions.lastAction=action_none;entity.actions.failedAction=entity.actions.currentAction;entity.actions.currentAction=action_none}},{key:'entityWithinRange',value:function entityWithinRange(e1,e2,dist){return abs(e1.position.x-e2.position.x)<dist&&abs(e1.position.y-e2.position.y)<dist}},{key:'positionInRange',value:function positionInRange(p1,p2,dist){return abs(p1.x-p2.x)<dist&&abs(p1.y-p2.y)<dist}},{key:'entityDistance',value:function entityDistance(e1,e2){if(e1.physical.size==1&&e2.physical.size==1){return Utility.distance(e1.position,e2.position)}else{var xDist=0;if(e1.collision.left>=e2.collision.right){xDist=abs(e1.collision.left-(e2.collision.right-1))}else if(e1.collision.right<=e2.collision.left){xDist=abs(e1.collision.right-1-e2.collision.left)}var yDist=0;if(e1.collision.top>=e2.collision.bottom){yDist=abs(e1.collision.top-(e2.collision.bottom-1))}else if(e1.collision.bottom<=e2.collision.top){yDist=abs(e1.collision.bottom-1-e2.collision.top)}return xDist+yDist}}},{key:'distance',value:function distance(p1,p2){return abs(p1.x-p2.x)+abs(p1.y-p2.y)}},{key:'getDirectionToEntity',value:function getDirectionToEntity(e1,e2){if(e1.position.y>e2.position.y){return direction_up}if(e1.position.x<e2.position.x){return direction_right}if(e1.position.y<e2.position.y){return direction_down}if(e1.position.x>e2.position.x){return direction_left}}},{key:'shortestPath',value:function shortestPath(map,startPosition,endPosition){}},{key:'convertMapToNodes',value:function convertMapToNodes(map){var nodeMap=new Array(map.length);for(var i=0;i<map.length;i++){nodeMap[i]=new Array(map.length);for(var j=0;j<map.length;j++){nodeMap[i][j]={'searched':false,'cameFrom':undefined,'distFromStart':10000,'finalCost':10000}}}return nodeMap}},{key:'getCollisionInFrontOf',value:function getCollisionInFrontOf(entity){return Utility.getCollisionInDirection(entity,entity.direction.direction)}},{key:'getCollisionInDirection',value:function getCollisionInDirection(entity,direction){switch(direction){case direction_up:return new CollisionComponent(entity.collision.left,entity.collision.top-1,entity.collision.width,1);case direction_right:return new CollisionComponent(entity.collision.right,entity.collision.top,1,entity.collision.height);case direction_down:return new CollisionComponent(entity.collision.left,entity.collision.bottom,entity.collision.width,1);case direction_left:return new CollisionComponent(entity.collision.left-1,entity.collision.top,1,entity.collision.height);default:console.log('Cannot determine direction');return;}}},{key:'entityAdjacent',value:function entityAdjacent(entity,otherEntity){var c1=entity.collision,c2=otherEntity.collision;if(Utility.collision(Utility.getCollisionInDirection(entity,direction_up),c2)){return direction_up}else if(Utility.collision(Utility.getCollisionInDirection(entity,direction_right),c2)){return direction_right}else if(Utility.collision(Utility.getCollisionInDirection(entity,direction_down),c2)){return direction_down}else if(Utility.collision(Utility.getCollisionInDirection(entity,direction_left),c2)){return direction_left}else{return-1}}},{key:'getSquareNeighbors',value:function getSquareNeighbors(x,y,map){neighbors=[];if(x>0){neighbors.push(map[x-1][y])}if(y>0){neighbors.push(map[x][y-1])}if(x<map.length-1){neighbors.push(map[x+1][y])}if(y<map.length-1){neighbors.push(map[x][y+1])}return neighbors}},{key:'findMobPath',value:function findMobPath(board,mob,player){return findPath(board,board[mob.position.x][mob.position.y],board[player.position.x][player.position.y])}},{key:'walkable',value:function walkable(x,y,map,entity,objects){return Utility.positionInBounds(new PositionComponent(x,y),map.length)&&Utility.squareTypeIsWalkable(map[x][y],entity)&&!Utility.squareIsOccupied(x,y,entity,objects)}},{key:'positionOnScreen',value:function positionOnScreen(x,y,w,h){return x>-w&&x<width+w&&y>-h&&y<height+h}},{key:'positionInBounds',value:function positionInBounds(position,size){return position.x>=0&&position.x<size&&position.y>=0&&position.y<size}},{key:'squareInBounds',value:function squareInBounds(square,size){return square.position.x>=0&&square.position.x<size&&square.position.y>=0&&square.position.y<size}},{key:'getNeighbors',value:function getNeighbors(square,map){var neighbors=new Array(4);if(Utility.positionInBounds(new PositionComponent(square.position.x,square.position.y-1),map.length)){neighbors[0]=map[square.position.x][square.position.y-1]}if(Utility.positionInBounds(new PositionComponent(square.position.x+1,square.position.y),map.length)){neighbors[1]=map[square.position.x+1][square.position.y]}if(Utility.positionInBounds(new PositionComponent(square.position.x,square.position.y+1),map.length)){neighbors[2]=map[square.position.x][square.position.y+1]}if(Utility.positionInBounds(new PositionComponent(square.position.x-1,square.position.y),map.length)){neighbors[3]=map[square.position.x-1][square.position.y]}return neighbors}},{key:'getCornerNeighbors',value:function getCornerNeighbors(square,map){var neighbors=new Array(4);if(Utility.positionInBounds(new PositionComponent(square.position.x-1,square.position.y-1),map.length)){neighbors[0]=map[square.position.x-1][square.position.y-1]}if(Utility.positionInBounds(new PositionComponent(square.position.x+1,square.position.y-1),map.length)){neighbors[1]=map[square.position.x+1][square.position.y-1]}if(Utility.positionInBounds(new PositionComponent(square.position.x-1,square.position.y+1),map.length)){neighbors[2]=map[square.position.x-1][square.position.y+1]}if(Utility.positionInBounds(new PositionComponent(square.position.x-1,square.position.y+1),map.length)){neighbors[3]=map[square.position.x+1][square.position.y+1]}return neighbors}},{key:'squareTypeIsWalkable',value:function squareTypeIsWalkable(square,entity){return entity instanceof Player?Utility.playerWalkable(square):Utility.mobWalkable(square)}},{key:'playerWalkable',value:function playerWalkable(square){return!square.physical.solid||square instanceof DoorSquare||square instanceof StairUpSquare||square instanceof StairDownSquare}},{key:'mobWalkable',value:function mobWalkable(square){return!square.physical.solid}},{key:'squareIsOccupied',value:function squareIsOccupied(x,y,entity,objects){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var o=_step.value;if(entity!=o){if(Utility.collision(new CollisionComponent(x,y,1),o.collision)){return true}}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}return false}},{key:'directionToPosition',value:function directionToPosition(direction){switch(direction){case direction_up:return new PositionComponent(0,-1);case direction_right:return new PositionComponent(1,0);case direction_down:return new PositionComponent(0,1);case direction_left:return new PositionComponent(-1,0);}}},{key:'isMovementAction',value:function isMovementAction(action){return action>action_move&&action<=action_move_left}},{key:'isSprintAction',value:function isSprintAction(action){return action>action_sprint&&action<=action_sprint_left}},{key:'convertMovementToSprint',value:function convertMovementToSprint(action){switch(action){case action_move_up:return action_sprint_up;case action_move_right:return action_sprint_right;case action_move_down:return action_sprint_down;case action_move_left:return action_sprint_left;}}},{key:'convertSprintToMovement',value:function convertSprintToMovement(action){switch(action){case action_sprint_up:return action_move_up;case action_sprint_right:return action_move_right;case action_sprint_down:return action_move_down;case action_sprint_left:return action_move_left;}}},{key:'convertAnimationsFromConfig',value:function convertAnimationsFromConfig(animations){var animationsArray=[];for(var a in animations){animationsArray[animation_strings_to_constants[a]]=animations[a]}return animationsArray}},{key:'convertActionsFromConfig',value:function convertActionsFromConfig(actions){var actionsArray=[];for(var i=0;i<actions.length;i++){actionsArray[i]=action_strings_to_constants[actions[i]]}return actionsArray}},{key:'getSquareCode',value:function getSquareCode(x,y,size){return x+y*size}},{key:'getSquareFromCode',value:function getSquareFromCode(map,code){return map[code%map.length][floor(code/map.length)]}}]);return Utility}();var LARGE_VALUE=10000;function findPath(board,start,end){var searched=[];var searching=[];var cameFrom={};var distFromStart={};var finalCost={};for(var i=0;i<board.length;i++){for(var j=0;j<board[0].length;j++){distFromStart[board[i][j]]=LARGE_VALUE;finalCost[board[i][j]]=LARGE_VALUE}}searching.push(start);distFromStart[start]=0;finalCost[start]=squareDistance(start,end);cameFrom[Utility.getSquareCode(start.position.x,start.position.y)]=-1;while(searching.length>0){var current=searching[0];var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=searching[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var s=_step2.value;if(finalCost[s]<finalCost[current])current=s}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}if(current==end){return makePath(board,cameFrom,current)}searching.splice(searching.indexOf(current),1);searched.push(current);var currentNeighbors=getNeighbors(board,current);var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=currentNeighbors[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var n=_step3.value;if(searched.includes(n)){continue}else{var estimatedDistFromStart=distFromStart[current]+1;if(!searching.includes(n)){searching.push(n)}else if(estimatedDistFromStart>=distFromStart[n]){continue}cameFrom[Utility.getSquareCode(n.position.x,n.position.y)]=Utility.getSquareCode(current.position.x,current.position.y);distFromStart[n]=estimatedDistFromStart;finalCost[n]=distFromStart[n]+squareDistance(start,end)}}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}}return false}function squareDistance(start,end){return abs(start.position.x-end.position.x)+abs(start.position.y-end.position.y)}function makePath(board,cameFrom,last){var path=[];var current=Utility.getSquareCode(last.position.x,last.position.y);while(cameFrom[current]>0){path.unshift(Utility.getSquareFromCode(board,current));current=cameFrom[current]}path.unshift(Utility.getSquareFromCode(board,current));return path}function getNeighbors(board,square){neighbors=[];if(square.position.x>0&&walkable(entity_mob,board[square.position.x-1][square.position.y])){neighbors.push(board[square.position.x-1][square.position.y])}if(square.position.y>0&&walkable(entity_mob,board[square.position.x][square.position.y-1])){neighbors.push(board[square.position.x][square.position.y-1])}if(square.position.x<board.length-1&&walkable(entity_mob,board[square.position.x+1][square.position.y])){neighbors.push(board[square.position.x+1][square.position.y])}if(square.position.y<board.length-1&&walkable(entity_mob,board[square.position.x][square.position.y+1])){neighbors.push(board[square.position.x][square.position.y+1])}return neighbors}
'use strict';function setup(){createCanvas(windowWidth,windowHeight,'game');load()}function load(){var config=loadConfig();var images=loadImages(config.textures);var room_pool=loadRoomPools();var player_data=loadJSON('/data/player_data.json');var entity_data=loadJSON('/data/entity_data.json');var boss_data=loadJSON('/data/boss_data.json');var data={'config':config,'room_pool':room_pool[0],'stair_room_pool':room_pool[1],'images':images,'player_data':player_data,'entity_data':entity_data,'boss_data':boss_data};new PoppsEngine(data)}function loadConfig(){return loadJSON('/config/config.json')}function loadRoomPools(){return loadJSON('/config/roompool.json')}function loadImages(textureConfig){var images={};images.textures=loadTextures(textureConfig);images.ui=loadUI();return images}function loadTextures(textureConfig){var textures=[];textures[texture_floor]=[];textures[texture_floor][texture_default]=loadImage('/img/textures/floor/floor_default.jpg');textures[texture_floor][texture_num_alts]=textureConfig.NUM_FLOOR_ALTS;for(var i=0;i<textures[texture_floor][texture_num_alts];i++){textures[texture_floor][texture_alt1+i]=loadImage('/img/textures/floor/floor_alt_'+(1+i)+'.png')}textures[texture_wall]=[];textures[texture_wall][texture_default]=loadImage('/img/textures/wall/wall_default.png');textures[texture_wall][texture_num_alts]=textureConfig.NUM_WALL_ALTS;for(var _i=0;_i<textures[texture_wall][texture_num_alts];_i++){textures[texture_wall][texture_alt1+_i]=loadImage('/img/textures/wall/wall_alt_'+(1+_i)+'.png')}textures[texture_wall][texture_side_top]=loadImage('/img/textures/wall/side_top.png');textures[texture_wall][texture_side_right]=loadImage('/img/textures/wall/side_right.png');textures[texture_wall][texture_side_bottom]=loadImage('/img/textures/wall/side_bottom.png');textures[texture_wall][texture_side_left]=loadImage('/img/textures/wall/side_left.png');textures[texture_wall][texture_in_corner_top_right]=loadImage('/img/textures/wall/corner_in_top_right.png');textures[texture_wall][texture_in_corner_bottom_right]=loadImage('/img/textures/wall/corner_in_bottom_right.png');textures[texture_wall][texture_in_corner_bottom_left]=loadImage('/img/textures/wall/corner_in_bottom_left.png');textures[texture_wall][texture_in_corner_top_left]=loadImage('/img/textures/wall/corner_in_top_left.png');textures[texture_wall][texture_out_corner_top_right]=loadImage('/img/textures/wall/corner_out_top_right.png');textures[texture_wall][texture_out_corner_bottom_right]=loadImage('/img/textures/wall/corner_out_bottom_right.png');textures[texture_wall][texture_out_corner_bottom_left]=loadImage('/img/textures/wall/corner_out_bottom_left.png');textures[texture_wall][texture_out_corner_top_left]=loadImage('/img/textures/wall/corner_out_top_left.png');textures[texture_wall][texture_U_top]=loadImage('/img/textures/wall/U_top.png');textures[texture_wall][texture_U_right]=loadImage('/img/textures/wall/U_right.png');textures[texture_wall][texture_U_bottom]=loadImage('/img/textures/wall/U_bottom.png');textures[texture_wall][texture_U_left]=loadImage('/img/textures/wall/U_left.png');textures[texture_wall][texture_cross]=loadImage('/img/textures/wall/cross.png');textures[texture_door_closed]=[];textures[texture_door_closed][texture_default]=loadImage('/img/textures/old/doorClosedTexture.png');textures[texture_door_closed][texture_num_alts]=0;textures[texture_door_open]=[];textures[texture_door_open][texture_default]=loadImage('/img/textures/old/doorOpenedTexture.png');textures[texture_door_open][texture_num_alts]=0;textures[texture_loot_closed]=[];textures[texture_loot_closed][texture_default]=loadImage('/img/textures/old/lootClosedTexture.png');textures[texture_loot_closed][texture_num_alts]=0;textures[texture_loot_open]=[];textures[texture_loot_open][texture_default]=loadImage('/img/textures/old/lootOpenedTexture.png');textures[texture_loot_open][texture_num_alts]=0;textures[texture_stair_up]=[];textures[texture_stair_up][texture_default]=loadImage('/img/textures/stairUp.png');textures[texture_stair_up][texture_num_alts]=0;textures[texture_stair_down]=[];textures[texture_stair_down][texture_default]=loadImage('/img/textures/stairDown.png');textures[texture_stair_down][texture_num_alts]=0;return textures}function loadUI(){var ui=[];ui[ui_heart]=loadImage('/img/icons/heart.png');ui[ui_empty_heart]=loadImage('/img/icons/emptyHeart.png');return ui}function loadMusic(){var music=[];music.push(loadAudio('/audio/music/001_0100.wav'));music.push(loadAudio('/audio/music/002_0001.wav'));music.push(loadAudio('/audio/music/003_0101.wav'));music.push(loadAudio('/audio/music/004_1101.wav'));music.push(loadAudio('/audio/music/005_1121.wav'));music.push(loadAudio('/audio/music/006_2121.wav'));music.push(loadAudio('/audio/music/007_0200.wav'));music.push(loadAudio('/audio/music/008_0201.wav'));music.push(loadAudio('/audio/music/009_1201.wav'));music.push(loadAudio('/audio/music/010_1221.wav'));return music}function loadSounds(){}function keyDown(){}function keyUp(){}
"use strict";function PositionComponent(x,y){this.x=x;this.y=y}function HealthComponent(initialHealth){this.maxHealth=initialHealth;this.health=initialHealth}function StrengthComponent(initialStrength){this.strength=initialStrength}function IntelligenceComponent(initialIntelligence){this.intelligence=initialIntelligence}function DexterityComponent(initialDexterity){this.dexterity=initialDexterity}function CombatComponent(strength,magic,intelligence){this.meleeAttackPower=strength;this.meleeDefensePower=floor(strength/5);this.magicAttackPower=magic*intelligence/2;this.magicDefensePower=strength*magic/8}function DirectionComponent(direction){this.direction=direction}function PhysicalComponent(solid,size){this.solid=solid;this.size=size}function CollisionComponent(x,y,w,h){if(h===undefined){h=w}this.top=y;this.right=x+w;this.bottom=y+h;this.left=x;this.width=w;this.height=h}function MovementComponent(speed){this.speed=speed}function DisplayComponent(width,height,opaque){var offsetX=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;var offsetY=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;this.width=width;this.height=height;this.visible=false;this.discovered=false;this.discoveredCounter=0;this.opaque=opaque;this.offsetX=offsetX;this.offsetY=offsetY}function AnimationComponent(animations){this.offsetX=0;this.offsetY=0;this.stage=0;this.sprite=undefined;this.animation=animation_idle;this.animations=animations}function TextureComponent(type){this.textureType=type;this.textureElements=[]}function TextureElementComponent(){var element=arguments.length>0&&arguments[0]!==undefined?arguments[0]:texture_default;var xOff=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var yOff=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;this.element=element;this.xOff=xOff;this.yOff=yOff}function LightComponent(){this.level=0}function LightEmitterComponent(emitterLevel){this.level=emitterLevel}function ActionComponent(actions,speed){this.busy=0;this.speed=speed;this.availible=actions;this.nextAction=action_none;this.currentAction=action_none;this.lastAction=action_none;this.lastActionFailed=false}function SprintComponent(movesBeforeSprinting){this.movesBeforeSprinting=movesBeforeSprinting;this.sprintCounter=0;this.sprinting=false}function MapComponent(map){this.map=map}function DepthComponent(depth){this.depth=depth}function AIComponent(actions,attackRange){this.actions=actions;this.attackRange=attackRange;this.noticedPlayer=false;this.idleTimer=0}
"use strict";function Entity(x,y,initialDepth,initialHealth,initialStrength,initialDexterity,initialIntelligence,size,speed,actions,animations){this.components=[component_position,component_depth,component_health,component_strength,component_dexterity,component_magic,component_direction,component_physical,component_display,component_actions,component_animation,component_combat];this.position=new PositionComponent(x,y);this.depth=new DepthComponent(initialDepth);this.direction=new DirectionComponent(direction_down);this.physical=new PhysicalComponent(physical_solid,size);this.health=new HealthComponent(initialHealth);this.strength=new StrengthComponent(initialStrength);this.dexterity=new DexterityComponent(initialDexterity);this.intelligence=new IntelligenceComponent(initialIntelligence);this.combat=new CombatComponent(initialStrength,initialDexterity,initialIntelligence);this.display=new DisplayComponent(size,size,display_transparent);this.animation=new AnimationComponent(animations);this.actions=new ActionComponent(actions,speed)}
"use strict";Mob.prototype=Object.create(Entity.prototype);function Mob(x,y,depth,config,actions,animations){Entity.call(this,x,y,depth,config.health+depth,config.strength+depth,config.dexterity+depth,config.intelligence+depth,config.size,config.speed,actions,animations);if(config.solid){this.components.push(component_collision);this.collision=new CollisionComponent(x,y,config.size,config.size)}this.components.push(component_ai);this.ai=new AIComponent(actions,config.attack_range)}
"use strict";Player.prototype=Object.create(Entity.prototype);function Player(x,y,config,playerClass,actions,animations){Entity.call(this,x,y,0,playerClass.health,playerClass.strength,playerClass.dexterity,playerClass.intelligence,config.size,config.speed,actions,animations);this.components.push(component_collision);this.collision=new CollisionComponent(x,y,config.size);this.components.push(component_sprint);this.sprint=new SprintComponent(config.sprint_threshhold);this.components.push(component_light_emitter);this.lightEmitter=new LightEmitterComponent(light_level_player);this.display.discovered=true}
"use strict";function Item(){}
'use strict';function generateLevel(CONFIG,depth,ROOM_POOL,STAIR_ROOM_POOL){if(LEVEL_GEN){var startTime=millis();var level=void 0;var rooms=[];var torches=[];var stairUp={x:0,y:0,sector:0};var stairDown={x:0,y:0,sector:0};level=initLevel(CONFIG.DUNGEON_SIZE,square_wall);rooms.push(generateStairUpRoom(stairUp,CONFIG.DUNGEON_SIZE,STAIR_ROOM_POOL));stairUp.x=rooms[0].x;stairUp.y=rooms[0].y;rooms.push(generateStairDownRoom(stairUp,stairDown,CONFIG.DUNGEON_SIZE,STAIR_ROOM_POOL));stairDown.x=rooms[1].x;stairDown.y=rooms[1].y;generateOtherRooms(level,rooms,CONFIG.DUNGEON_SIZE,CONFIG.ROOM_TRIES,ROOM_POOL);placeRoomsOnLevel(level,rooms);markNodeSquares(level);connectRooms(level,rooms,CONFIG.DUNGEON_SIZE);populateRooms(level,rooms,torches);finalizeLevel(level,stairUp,stairDown);return new Level(level,stairUp,stairDown,depth,torches)}else{var _level=initLevel(CONFIG.DUNGEON_SIZE,square_floor);var _torches=[];var _stairUp={x:randomInt(CONFIG.DUNGEON_SIZE),y:randomInt(CONFIG.DUNGEON_SIZE)};var _stairDown={x:randomInt(CONFIG.DUNGEON_SIZE),y:randomInt(CONFIG.DUNGEON_SIZE)};finalizeLevel(_level,_stairUp,_stairDown);return new Level(_level,_stairUp,_stairDown,depth,_torches)}}function initLevel(size,defaultValue){var level=new Array(size);for(var i=0;i<size;i++){level[i]=new Array(size);for(var j=0;j<size;j++){level[i][j]=defaultValue}}return level}function generateStairUpRoom(stairUp,size,STAIR_ROOM_POOL){stairUp.sector=randomInt(8);sectorToCoordinates(stairUp,size);return new Room(random(STAIR_ROOM_POOL),stairUp.x,stairUp.y)}function generateStairDownRoom(stairUp,stairDown,size,STAIR_ROOM_POOL){stairDown.sector=(stairUp.sector+4)%8;sectorToCoordinates(stairDown,size);return new Room(random(STAIR_ROOM_POOL),stairDown.x,stairDown.y)}function sectorToCoordinates(stair,size){switch(stair.sector){case 0:stair.x=floor(size/4);stair.y=floor(size/4);break;case 1:stair.x=2*floor(size/4);stair.y=floor(size/4);break;case 2:stair.x=3*floor(size/4);stair.y=floor(size/4);break;case 3:stair.x=3*floor(size/4);stair.y=2*floor(size/4);break;case 4:stair.x=3*floor(size/4);stair.y=3*floor(size/4);break;case 5:stair.x=2*floor(size/4);stair.y=3*floor(size/4);break;case 6:stair.x=floor(size/4);stair.y=3*floor(size/4);break;case 7:stair.x=floor(size/4);stair.y=2*floor(size/4);break;}}function generateOtherRooms(level,rooms,size,ROOM_TRIES,ROOM_POOL){for(var i=0;i<ROOM_TRIES;i++){tryRoom(level,rooms,size,ROOM_POOL)}}function tryRoom(level,rooms,size,ROOM_POOL){var newRoom=new Room(random(ROOM_POOL),randomInt(size),randomInt(size));if(isValidRoom(rooms,newRoom,size))rooms.push(newRoom)}function isValidRoom(rooms,newRoom,size){if(newRoom.left<0||newRoom.top<0||newRoom.right>size||newRoom.bottom>size)return false;var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=rooms[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var r=_step.value;if(roomsCollide(r,newRoom))return false}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}return true}function roomsCollide(r1,r2){return!(r1.left>r2.right||r1.top>r2.bottom||r1.right<r2.left||r1.bottom<r2.top)}function placeRoomsOnLevel(level,rooms){var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=rooms[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var r=_step2.value;for(var i=0;i<r.width;i++){for(var j=0;j<r.height;j++){level[i+r.left][j+r.top]=r.squares[i][j]}}}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}}function markNodeSquares(level){for(var i=1;i<level.length-1;i+=2){for(var j=1;j<level.length-1;j+=2){if(level[i][j]==square_wall)level[i][j]=new Node(i,j,false)}}}function connectRooms(level,rooms,size){var connected=[rooms[0]];var connectedDoors=rooms[0].doors;while(connected.length<rooms.length){var closestRoom=void 0;var closestDistance=void 0;var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=rooms[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var r=_step3.value;if(!connected.includes(r)){closestRoom=r;closestDistance=10000}}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=connected[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var c=_step4.value;var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=rooms[Symbol.iterator](),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var _r=_step5.value;if(connected.includes(_r))continue;else{var currentDistance=roomDistance(c,_r);if(currentDistance<closestDistance){closestRoom=_r;closestDistance=currentDistance}}}}catch(err){_didIteratorError5=true;_iteratorError5=err}finally{try{if(!_iteratorNormalCompletion5&&_iterator5.return){_iterator5.return()}}finally{if(_didIteratorError5){throw _iteratorError5}}}}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return()}}finally{if(_didIteratorError4){throw _iteratorError4}}}connectRoom(level,connected,closestRoom,connectedDoors)}}function roomDistance(r1,r2){return abs(r1.x-r2.x)+abs(r1.y-r2.y)}function connectRoom(level,connected,room,connectedDoors){var roomDoors=room.doors;var closestDoors=[connectedDoors[0],roomDoors[0]];var closestDistance=10000;var adjacent=false;var success=false;var _iteratorNormalCompletion6=true;var _didIteratorError6=false;var _iteratorError6=undefined;try{for(var _iterator6=roomDoors[Symbol.iterator](),_step6;!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=true){var rd=_step6.value;if(includesDoor(connectedDoors,rd)){closestDoors[0]=rd;adjacent=true;success=true;break}else{var _iteratorNormalCompletion8=true;var _didIteratorError8=false;var _iteratorError8=undefined;try{for(var _iterator8=connectedDoors[Symbol.iterator](),_step8;!(_iteratorNormalCompletion8=(_step8=_iterator8.next()).done);_iteratorNormalCompletion8=true){var cd=_step8.value;var currentDistance=doorDistance(rd,cd);if(currentDistance<closestDistance){closestDoors=[cd,rd];closestDistance=currentDistance}}}catch(err){_didIteratorError8=true;_iteratorError8=err}finally{try{if(!_iteratorNormalCompletion8&&_iterator8.return){_iterator8.return()}}finally{if(_didIteratorError8){throw _iteratorError8}}}}}}catch(err){_didIteratorError6=true;_iteratorError6=err}finally{try{if(!_iteratorNormalCompletion6&&_iterator6.return){_iterator6.return()}}finally{if(_didIteratorError6){throw _iteratorError6}}}if(!adjacent){success=makePathBetweenDoors(level,closestDoors[0],closestDoors[1],connectedDoors)}if(success){if(adjacent){level[closestDoors[0][0]][closestDoors[0][1]]=square_door}else{level[closestDoors[0][0]][closestDoors[0][1]]=square_door;level[closestDoors[1][0]][closestDoors[1][1]]=square_door}var _iteratorNormalCompletion7=true;var _didIteratorError7=false;var _iteratorError7=undefined;try{for(var _iterator7=roomDoors[Symbol.iterator](),_step7;!(_iteratorNormalCompletion7=(_step7=_iterator7.next()).done);_iteratorNormalCompletion7=true){var _rd=_step7.value;if(!includesDoor(connectedDoors,_rd)){connectedDoors.push(_rd)}}}catch(err){_didIteratorError7=true;_iteratorError7=err}finally{try{if(!_iteratorNormalCompletion7&&_iterator7.return){_iterator7.return()}}finally{if(_didIteratorError7){throw _iteratorError7}}}connected.push(room)}else{connectedDoors.splice(connectedDoors.indexOf(closestDoors[0]),1);room.doors.splice(room.doors.indexOf(closestDoors[1]),1);connectRoom(level,connected,room,connectedDoors)}}function includesDoor(doorArray,door){var _iteratorNormalCompletion9=true;var _didIteratorError9=false;var _iteratorError9=undefined;try{for(var _iterator9=doorArray[Symbol.iterator](),_step9;!(_iteratorNormalCompletion9=(_step9=_iterator9.next()).done);_iteratorNormalCompletion9=true){var d=_step9.value;if(door[0]==d[0]&&door[1]==d[1])return true}}catch(err){_didIteratorError9=true;_iteratorError9=err}finally{try{if(!_iteratorNormalCompletion9&&_iterator9.return){_iterator9.return()}}finally{if(_didIteratorError9){throw _iteratorError9}}}return false}function doorDistance(d1,d2){return(d1[0]-d2[0])*(d1[0]-d2[0])+(d1[1]-d2[1])*(d1[1]-d2[1])}function makePathBetweenDoors(level,door1,door2,connectedDoors){var searched=[];var searching=[];var distFromStart={};var finalCost={};for(var i=0;i<level.length;i++){for(var j=0;j<level[0].length;j++){distFromStart[level[i][j]]=LARGE_VALUE;finalCost[level[i][j]]=LARGE_VALUE}}var start=getAdjacentNode(level,door1);var end=getAdjacentNode(level,door2);if(start==undefined||end==undefined)return false;searching.push(start);distFromStart[start]=0;finalCost[start]=nodeDistance(start,end);start.cameFrom=undefined;while(searching.length>0){var current=searching[0];var _iteratorNormalCompletion10=true;var _didIteratorError10=false;var _iteratorError10=undefined;try{for(var _iterator10=searching[Symbol.iterator](),_step10;!(_iteratorNormalCompletion10=(_step10=_iterator10.next()).done);_iteratorNormalCompletion10=true){var s=_step10.value;if(finalCost[s]<finalCost[current])current=s}}catch(err){_didIteratorError10=true;_iteratorError10=err}finally{try{if(!_iteratorNormalCompletion10&&_iterator10.return){_iterator10.return()}}finally{if(_didIteratorError10){throw _iteratorError10}}}if(current==end){drawNodePath(level,current,connectedDoors);return true}searching.splice(searching.indexOf(current),1);searched.push(current);var currentNeighbors=getSurroundingNodes(level,current);var _iteratorNormalCompletion11=true;var _didIteratorError11=false;var _iteratorError11=undefined;try{for(var _iterator11=currentNeighbors[Symbol.iterator](),_step11;!(_iteratorNormalCompletion11=(_step11=_iterator11.next()).done);_iteratorNormalCompletion11=true){var n=_step11.value;if(searched.includes(n)){continue}else{var estimatedDistFromStart=distFromStart[current]+1;if(!searching.includes(n)){searching.push(n)}else if(estimatedDistFromStart>=distFromStart[n]){continue}n.cameFrom=current;distFromStart[n]=estimatedDistFromStart;finalCost[n]=distFromStart[n]+nodeDistance(start,end)}}}catch(err){_didIteratorError11=true;_iteratorError11=err}finally{try{if(!_iteratorNormalCompletion11&&_iterator11.return){_iterator11.return()}}finally{if(_didIteratorError11){throw _iteratorError11}}}}return false}function getAdjacentNode(level,door){if(door[0]%2==1&&door[1]%2==1)return level[door[0]][door[1]];if(door[0]>1&&level[door[0]-1][door[1]]instanceof Node)return level[door[0]-1][door[1]];if(door[1]>1&&level[door[0]][door[1]-1]instanceof Node)return level[door[0]][door[1]-1];if(door[0]<level.length-2&&level[door[0]+1][door[1]]instanceof Node)return level[door[0]+1][door[1]];if(door[1]<level.length-2&&level[door[0]][door[1]+1]instanceof Node)return level[door[0]][door[1]+1]}function nodeDistance(start,end){return abs(start.x-end.x)+abs(start.y-end.y)}function getSurroundingNodes(level,node){var neighbors=[];if(node.x>1&&level[node.x-2][node.y]instanceof Node)neighbors.push(level[node.x-2][node.y]);if(node.y>1&&level[node.x][node.y-2]instanceof Node)neighbors.push(level[node.x][node.y-2]);if(node.x<level.length-2&&level[node.x+2][node.y]instanceof Node)neighbors.push(level[node.x+2][node.y]);if(node.y<level.length-2&&level[node.x][node.y+2]instanceof Node)neighbors.push(level[node.x][node.y+2]);return neighbors}function drawNodePath(level,node){level[node.x][node.y].connected=true;while(node.cameFrom!=undefined){fillBetweenNodes(level,node,node.cameFrom);node=node.cameFrom;level[node.x][node.y].connected=true}}function fillBetweenNodes(level,node1,node2){level[node1.x+(node2.x-node1.x)/2][node1.y+(node2.y-node1.y)/2]=square_floor}function populateRooms(level,rooms,torches){var _iteratorNormalCompletion12=true;var _didIteratorError12=false;var _iteratorError12=undefined;try{for(var _iterator12=rooms[Symbol.iterator](),_step12;!(_iteratorNormalCompletion12=(_step12=_iterator12.next()).done);_iteratorNormalCompletion12=true){var r=_step12.value;placeTorchInRoom(level,r,torches)}}catch(err){_didIteratorError12=true;_iteratorError12=err}finally{try{if(!_iteratorNormalCompletion12&&_iterator12.return){_iterator12.return()}}finally{if(_didIteratorError12){throw _iteratorError12}}}}function placeTorchInRoom(level,room,torches){if(room.width>5&&room.height>5&&!oneIn(5)){var dir=randomInt(4);var x=0,y=0;switch(dir){case direction_up:x=room.left+randomInt(2,room.width-2);y=room.top;dir=direction_down;if(level[x][y]==square_door){return}break;case direction_right:x=room.right-1;y=room.top+randomInt(2,room.height-2);dir=direction_left;if(level[x][y]==square_door){return}break;case direction_down:x=room.left+randomInt(2,room.width-2);y=room.bottom-1;dir=direction_up;if(level[x][y]==square_door){return}break;case direction_left:x=room.left;y=room.top+randomInt(2,room.height-2);dir=direction_right;if(level[x][y]==square_door){return}break;}torches.push(new Torch(x,y,dir))}}function finalizeLevel(level,stairUp,stairDown){level[stairUp.x][stairUp.y]=square_stair_up;level[stairDown.x][stairDown.y]=square_stair_down;for(var i=0;i<level.length;i++){for(var j=0;j<level.length;j++){if(level[i][j]instanceof Node){if(level[i][j].connected){level[i][j]=square_floor}else{level[i][j]=square_wall}}switch(level[i][j]){case square_floor:level[i][j]=new FloorSquare(i,j);break;case square_wall:level[i][j]=new WallSquare(i,j);break;case square_door:level[i][j]=new DoorSquare(i,j);break;case square_stair_up:level[i][j]=new StairUpSquare(i,j);break;case square_stair_down:level[i][j]=new StairDownSquare(i,j);break;case square_loot:level[i][j]=new FloorSquare(i,j);break;default:console.log('Not recognized squaretype: '+level[i][j]);level[i][j]=new Square(i,j,level[i][j]);break;}}}var blanks=[];for(var _i=1;_i<level.length-1;_i++){for(var _j=1;_j<level.length-1;_j++){if(level[_i][_j]instanceof WallSquare&&!(level[_i-1][_j-1]instanceof FloorSquare||level[_i][_j-1]instanceof FloorSquare||level[_i+1][_j-1]instanceof FloorSquare||level[_i-1][_j]instanceof FloorSquare||level[_i+1][_j]instanceof FloorSquare||level[_i-1][_j+1]instanceof FloorSquare||level[_i][_j+1]instanceof FloorSquare||level[_i+1][_j+1]instanceof FloorSquare)){blanks.push(level[_i][_j])}}}for(var _i2=1;_i2<level.length-1;_i2++){if(!(level[_i2-1][1]instanceof FloorSquare||level[_i2][1]instanceof FloorSquare||level[_i2+1][1]instanceof FloorSquare)){blanks.push(level[_i2][0])}if(!(level[1][_i2-1]instanceof FloorSquare||level[1][_i2]instanceof FloorSquare||level[1][_i2+1]instanceof FloorSquare)){blanks.push(level[0][_i2])}if(!(level[_i2-1][level.length-2]instanceof FloorSquare||level[_i2][level.length-2]instanceof FloorSquare||level[_i2+1][level.length-2]instanceof FloorSquare)){blanks.push(level[_i2][level.length-1])}if(!(level[level.length-2][_i2-1]instanceof FloorSquare||level[level.length-2][_i2]instanceof FloorSquare||level[level.length-2][_i2+1]instanceof FloorSquare)){blanks.push(level[level.length-1][_i2])}}var _iteratorNormalCompletion13=true;var _didIteratorError13=false;var _iteratorError13=undefined;try{for(var _iterator13=blanks[Symbol.iterator](),_step13;!(_iteratorNormalCompletion13=(_step13=_iterator13.next()).done);_iteratorNormalCompletion13=true){var b=_step13.value;level[b.position.x][b.position.y]=new BlankSquare(b.position.x,b.position.y)}}catch(err){_didIteratorError13=true;_iteratorError13=err}finally{try{if(!_iteratorNormalCompletion13&&_iterator13.return){_iterator13.return()}}finally{if(_didIteratorError13){throw _iteratorError13}}}}function Node(x,y,connected){this.x=x;this.y=y;this.connected=connected}
"use strict";function Room(template,x,y){this.width=template.width;this.height=template.height;this.left=x-floor(this.width/2);this.top=y-floor(this.height/2);this.left+=this.left%2-1;this.top+=this.top%2-1;this.right=this.left+this.width;this.bottom=this.top+this.height;this.x=this.left+floor(this.width/2);this.y=this.top+floor(this.height/2);this.squares=template.squares.slice(0);this.doors=new Array(template.doors.length);for(var i=0;i<this.doors.length;i++){this.doors[i]=[template.doors[i][0]+this.left,template.doors[i][1]+this.top]}}
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var AISystem=function(_System){_inherits(AISystem,_System);function AISystem(config){_classCallCheck(this,AISystem);var _this=_possibleConstructorReturn(this,(AISystem.__proto__||Object.getPrototypeOf(AISystem)).call(this,[component_ai]));_this.config=config;return _this}_createClass(AISystem,[{key:"run",value:function run(engine){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var entity=_step.value;if(Utility.distance(entity.position,engine.getPlayer().position)<entity_active_range){if(entity.ai.noticedPlayer){this.handleActiveEntity(engine,entity,engine.getPlayer())}else{this.handleIdleEntity(engine,entity,engine.getPlayer())}}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_entity_attacked:if(data.attacker instanceof Player){var target=data.target;var self=this;target.ai.idleTimer=100;setTimeout(function(){target.ai.noticedPlayer=true},this.config.MOB_REACTION_TIME)}break;case event_successful_action:var entity=data.entity;if(entity instanceof Mob&&!entity.ai.noticedPlayer&&entity.display.visible){var _self=this;setTimeout(function(){entity.ai.noticedPlayer=_self.checkNoticePlayer(engine,entity,engine.getPlayer())},this.config.MOB_REACTION_TIME)}break;}}},{key:"addObject",value:function addObject(object){_get(AISystem.prototype.__proto__||Object.getPrototypeOf(AISystem.prototype),"addObject",this).call(this,object)}},{key:"handleActiveEntity",value:function handleActiveEntity(engine,entity,player){if(entity.actions.busy==0){entity.actions.nextAction=this.determineAction(engine,entity,player)}}},{key:"determineAction",value:function determineAction(engine,entity,player){if(Utility.entityDistance(entity,player)<=entity.ai.attackRange){return this.getAttackAction(entity,player)}else{return this.getMoveCloserAction(engine,entity,player)}}},{key:"getAttackAction",value:function getAttackAction(entity,player){var dir=Utility.getDirectionToEntity(entity,player);entity.direction.direction=dir;return direction_to_attack[dir]}},{key:"getMoveCloserAction",value:function getMoveCloserAction(engine,entity,player){return direction_to_movement[Utility.getDirectionToEntity(entity,player)]}},{key:"handleIdleEntity",value:function handleIdleEntity(engine,entity,player){if(entity.ai.idleTimer==0){entity.actions.nextAction=this.determineIdleAction(engine,entity);entity.ai.idleTimer=randomInt(this.config.MIN_IDLE_TIME,this.config.MAX_IDLE_TIME)}else{entity.ai.idleTimer--}}},{key:"checkNoticePlayer",value:function checkNoticePlayer(engine,entity,player){switch(entity.direction.direction){case direction_up:if(entity.collision.top+1>=player.collision.bottom){return VisionSystem.lineOfSight(engine,entity.position,player.position)}break;case direction_right:if(entity.collision.right-1<=player.collision.left){return VisionSystem.lineOfSight(engine,entity.position,player.position)}break;case direction_down:if(entity.collision.bottom-1<=player.collision.top){return VisionSystem.lineOfSight(engine,entity.position,player.position)}break;case direction_left:if(entity.collision.left+1>=player.collision.right){return VisionSystem.lineOfSight(engine,entity.position,player.position)}break;default:console.log("Cannot determine entity direction: "+entity.direction.direction);return false;}return false}},{key:"determineIdleAction",value:function determineIdleAction(engine,entity){var randomMoveAction=action_move+randomInt(1,5);if(MovementSystem.validMove(engine,entity,MovementSystem.getDestination(entity,randomMoveAction))){return randomMoveAction}else{if(randomMoveAction==action_move_up){return action_move_down}else if(randomMoveAction==action_move_right){return action_move_left}else if(randomMoveAction==action_move_down){return action_move_up}else if(randomMoveAction==action_move_left){return action_move_right}return action_none}}}]);return AISystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var ActionSystem=function(_System){_inherits(ActionSystem,_System);function ActionSystem(){_classCallCheck(this,ActionSystem);return _possibleConstructorReturn(this,(ActionSystem.__proto__||Object.getPrototypeOf(ActionSystem)).call(this,[component_actions]))}_createClass(ActionSystem,[{key:"init",value:function init(engine){this.hitstunTimer=0}},{key:"run",value:function run(engine){if(this.hitstunTimer==0){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var entity=_step.value;if(entity.actions.busy>0){entity.actions.busy-=entity.actions.speed}else{this.setCurrentAction(entity,engine)}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}}else{this.hitstunTimer--}}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_successful_action:this.handleSuccessfulAction(engine,data.entity,data.action);break;case event_failed_action:this.handleFailedAction(engine,data.entity);break;case event_hitstun:this.hitstunTimer=data.ticks;break;}}},{key:"setCurrentAction",value:function setCurrentAction(entity,engine){entity.actions.currentAction=entity.actions.nextAction;entity.actions.nextAction=action_none}},{key:"handleSuccessfulAction",value:function handleSuccessfulAction(engine,entity,action){entity.actions.busy=action_to_length[action];if(entity.components.includes(component_sprint)&&Utility.isMovementAction(action)){this.handleSprinting(entity,engine)}entity.animation.animation=action_to_animation[action];engine.sendEvent(event_new_animation,entity);entity.actions.lastActionFailed=false;entity.actions.lastAction=action;entity.actions.currentAction=action_none}},{key:"handleFailedAction",value:function handleFailedAction(engine,entity){entity.actions.busy=3;entity.actions.lastActionFailed=true;entity.actions.lastAction=entity.actions.currentAction;entity.actions.currentAction=action_none}},{key:"handleSprinting",value:function handleSprinting(entity,engine){if(entity.sprint.sprinting){entity.actions.busy=action_to_length[action_sprint]}}}]);return ActionSystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var AnimationSystem=function(_System){_inherits(AnimationSystem,_System);function AnimationSystem(config){_classCallCheck(this,AnimationSystem);var _this=_possibleConstructorReturn(this,(AnimationSystem.__proto__||Object.getPrototypeOf(AnimationSystem)).call(this,[component_animation]));_this.config=config;return _this}_createClass(AnimationSystem,[{key:"init",value:function init(engine){this.animationCounter=0;this.idleAnimationCounter=0}},{key:"run",value:function run(engine){if(this.animationCounter==this.config.ANIMATION_SPEED){this.animationCounter=0;if(this.idleAnimationCounter==this.config.IDLE_ANIMATION_SLOW_FACTOR){this.idleAnimationCounter=0}var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var o=_step.value;o.animation.stage++;if(o.animation.stage==o.animation.animations[o.animation.animation].length){this.startIdleAnimation(o)}this.updateAnimation(o)}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}this.idleAnimationCounter++}this.animationCounter++}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_new_animation:this.startAnimation(data);break;}}},{key:"startIdleAnimation",value:function startIdleAnimation(entity){entity.animation.animation=animation_idle;entity.animation.stage=0;this.updateAnimation(entity)}},{key:"updateAnimation",value:function updateAnimation(entity){entity.animation.offsetX=entity.animation.animations[entity.animation.animation][entity.animation.stage].ox;entity.animation.offsetY=entity.animation.animations[entity.animation.animation][entity.animation.stage].oy;entity.animation.sprite=entity.animation.animations[entity.animation.animation][entity.animation.stage].sprite}},{key:"startAnimation",value:function startAnimation(object){object.animation.stage=0;this.updateAnimation(object)}}]);return AnimationSystem}(System);
"use strict";function AudioManager(){var mm=new MusicManager;var sounds=[]}
'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if('value'in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var CombatSystem=function(_System){_inherits(CombatSystem,_System);function CombatSystem(){_classCallCheck(this,CombatSystem);return _possibleConstructorReturn(this,(CombatSystem.__proto__||Object.getPrototypeOf(CombatSystem)).call(this,[component_combat]))}_createClass(CombatSystem,[{key:'init',value:function init(engine){this.inCombat=false;this.combatTimer=0;this.combatTimerMax=30}},{key:'run',value:function run(engine){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var entity=_step.value;switch(entity.actions.currentAction){case action_melee_attack:this.fixAttackDirection(entity,this.objects);this.meleeAttack(engine,entity,this.objects);break;case action_melee_attack_up:case action_melee_attack_right:case action_melee_attack_down:case action_melee_attack_left:this.meleeAttack(engine,entity,this.objects);break;case action_spin_attack:this.spinAttack(engine,entity,this.objects);break;}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}if(this.inCombat){if(!this.checkInCombat(engine.getPlayer(),this.objects)){this.combatTimer--;if(this.combatTimer==0){this.endCombat(engine)}}else{this.resetCombatTimer()}}else{if(this.checkInCombat(engine.getPlayer(),this.objects)){this.beginCombat(engine)}}}},{key:'handleEvent',value:function handleEvent(engine,eventID,data){}},{key:'addObject',value:function addObject(object){_get(CombatSystem.prototype.__proto__||Object.getPrototypeOf(CombatSystem.prototype),'addObject',this).call(this,object)}},{key:'resetCombatTimer',value:function resetCombatTimer(){this.combatTimer=this.combatTimerMax}},{key:'beginCombat',value:function beginCombat(engine){if(!this.inCombat){engine.sendEvent(event_begin_combat);this.resetCombatTimer();this.inCombat=true}}},{key:'endCombat',value:function endCombat(engine){if(this.inCombat){engine.sendEvent(event_end_combat);this.inCombat=false}}},{key:'checkInCombat',value:function checkInCombat(player,objects){var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=objects[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var o=_step2.value;if(o instanceof Mob&&o.ai.noticedPlayer&&o.display.visible){return true}}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}return false}},{key:'fixAttackDirection',value:function fixAttackDirection(entity,objects){var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=objects[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var o=_step3.value;var dir=Utility.entityAdjacent(entity,o);if(dir!==-1){return dir}}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}return-1}},{key:'meleeAttack',value:function meleeAttack(engine,entity,objects){var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=objects[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var o=_step4.value;if(entity!=o){if(Utility.collision(Utility.getCollisionInFrontOf(entity),o.collision)){var healthLost=max(0,entity.combat.meleeAttackPower*1.5-o.combat.meleeDefensePower);if(entity instanceof Player){engine.sendEvent(event_player_melee_attack)}engine.sendEvent(event_entity_attacked,{'attacker':entity,'target':o,'healthLost':healthLost});engine.sendEvent(event_successful_action,{'action':entity.actions.currentAction,'entity':entity});this.beginCombat(engine);return}}}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return()}}finally{if(_didIteratorError4){throw _iteratorError4}}}engine.sendEvent(event_failed_action,{'action':entity.actions.currentAction,'entity':entity})}},{key:'spinAttack',value:function spinAttack(engine,entity,objects){var targets=[];var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=objects[Symbol.iterator](),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var o=_step5.value;if(entity!=o&&this.entityAround(entity,o)){targets.push(o)}}}catch(err){_didIteratorError5=true;_iteratorError5=err}finally{try{if(!_iteratorNormalCompletion5&&_iterator5.return){_iterator5.return()}}finally{if(_didIteratorError5){throw _iteratorError5}}}if(targets.length>0){if(entity instanceof Player){engine.sendEvent(event_player_spin_attack)}var _iteratorNormalCompletion6=true;var _didIteratorError6=false;var _iteratorError6=undefined;try{for(var _iterator6=targets[Symbol.iterator](),_step6;!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=true){var _o=_step6.value;var healthLost=max(0,entity.combat.meleeAttackPower-_o.combat.meleeDefensePower);engine.sendEvent(event_entity_attacked,{'attacker':entity,'target':_o,'healthLost':healthLost})}}catch(err){_didIteratorError6=true;_iteratorError6=err}finally{try{if(!_iteratorNormalCompletion6&&_iterator6.return){_iterator6.return()}}finally{if(_didIteratorError6){throw _iteratorError6}}}engine.sendEvent(event_successful_action,{'action':entity.actions.currentAction,'entity':entity});this.beginCombat(engine)}}},{key:'entityAround',value:function entityAround(entity,otherEntity){return Utility.collision(new CollisionComponent(entity.position.x-1,entity.position.y-1,3),otherEntity.collision)}}],[{key:'validMeleeAttack',value:function validMeleeAttack(engine,entity){var _iteratorNormalCompletion7=true;var _didIteratorError7=false;var _iteratorError7=undefined;try{for(var _iterator7=engine.getEntities()[Symbol.iterator](),_step7;!(_iteratorNormalCompletion7=(_step7=_iterator7.next()).done);_iteratorNormalCompletion7=true){var o=_step7.value;if(entity!=o){if(Utility.entityAdjacent(entity,o)!=-1){return true}}}}catch(err){_didIteratorError7=true;_iteratorError7=err}finally{try{if(!_iteratorNormalCompletion7&&_iterator7.return){_iterator7.return()}}finally{if(_didIteratorError7){throw _iteratorError7}}}return false}}]);return CombatSystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var DisplaySystem=function(_System){_inherits(DisplaySystem,_System);function DisplaySystem(config,images){_classCallCheck(this,DisplaySystem);var _this=_possibleConstructorReturn(this,(DisplaySystem.__proto__||Object.getPrototypeOf(DisplaySystem)).call(this,[component_position,component_display]));_this.config=config;_this.textures=images;return _this}_createClass(DisplaySystem,[{key:"init",value:function init(engine){this.camera={display:true,x:0,y:0,shakeOffsetX:0,shakeOffsetY:0,combat:false,sprinting:false,zoom:this.config.CAMERA_DEFAULT_ZOOM};this.squares=[];this.entities=[];this.cameraZoomTimer=undefined;this.cameraShakeTimer=undefined;this.cameraMoving=false;this.lightOffset=0;this.lightOffsetScale=.02;this.lightOffsetSpeed=600;this.centerX=floor(width/2);this.centerY=floor(height/2);this.gridSize=this.config.GRID_SIZE;this.halfGridSize=this.gridSize/2}},{key:"run",value:function run(engine){background(0);if(this.camera.display){if(this.cameraMoving){var player=engine.getPlayer();if(player.animation.animation==animation_idle){this.cameraMoving=false}this.centerCamera(this.camera,player.position,player.animation.offsetX,player.animation.offsetY)}canvas.translate(this.centerX+this.camera.shakeOffsetX,this.centerY+this.camera.shakeOffsetY);canvas.scale(this.camera.zoom,this.camera.zoom);this.drawSquares(this.squares);this.drawEntities(this.entities);this.drawLights(this.objects);this.drawMobHealth(this.objects);canvas.setTransform()}}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_begin_level:this.determineSquareTextures(engine.getMap());this.cameraMoving=true;this.camera.display=true;break;case event_player_moved:this.cameraMoving=true;this.camera.display=true;break;case event_up_level:case event_down_level:this.camera.display=false;break;case event_window_resized:this.resize();break;case event_begin_combat:this.camera.combat=true;this.decideCameraZoomState(this.camera);break;case event_end_combat:this.camera.combat=false;this.decideCameraZoomState(this.camera);break;case event_player_start_sprinting:this.camera.sprinting=true;this.decideCameraZoomState(this.camera);break;case event_player_stop_sprinting:this.camera.sprinting=false;this.decideCameraZoomState(this.camera);break;case event_player_melee_attack:this.shakeCamera(this.camera,this.config.CAMERA_SHAKE_MEDIUM_SMALL);engine.sendEvent(event_hitstun,{"ticks":4});break;case event_player_spin_attack:this.shakeCamera(this.camera,this.config.CAMERA_SHAKE_SMALL);engine.sendEvent(event_hitstun,{"ticks":2});break;case event_player_take_damage:this.shakeCamera(this.camera,this.config.CAMERA_SHAKE_MEDIUM);engine.sendEvent(event_hitstun,{"ticks":6});break;}}},{key:"addObject",value:function addObject(object){if(object instanceof Square){if(!this.squares.includes(object)){this.squares.push(object)}}else if(this.componentRequirements.length>0){if(!this.entities.includes(object)&&Utility.checkComponents(object,this.componentRequirements)){this.entities.push(object)}}_get(DisplaySystem.prototype.__proto__||Object.getPrototypeOf(DisplaySystem.prototype),"addObject",this).call(this,object)}},{key:"removeObject",value:function removeObject(object){if(this.squares.indexOf(object)!==-1){this.squares.splice(this.squares.indexOf(object),1)}else if(this.entities.indexOf(object)!==-1){this.entities.splice(this.entities.indexOf(object),1)}_get(DisplaySystem.prototype.__proto__||Object.getPrototypeOf(DisplaySystem.prototype),"removeObject",this).call(this,object)}},{key:"clearObjects",value:function clearObjects(object){this.squares=[];this.entities=[];_get(DisplaySystem.prototype.__proto__||Object.getPrototypeOf(DisplaySystem.prototype),"clearObjects",this).call(this)}},{key:"determineSquareTextures",value:function determineSquareTextures(map){for(var i=0;i<map.length;i++){for(var j=0;j<map.length;j++){var square=map[i][j];var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=square.textures[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var texture=_step.value;switch(texture.textureType){case texture_wall:case texture_floor:DisplaySystem.determineTextureType(square,texture,map);break;default:texture.textureElements.push(new TextureElementComponent(texture_default,0,0));break;}if(texture.textureElements.length==1&&texture.textureElements[0].element==texture_default){this.setTextureAlt(texture)}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}}}}},{key:"setTextureAlt",value:function setTextureAlt(texture){if(this.textures[texture.textureType][texture_num_alts]>0){var rand=random(texture_probability_distribution[this.textures[texture.textureType][texture_num_alts]+1]);for(var i=0;i<this.textures[texture.textureType][texture_num_alts]+1;i++){if(rand<texture_probability_distribution[i]){texture.textureElements[0].element=texture_default+i;return}}}}},{key:"drawSquares",value:function drawSquares(squares){var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=squares[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var s=_step2.value;if(s.display.discovered){var bounds=this.getDrawBounds(s);if(this.onScreen(bounds,this.camera.zoom)){this.drawTexture(s,bounds)}}}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}}},{key:"drawEntities",value:function drawEntities(entities){var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=entities[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var e=_step3.value;if(e.display.visible){var bounds=this.getDrawBounds(e);if(this.onScreen(bounds,this.camera.zoom)){if(e.components.indexOf(component_animation)!==-1){this.drawAnimation(e,bounds)}else if(e.components.indexOf(component_texture)!==-1){this.drawAnimation(e,bounds)}else{var x=bounds.x,y=bounds.y,w=bounds.w,h=bounds.h;if(e instanceof Torch){fill(255,230,140,.7);ellipse(x,y,w,h)}else{fill(255,100,100);rect(x,y,w,h)}}}}}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}}},{key:"drawAnimation",value:function drawAnimation(object,bounds){var x=bounds.x,y=bounds.y,w=bounds.w,h=bounds.h;x+=this.gridSize*object.animation.offsetX;y+=this.gridSize*object.animation.offsetY;var s=object.animation.sprite;if(s==undefined){fill(20);rect(x+this.gridSize/8-2,y+this.gridSize/8-2,w-this.gridSize/4+4,h-this.gridSize/4+4);if(object instanceof Player){fill(0,200,230)}else{fill(200,20,40)}rect(x+this.gridSize/8,y+this.gridSize/8,w-this.gridSize/4,h-this.gridSize/4)}else{image(a,x,y,w,h)}}},{key:"drawTexture",value:function drawTexture(object,bounds){var x=bounds.x,y=bounds.y,w=bounds.w,h=bounds.h;var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=object.textures[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var texture=_step4.value;var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=texture.textureElements[Symbol.iterator](),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var textureElement=_step5.value;image(this.textures[texture.textureType][textureElement.element],x+this.gridSize*textureElement.xOff,y+this.gridSize*textureElement.yOff,w,h)}}catch(err){_didIteratorError5=true;_iteratorError5=err}finally{try{if(!_iteratorNormalCompletion5&&_iterator5.return){_iterator5.return()}}finally{if(_didIteratorError5){throw _iteratorError5}}}}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return()}}finally{if(_didIteratorError4){throw _iteratorError4}}}}},{key:"drawLights",value:function drawLights(objects){var _iteratorNormalCompletion6=true;var _didIteratorError6=false;var _iteratorError6=undefined;try{for(var _iterator6=objects[Symbol.iterator](),_step6;!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=true){var o=_step6.value;if(o.display.discovered&&o.components.includes(component_light)){this.lightSquare(o)}}}catch(err){_didIteratorError6=true;_iteratorError6=err}finally{try{if(!_iteratorNormalCompletion6&&_iterator6.return){_iterator6.return()}}finally{if(_didIteratorError6){throw _iteratorError6}}}}},{key:"lightSquare",value:function lightSquare(o){var bounds=this.getDrawBounds(o);if(o.display.visible){if(o instanceof WallSquare||o instanceof DoorSquare){canvas.fillStyle=light_level_to_light[2];rect(bounds.x,bounds.y,bounds.w,bounds.h);canvas.fillStyle=light_level_to_shadow[2];rect(bounds.x,bounds.y,bounds.w,bounds.h)}else{canvas.fillStyle=light_level_to_light[o.light.level];rect(bounds.x,bounds.y,bounds.w,bounds.h);canvas.fillStyle=light_level_to_shadow[o.light.level];rect(bounds.x,bounds.y,bounds.w,bounds.h)}}else{canvas.fillStyle=light_level_to_light[0];rect(bounds.x,bounds.y,bounds.w,bounds.h);canvas.fillStyle=light_level_to_shadow[0];rect(bounds.x,bounds.y,bounds.w,bounds.h);fill(0,0,0,.25);rect(bounds.x,bounds.y,bounds.w,bounds.h)}}},{key:"drawMobHealth",value:function drawMobHealth(objects){var HEALTH_BAR_OFFSET=3;var HEALTH_BAR_HEIGHT=4;var _iteratorNormalCompletion7=true;var _didIteratorError7=false;var _iteratorError7=undefined;try{for(var _iterator7=objects[Symbol.iterator](),_step7;!(_iteratorNormalCompletion7=(_step7=_iterator7.next()).done);_iteratorNormalCompletion7=true){var mob=_step7.value;if(mob instanceof Mob&&mob.components.includes(component_health)&&mob.display.visible){var bounds=this.getDrawBounds(mob);var x=bounds.x;var y=bounds.y;var xoff=this.gridSize*mob.animation.offsetX;var yoff=this.gridSize*mob.animation.offsetY;var healthBarWidth=mob.display.width*this.gridSize-this.gridSize/4;fill(40,0,0);rect(xoff+x+this.gridSize/8,yoff+y-HEALTH_BAR_OFFSET,healthBarWidth,HEALTH_BAR_HEIGHT);healthBarWidth=healthBarWidth*HealthSystem.getHealthPercent(mob);fill(50,220,120);rect(xoff+x+this.gridSize/8,yoff+y-HEALTH_BAR_OFFSET,healthBarWidth,HEALTH_BAR_HEIGHT)}}}catch(err){_didIteratorError7=true;_iteratorError7=err}finally{try{if(!_iteratorNormalCompletion7&&_iterator7.return){_iterator7.return()}}finally{if(_didIteratorError7){throw _iteratorError7}}}}},{key:"getDrawBounds",value:function getDrawBounds(object){return{"x":this.gridSize*(object.position.x+object.display.offsetX-this.camera.x),"y":this.gridSize*(object.position.y+object.display.offsetY-this.camera.y),"w":object.display.width*this.gridSize,"h":object.display.height*this.gridSize}}},{key:"onScreen",value:function onScreen(bounds,scale){var border=max(bounds.w,bounds.h)+10;var t=-(height/scale/2)-border;var r=width/scale/2+border;var b=height/scale/2+border;var l=-(width/scale/2)-border;return bounds.y>t&&bounds.x+bounds.w<r&&bounds.y+bounds.h<b&&bounds.x>l}},{key:"centerCamera",value:function centerCamera(camera,position){var offsetX=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var offsetY=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;camera.x=position.x+offsetX;camera.y=position.y+offsetY}},{key:"decideCameraZoomState",value:function decideCameraZoomState(camera){if(camera.combat){if(camera.sprinting){this.changeZoom(camera,this.config.CAMERA_ZOOM_STEPS_SLOW,this.config.CAMERA_COMBAT_ZOOM)}else{this.changeZoom(camera,this.config.CAMERA_ZOOM_STEPS_MEDIUM,this.config.CAMERA_COMBAT_ZOOM)}}else if(camera.sprinting){this.changeZoom(camera,this.config.CAMERA_ZOOM_STEPS_MEDIUM,this.config.CAMERA_SPRINT_ZOOM)}else{this.changeZoom(camera,this.config.CAMERA_ZOOM_STEPS_MEDIUM,this.config.CAMERA_DEFAULT_ZOOM)}}},{key:"changeZoom",value:function changeZoom(camera,steps,zoom){if(camera.zoom!=zoom){clearTimeout(this.cameraZoomTimer);this.recursiveZoom(camera,this.config.CAMERA_ZOOM_SPEED,zoom,(zoom-camera.zoom)/steps)}}},{key:"recursiveZoom",value:function recursiveZoom(camera,speed,zoom,dif){var self=this;if(dif<=0&&zoom-camera.zoom>=0){camera.zoom=zoom;return}else if(dif>0&&zoom-camera.zoom<=0){camera.zoom=zoom;return}else{camera.zoom+=dif;this.cameraZoomTimer=setTimeout(function(){self.recursiveZoom(camera,speed,zoom,dif)},speed)}}},{key:"shakeCamera",value:function shakeCamera(camera,shakeAmount){var self=this;clearTimeout(this.cameraShakeTimer);if(shakeAmount>0){camera.shakeOffestX=(shakeAmount%2==0?-1:1)*(randomInt(0,shakeAmount*this.config.CAMERA_SHAKE_MULTIPLIER)+this.config.CAMERA_SHAKE_CONSTANT);camera.shakeOffsetY=random(-1,1)*this.config.CAMERA_SHAKE_CONSTANT/2*shakeAmount;this.cameraShakeTimer=setTimeout(function(){self.shakeCamera(camera,shakeAmount-1)},this.config.CAMERA_SHAKE_SPEED)}else{camera.shakeOffsetX=0;camera.shakeOffsetY=0;this.cameraShakeTimer=undefined}}},{key:"resize",value:function resize(){var w=document.documentElement.clientWidth;var h=document.documentElement.clientHeight;resizeCanvas(w,h);width=w;height=h;this.centerX=floor(w/2);this.centerY=floor(h/2)}}],[{key:"texturesConnect",value:function texturesConnect(t1,t2){if(t2===undefined){return false}if(t1 instanceof WallSquare){return t2 instanceof WallSquare}else if(t1 instanceof FloorSquare){return!(t2 instanceof WallSquare)}}},{key:"determineTextureType",value:function determineTextureType(square,texture,map){var TOP=false,RIGHT=false,BOTTOM=false,LEFT=false;var numNeighbors=0;if(square.position.y>0){TOP=DisplaySystem.texturesConnect(square,map[square.position.x][square.position.y-1]);if(TOP){numNeighbors++}}if(square.position.x<map.length-1){RIGHT=DisplaySystem.texturesConnect(square,map[square.position.x+1][square.position.y]);if(RIGHT){numNeighbors++}}if(square.position.y<map.length-1){BOTTOM=DisplaySystem.texturesConnect(square,map[square.position.x][square.position.y+1]);if(BOTTOM){numNeighbors++}}if(square.position.x>0){LEFT=DisplaySystem.texturesConnect(square,map[square.position.x-1][square.position.y]);if(LEFT){numNeighbors++}}switch(numNeighbors){case 0:texture.textureElements.push(new TextureElementComponent(texture_cross,0,0));break;case 1:if(TOP){texture.textureElements.push(new TextureElementComponent(texture_U_top,0,0))}else if(RIGHT){texture.textureElements.push(new TextureElementComponent(texture_U_right,0,0))}else if(BOTTOM){texture.textureElements.push(new TextureElementComponent(texture_U_bottom,0,0))}else if(LEFT){texture.textureElements.push(new TextureElementComponent(texture_U_left,0,0))}break;case 2:if(LEFT&&RIGHT){texture.textureElements.push(new TextureElementComponent(texture_side_top,0,0));texture.textureElements.push(new TextureElementComponent(texture_side_bottom,0,0))}else if(TOP&&BOTTOM){texture.textureElements.push(new TextureElementComponent(texture_side_right,0,0));texture.textureElements.push(new TextureElementComponent(texture_side_left,0,0))}else if(TOP&&RIGHT){texture.textureElements.push(new TextureElementComponent(texture_in_corner_bottom_left,0,0));texture.textureElements.push(new TextureElementComponent(texture_out_corner_top_right,0,0))}else if(BOTTOM&&RIGHT){texture.textureElements.push(new TextureElementComponent(texture_in_corner_top_left,0,0));texture.textureElements.push(new TextureElementComponent(texture_out_corner_bottom_right,0,0))}else if(BOTTOM&&LEFT){texture.textureElements.push(new TextureElementComponent(texture_in_corner_top_right,0,0));texture.textureElements.push(new TextureElementComponent(texture_out_corner_bottom_left,0,0))}else if(LEFT&&TOP){texture.textureElements.push(new TextureElementComponent(texture_in_corner_bottom_right,0,0));texture.textureElements.push(new TextureElementComponent(texture_out_corner_top_left,0,0))}break;case 3:if(!TOP){texture.textureElements.push(new TextureElementComponent(texture_out_corner_bottom_right,0,0));texture.textureElements.push(new TextureElementComponent(texture_out_corner_bottom_left,0,0));texture.textureElements.push(new TextureElementComponent(texture_side_top,0,0))}else if(!RIGHT){texture.textureElements.push(new TextureElementComponent(texture_out_corner_top_left,0,0));texture.textureElements.push(new TextureElementComponent(texture_out_corner_bottom_left,0,0));texture.textureElements.push(new TextureElementComponent(texture_side_right,0,0))}else if(!BOTTOM){texture.textureElements.push(new TextureElementComponent(texture_out_corner_top_right,0,0));texture.textureElements.push(new TextureElementComponent(texture_out_corner_top_left,0,0));texture.textureElements.push(new TextureElementComponent(texture_side_bottom,0,0))}else if(!LEFT){texture.textureElements.push(new TextureElementComponent(texture_out_corner_bottom_right,0,0));texture.textureElements.push(new TextureElementComponent(texture_out_corner_top_right,0,0));texture.textureElements.push(new TextureElementComponent(texture_side_left,0,0))}break;case 4:texture.textureElements.push(new TextureElementComponent(texture_default,0,0));break;default:texture.textureElements.push(new TextureElementComponent(texture_default,0,0));break;}}}]);return DisplaySystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var EntitySystem=function(_System){_inherits(EntitySystem,_System);function EntitySystem(config,player_data,entity_data,boss_data){_classCallCheck(this,EntitySystem);var _this=_possibleConstructorReturn(this,(EntitySystem.__proto__||Object.getPrototypeOf(EntitySystem)).call(this,[component_actions]));_this.config=config;_this.playerData=player_data;_this.entityData=entity_data;_this.bossData=boss_data;return _this}_createClass(EntitySystem,[{key:"init",value:function init(engine){this.entities=[];this.player=this.generatePlayer()}},{key:"run",value:function run(engine){}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_new_game:engine.addObject(this.player);engine.sendEvent(event_player_generated);break;case event_level_loaded:if(this.player.depth.depth<=engine.getDepth()){this.fixPlayerPosition(this.player,engine.getLevel().stairUp,engine.getDepth())}else if(this.player.depth.depth>engine.getDepth()){this.fixPlayerPosition(this.player,engine.getLevel().stairDown,engine.getDepth())}if(this.entities.length==engine.getDepth()){this.generateEnemies(engine,this.entities,engine.getMap(),this.entityData,this.entities.length,this.player)}this.updateEntities(engine);break;case event_spawn_enemy_close:this.generateEnemy(engine,this.player.position.x-randomInt(-4,4),this.player.position.y-randomInt(2,4),engine.getDepth(),this.entityData[random(Object.keys(this.entityData))]);break;}}},{key:"addObject",value:function addObject(object){_get(EntitySystem.prototype.__proto__||Object.getPrototypeOf(EntitySystem.prototype),"addObject",this).call(this,object)}},{key:"removeObject",value:function removeObject(object){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.entities[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var level=_step.value;if(level.includes(object)){level.splice(level.indexOf(object),1)}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}_get(EntitySystem.prototype.__proto__||Object.getPrototypeOf(EntitySystem.prototype),"removeObject",this).call(this,object)}},{key:"generatePlayer",value:function generatePlayer(){var animations=Utility.convertAnimationsFromConfig(this.playerData.animations);var actions=Utility.convertActionsFromConfig(this.playerData.actions);var config=this.playerData;var playerClass=this.playerData.classes.warrior;return new Player(0,0,config,playerClass,actions,animations)}},{key:"generateEnemies",value:function generateEnemies(engine,entities,map,entityData,depth,player){var config=void 0,entityPosition=void 0;var numEntities=floor(depth/3)+10;entities.push([]);while(numEntities>0){config=entityData[random(Object.keys(entityData))];entityPosition=this.findSafeSpawnLocation(config.size,entities[depth],player,map);if(entityPosition!=undefined){this.generateEnemy(engine,entityPosition.x,entityPosition.y,depth,config)}numEntities--}}},{key:"generateEnemy",value:function generateEnemy(engine,x,y,depth,config){var animations=Utility.convertAnimationsFromConfig(config.animations);var actions=Utility.convertActionsFromConfig(config.actions);if(this.safeSpawnLocation(x,y,config.size,this.entities[depth],engine.getMap())){var mob=new Mob(x,y,depth,config,actions,animations);if(config.sprint_threshhold!==undefined){mob.components.push(component_sprint);mob.sprint=new SprintComponent(config.sprint_threshhold)}this.entities[depth].push(mob);engine.addObject(mob);engine.sendEvent(event_entity_spawned,mob);return true}return false}},{key:"findSafeSpawnLocation",value:function findSafeSpawnLocation(size,entities,player,map){var validSquares=[];for(var i=0;i<map.length;i++){for(var j=0;j<map[0].length;j++){if(abs(player.position.x-i)+abs(player.position.y-j)>this.config.SAFE_DISTANCE_FROM_PLAYER&&this.safeSpawnLocation(i,j,size,entities,map)){validSquares.push(map[i][j].position)}}}return random(validSquares)}},{key:"safeSpawnLocation",value:function safeSpawnLocation(x,y,size,entities,map){for(var i=x;i<x+size;i++){for(var j=y;j<y+size;j++){if(map[i][j].physical.solid){return false}}}var col=new CollisionComponent(x,y,size);var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=entities[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var e=_step2.value;if(Utility.collision(col,e.collision)){return false}}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}return true}},{key:"generateBosses",value:function generateBosses(engine,entities,levels,bossData,depth,player){var config=void 0,entityPosition=void 0;var numBosses=1;entities.push([]);while(numBosses>0){config=bossData[random(Object.keys(bossData))];entityPosition=this.findSafeSpawnLocation(config.size,entities[depth],player,levels[depth].map.map);if(entityPosition!=undefined){this.generateEnemy(engine,entityPosition.x,entityPosition.y,depth,config)}numEntities--}}},{key:"fixPlayerPosition",value:function fixPlayerPosition(player,stair,depth){player.position.x=stair.x;player.position.y=stair.y;player.depth.depth=depth}},{key:"updateEntities",value:function updateEntities(engine){var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=this.entities[engine.getDepth()][Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var e=_step3.value;engine.addObject(e)}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}engine.sendEvent(event_entities_loaded,0,1)}}]);return EntitySystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var HealthSystem=function(_System){_inherits(HealthSystem,_System);function HealthSystem(config){_classCallCheck(this,HealthSystem);var _this=_possibleConstructorReturn(this,(HealthSystem.__proto__||Object.getPrototypeOf(HealthSystem)).call(this,[component_health]));_this.config=config;return _this}_createClass(HealthSystem,[{key:"init",value:function init(engine){this.healthRegenCounter=0;this.healthRegen=true}},{key:"run",value:function run(engine){if(this.healthRegen){if(this.healthRegenCounter%this.config.HEALTH_REGEN_TIMER==0){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var o=_step.value;if(o.health.health<o.health.maxHealth){o.health.health+=5}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}this.healthRegenCounter=1}this.healthRegenCounter++}}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_entity_attacked:this.applyDamage(engine,data.target,data.healthLost);if(data.target instanceof Player){engine.sendEvent(event_player_take_damage)}break;case event_begin_combat:this.healthRegen=false;break;case event_end_combat:this.healthRegen=true;break;}}},{key:"applyDamage",value:function applyDamage(engine,object,healthLost){object.health.health-=healthLost;this.checkDead(engine,object)}},{key:"checkDead",value:function checkDead(engine,object){if(object.health.health<=0){engine.removeObject(object);if(object instanceof Player){engine.sendEvent(event_game_over)}}}}],[{key:"getHealthPercent",value:function getHealthPercent(entity){return entity.health.health/entity.health.maxHealth}},{key:"getCurrentHeartAmount",value:function getCurrentHeartAmount(entity){return floor(entity.health.health/10)}},{key:"getMaxHeartAmount",value:function getMaxHeartAmount(entity){return floor(entity.health.maxHealth/10)}}]);return HealthSystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var InputSystem=function(_System){_inherits(InputSystem,_System);function InputSystem(){_classCallCheck(this,InputSystem);return _possibleConstructorReturn(this,(InputSystem.__proto__||Object.getPrototypeOf(InputSystem)).call(this,[]))}_createClass(InputSystem,[{key:"init",value:function init(engine){this.mobSpawnCooldown=0;this.inputs=[];var self=this;document.addEventListener("keydown",function(e){self.keyDown(e)});document.addEventListener("keyup",function(e){self.keyUp(e)})}},{key:"run",value:function run(engine){if(keys.includes("n")&&this.mobSpawnCooldown<=0){this.mobSpawnCooldown=10;engine.sendEvent(event_spawn_enemy_close,engine.getPlayer())}if(this.mobSpawnCooldown>0){this.mobSpawnCooldown--}this.setPlayerAction(engine,this.inputs)}},{key:"addObject",value:function addObject(object){}},{key:"keyDown",value:function keyDown(event){if(!this.inputs.includes(event.keyCode)){this.inputs.unshift(event.keyCode)}}},{key:"keyUp",value:function keyUp(event){if(this.inputs.includes(event.keyCode)){this.inputs.splice(this.inputs.indexOf(event.keyCode),1)}}},{key:"setPlayerAction",value:function setPlayerAction(engine,inputs){var player=engine.getPlayer();if(inputs.length>0){var highestPriority=0;var playerAction=action_none;var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=inputs[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var key=_step.value;var action=keyCode_to_action[key];var priority=action_to_priority[action];priority=this.fixPriority(engine,player,action,priority);if(priority>highestPriority){playerAction=action;highestPriority=priority}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}player.actions.nextAction=playerAction}else{player.actions.nextAction=action_none}}},{key:"fixPriority",value:function fixPriority(engine,player,action,priority){if(action==action_melee_attack&&!CombatSystem.validMeleeAttack(engine,player)){return 0}if(player.actions.lastAction==action){if(player.actions.lastActionFailed){return 0}else{return priority-1}}return priority}},{key:"actionEqualsLastAction",value:function actionEqualsLastAction(player,a){return k}}]);return InputSystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var LevelSystem=function(_System){_inherits(LevelSystem,_System);function LevelSystem(config,room_pool,stair_room_pool){_classCallCheck(this,LevelSystem);var _this=_possibleConstructorReturn(this,(LevelSystem.__proto__||Object.getPrototypeOf(LevelSystem)).call(this,[]));_this.config=config;_this.roomPool=room_pool;_this.stairRoomPool=stair_room_pool;return _this}_createClass(LevelSystem,[{key:"init",value:function init(engine){this.depth=0;this.levels=[]}},{key:"run",value:function run(engine){}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_down_level:this.handleDownLevel(engine);break;case event_up_level:this.handleUpLevel(engine);break;case event_new_game:this.handleNewGame(engine);break;case event_entities_loaded:if(LOADING_SCREEN){engine.sendEvent(event_begin_level,0,60)}else{engine.sendEvent(event_begin_level,0,1)}break;}}},{key:"addObject",value:function addObject(object){_get(LevelSystem.prototype.__proto__||Object.getPrototypeOf(LevelSystem.prototype),"addObject",this).call(this,object)}},{key:"handleNewGame",value:function handleNewGame(engine){this.newLevel(engine,0);this.updateLevel(engine)}},{key:"newLevel",value:function newLevel(engine,depth){var level=generateLevel(this.config,depth,this.roomPool,this.stairRoomPool);this.levels.push(level);engine.sendEvent(event_new_level);return level}},{key:"handleDownLevel",value:function handleDownLevel(engine){engine.clearObjects();this.depth++;if(this.depth==this.levels.length){this.newLevel(engine,this.depth);this.updateLevel(engine)}else{this.updateLevel(engine)}}},{key:"handleUpLevel",value:function handleUpLevel(engine){engine.clearObjects();if(this.depth>0){this.depth--;this.updateLevel(engine)}}},{key:"updateLevel",value:function updateLevel(engine){var level=this.levels[this.depth];engine.addObject(level);for(var i=0;i<this.levels[this.depth].map.map.length;i++){for(var j=0;j<this.levels[this.depth].map.map.length;j++){engine.addObject(level.map.map[i][j])}}var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=level.torches[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var t=_step.value;engine.addObject(t)}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}engine.sendEvent(event_level_loaded,0,1)}}]);return LevelSystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var LightSystem=function(_System){_inherits(LightSystem,_System);function LightSystem(config){_classCallCheck(this,LightSystem);var _this=_possibleConstructorReturn(this,(LightSystem.__proto__||Object.getPrototypeOf(LightSystem)).call(this,[component_light_emitter]));_this.config=config;return _this}_createClass(LightSystem,[{key:"run",value:function run(engine){}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_spawn_enemy_close:this.light(engine.getMap());break;case event_player_moved:setTimeout(function(){this.light(engine.getMap())}.bind(this),50);break;case event_begin_level:this.light(engine.getMap());break;}}},{key:"addObject",value:function addObject(object){_get(LightSystem.prototype.__proto__||Object.getPrototypeOf(LightSystem.prototype),"addObject",this).call(this,object)}},{key:"light",value:function light(map){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=map[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var r=_step.value;var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=r[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var s=_step3.value;s.light.level=0}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=this.objects[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var l=_step2.value;this.setLightLevel(map[l.position.x][l.position.y],l.lightEmitter.level);for(var octant=0;octant<8;octant++){this.lightTriangle(map,octant,l.position.x,l.position.y,l.lightEmitter.level)}}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}}},{key:"setLightLevel",value:function setLightLevel(object,range,x,y){var l=x===undefined?range:range-x-floor(y*.4);if(object.light.level<l){object.light.level=l}}},{key:"lightTriangle",value:function lightTriangle(map,octant,sx,sy,range){var x=1;var shadows=[];var squaresVisible=true;while(x<=range&&squaresVisible){squaresVisible=false;var y=0;var curslope=0;while(curslope<=1){if(!VisionSystem.inShadow(x,y,shadows)){squaresVisible=true;var cur=VisionSystem.getTranslatedSquare(map,octant,x,y,sx,sy);if(cur===undefined){break}this.setLightLevel(cur,range,x,y);if(cur.display.opaque){var firstBlocked=this.getFirstBlockedLight(map,octant,x,y,sx,sy,shadows,range);var lastBlocked=this.getBlockedLight(map,octant,x,y,sx,sy,shadows,range);var shadowStart=VisionSystem.slope(firstBlocked.x,firstBlocked.y,BOTTOM_RIGHT);var shadowEnd=VisionSystem.slope(lastBlocked.x,lastBlocked.y,TOP_LEFT);shadows.push([shadowStart,shadowEnd])}else{var above=VisionSystem.getTranslatedSquare(map,octant,x,y+1,sx,sy);if(above!==undefined){}}}y++;curslope=VisionSystem.slope(x,y,CENTER_SQUARE)}x++}}},{key:"getFirstBlockedLight",value:function getFirstBlockedLight(map,octant,x,y,sx,sy,shadows,range){var firstBlocked={x:x,y:y};var currentBlocked=VisionSystem.getTranslatedSquare(map,octant,x,y,sx,sy);while(currentBlocked!==undefined&&currentBlocked.display.opaque&&VisionSystem.slope(x,y,CENTER_SQUARE)>0){firstBlocked={x:x,y:y};if(!VisionSystem.inShadow(x,y,shadows)){this.setLightLevel(currentBlocked,range,x,y)}y--;currentBlocked=VisionSystem.getTranslatedSquare(map,octant,x,y,sx,sy)}return firstBlocked}},{key:"getBlockedLight",value:function getBlockedLight(map,octant,x,y,sx,sy,shadows,range){var lastBlocked={x:x,y:y};var currentBlocked=VisionSystem.getTranslatedSquare(map,octant,x,y,sx,sy);while(currentBlocked!==undefined&&currentBlocked.display.opaque&&VisionSystem.slope(x,y,BOTTOM_RIGHT)<1){lastBlocked={x:x,y:y};if(!VisionSystem.inShadow(x,y,shadows)){this.setLightLevel(currentBlocked,range,x,y)}y++;currentBlocked=VisionSystem.getTranslatedSquare(map,octant,x,y,sx,sy)}return lastBlocked}}]);return LightSystem}(System);
'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if('value'in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var MovementSystem=function(_System){_inherits(MovementSystem,_System);function MovementSystem(){_classCallCheck(this,MovementSystem);return _possibleConstructorReturn(this,(MovementSystem.__proto__||Object.getPrototypeOf(MovementSystem)).call(this,[component_position,component_physical,component_actions]))}_createClass(MovementSystem,[{key:'run',value:function run(engine){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var entity=_step.value;switch(entity.actions.currentAction){case action_move_up:case action_move_right:case action_move_down:case action_move_left:this.move(engine,entity,this.objects);break;}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}}},{key:'handleEvent',value:function handleEvent(engine,eventID){}},{key:'addObject',value:function addObject(object){_get(MovementSystem.prototype.__proto__||Object.getPrototypeOf(MovementSystem.prototype),'addObject',this).call(this,object)}},{key:'move',value:function move(engine,entity,objects){var destination=MovementSystem.getDestination(entity,entity.actions.currentAction);if(destination!=undefined&&MovementSystem.validMove(engine,entity,destination)){entity.direction.direction=action_to_direction[entity.actions.currentAction];entity.position.x=destination.x;entity.position.y=destination.y;entity.collision.top=destination.y;entity.collision.right=destination.x+entity.physical.size;entity.collision.bottom=destination.y+entity.physical.size;entity.collision.left=destination.x;if(entity instanceof Player){this.playerWalkEvents(engine,entity)}else if(entity instanceof Mob){engine.sendEvent(event_entity_moved)}engine.sendEvent(event_successful_action,{'action':entity.actions.currentAction,'entity':entity})}else{entity.actions.lastAction=entity.actions.currentAction;entity.actions.currentAction=action_none}}},{key:'playerWalkEvents',value:function playerWalkEvents(engine,player){var square=engine.getMap()[player.position.x][player.position.y];if(square instanceof StairUpSquare&&engine.getDepth()>0){engine.sendEvent(event_up_level)}else if(square instanceof StairDownSquare){engine.sendEvent(event_down_level)}else{if(square instanceof DoorSquare){square.open()}engine.sendEvent(event_player_moved)}}}],[{key:'getDestination',value:function getDestination(entity,movement){switch(movement){case action_move_up:return new PositionComponent(entity.position.x,entity.position.y-1);case action_move_right:return new PositionComponent(entity.position.x+1,entity.position.y);case action_move_down:return new PositionComponent(entity.position.x,entity.position.y+1);case action_move_left:return new PositionComponent(entity.position.x-1,entity.position.y);default:console.log('No direction');return undefined;}}},{key:'validMove',value:function validMove(engine,entity,destination){var validMove=true;for(var i=destination.x;i<destination.x+entity.physical.size;i++){for(var j=destination.y;j<destination.y+entity.physical.size;j++){if(!Utility.walkable(i,j,engine.getMap(),entity,engine.getEntities())){validMove=false}}}return validMove}}]);return MovementSystem}(System);
"use strict";function MusicManager(){var music=MUSIC;MUSIC=null;var currentLoop=music[0];var loop=function loop(){currentLoop.ended=function(){currentLoop=playSound(music[randomInt(music.length)]);loop()}};var init=function(){}()}
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var SprintSystem=function(_System){_inherits(SprintSystem,_System);function SprintSystem(){_classCallCheck(this,SprintSystem);return _possibleConstructorReturn(this,(SprintSystem.__proto__||Object.getPrototypeOf(SprintSystem)).call(this,[component_sprint]))}_createClass(SprintSystem,[{key:"init",value:function init(engine){this.sprintTimer=[];this.sprintTimerMax=20}},{key:"run",value:function run(engine){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var entity=_step.value;this.decrementSprintCounter(entity);this.determineSprintState(engine,entity)}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_successful_action:if(data.entity.components.includes(component_sprint)){this.sprintHandler(engine,data.entity,data.action)}break;}}},{key:"addObject",value:function addObject(object){if(object.components.includes(component_sprint)){_get(SprintSystem.prototype.__proto__||Object.getPrototypeOf(SprintSystem.prototype),"addObject",this).call(this,object);this.sprintTimer[object]=0}}},{key:"sprintHandler",value:function sprintHandler(engine,entity,action){if(Utility.isMovementAction(action)){if(entity.sprint.sprintCounter<entity.sprint.movesBeforeSprinting){entity.sprint.sprintCounter++}this.resetSprintTimer(entity)}else{if(entity.sprint.sprintCounter>0){entity.sprint.sprintCounter--}}this.determineSprintState(engine,entity)}},{key:"determineSprintState",value:function determineSprintState(engine,entity){if(entity.sprint.sprinting){if(entity.sprint.sprintCounter<entity.sprint.movesBeforeSprinting){this.stopSprinting(engine,entity)}}else if(!entity.sprint.sprinting&&entity.sprint.sprintCounter==entity.sprint.movesBeforeSprinting){this.startSprinting(engine,entity)}}},{key:"startSprinting",value:function startSprinting(engine,entity){if(entity instanceof Player){engine.sendEvent(event_player_start_sprinting)}entity.sprint.sprinting=true;this.resetSprintTimer(entity)}},{key:"stopSprinting",value:function stopSprinting(engine,entity){if(entity instanceof Player){engine.sendEvent(event_player_stop_sprinting)}entity.sprint.sprinting=false;entity.sprint.sprintCounter=0}},{key:"resetSprintTimer",value:function resetSprintTimer(entity){this.sprintTimer[entity]=this.sprintTimerMax}},{key:"decrementSprintCounter",value:function decrementSprintCounter(entity){if(entity.sprint.sprintCounter>0){this.sprintTimer[entity]--;if(this.sprintTimer[entity]<=0){entity.sprint.sprintCounter--;this.resetSprintTimer(entity)}}}},{key:"stopAllSprinting",value:function stopAllSprinting(engine){var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=this.objects[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var entity=_step2.value;this.stopSprinting(engine,entity)}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}}}]);return SprintSystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var System=function(){function System(componentRequirements){_classCallCheck(this,System);this.objects=[];this.componentRequirements=componentRequirements}_createClass(System,[{key:"init",value:function init(engine){}},{key:"addObject",value:function addObject(object){if(this.componentRequirements.length>0&&!this.objects.includes(object)&&Utility.checkComponents(object,this.componentRequirements)){this.objects.push(object)}}},{key:"removeObject",value:function removeObject(object){if(this.objects.indexOf(object)!==-1){this.objects.splice(this.objects.indexOf(object),1)}}},{key:"clearObjects",value:function clearObjects(){this.objects=[]}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){}}]);return System}();
'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if('value'in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var UISystem=function(_System){_inherits(UISystem,_System);function UISystem(config,images){_classCallCheck(this,UISystem);var _this=_possibleConstructorReturn(this,(UISystem.__proto__||Object.getPrototypeOf(UISystem)).call(this,[]));_this.config=config;_this.images=images;return _this}_createClass(UISystem,[{key:'init',value:function init(engine){this.gameCanvas=document.getElementById('game');this.titleScreen=document.getElementById('titleScreen');this.helpScreen=document.getElementById('helpScreen');this.levelChangeScreen=document.getElementById('levelChangeScreen');this.levelChangeText=document.getElementById('levelChangeText');this.gameOverScreen=document.getElementById('gameOverScreen');this.resetScreen(this.titleScreen);this.resetScreen(this.helpScreen);this.resetScreen(this.levelChangeScreen);this.resetScreen(this.gameOverScreen);this.drawHearts=false;this.heartCanvas=document.getElementById('heartCanvas').getContext('2d');document.getElementById('heartCanvas').style.left=''+this.config.HEART_OFFSET+'px';document.getElementById('heartCanvas').style.top=''+this.config.HEART_OFFSET+'px'}},{key:'run',value:function run(engine){this.drawPlayerHealth(this.heartCanvas,engine.getPlayer())}},{key:'handleEvent',value:function handleEvent(engine,eventID,data){switch(eventID){case event_new_game:this.showLevelChangeScreen(engine);break;case event_title_screen:this.showTitleScreen(engine);break;case event_down_level:this.showLevelChangeScreen(engine);break;case event_up_level:this.showLevelChangeScreen(engine);break;case event_begin_level:this.hideLevelChangeScreen(engine);break;case event_player_generated:this.fixHeartCanvasSize(engine.getPlayer());break;case event_game_over:this.showGameOverScreen(engine);break;}}},{key:'addObject',value:function addObject(object){_get(UISystem.prototype.__proto__||Object.getPrototypeOf(UISystem.prototype),'addObject',this).call(this,object)}},{key:'showTitleScreen',value:function showTitleScreen(engine){this.fadeScreenIn(this.titleScreen,this.config.TITLE_FADE_IN_TIME);var self=this;document.getElementById('playButton').addEventListener('click',function(){self.fadeScreenOut(self.titleScreen,self.config.TITLE_FADE_OUT_TIME);engine.sendEvent(event_new_game)});document.getElementById('helpButton').addEventListener('click',function(){self.blurScreen(self.titleScreen,self.config.TITLE_BLUR_AMOUNT,self.config.TITLE_FADE_OUT_TIME);self.fadeScreenIn(self.helpScreen,self.config.TITLE_FADE_IN_TIME);document.getElementById('returnToTitleScreenButton').addEventListener('click',function(){self.unblurScreen(self.titleScreen,self.config.TITLE_FADE_IN_TIME);self.fadeScreenOut(self.helpScreen,self.config.TITLE_FADE_OUT_TIME)})})}},{key:'showLevelChangeScreen',value:function showLevelChangeScreen(engine){this.levelChangeText.innerHTML='Entering Level '+(engine.getDepth()+1);this.fadeScreenIn(this.levelChangeScreen,this.config.LEVEL_CHANGE_FADE_IN_TIME);this.drawHearts=false}},{key:'hideLevelChangeScreen',value:function hideLevelChangeScreen(engine){this.fadeScreenOut(this.levelChangeScreen,this.config.LEVEL_CHANGE_FADE_OUT_TIME);this.drawHearts=true}},{key:'showGameOverScreen',value:function showGameOverScreen(engine){this.fadeScreenIn(this.gameOverScreen,this.config.GAME_OVER_FADE_IN_TIME);this.blurScreen(this.gameCanvas,this.config.GAME_BLUR_AMOUNT,this.config.GAME_OVER_FADE_IN_TIME);this.hideHearts();var self=this;document.getElementById('playAgainButton').addEventListener('click',function(){self.fadeScreenOut(self.gameOverScreen,self.config.GAME_OVER_FADE_OUT_TIME);self.unblurScreen(self.gameCanvas,self.config.GAME_OVER_FADE_OUT_TIME);engine.sendEvent(event_reset_game);engine.sendEvent(event_new_game,undefined,20)})}},{key:'fadeScreenIn',value:function fadeScreenIn(screen,milliseconds){screen.style.transitionDuration=milliseconds+'ms';screen.style.opacity='1';screen.style.visibility='visible'}},{key:'fadeScreenOut',value:function fadeScreenOut(screen,milliseconds){screen.style.transitionDuration=milliseconds+'ms';screen.style.opacity='0';setTimeout(function(){screen.style.visibility='hidden'},milliseconds)}},{key:'blurScreen',value:function blurScreen(screen,blurAmount,milliseconds){screen.style.transitionDuration=milliseconds+'ms';screen.style.filter='blur('+blurAmount+'px)'}},{key:'unblurScreen',value:function unblurScreen(screen,milliseconds){screen.style.transitionDuration=milliseconds+'ms';screen.style.filter='blur(0)'}},{key:'resetScreen',value:function resetScreen(screen){screen.style.opacity='0';screen.style.visibility='hidden'}},{key:'hideHearts',value:function hideHearts(){this.heartCanvas.clearRect(0,0,heartCanvas.width,heartCanvas.height);this.drawHearts=false}},{key:'drawPlayerHealth',value:function drawPlayerHealth(heartCanvas,player){if(this.drawHearts){var x=0,y=0;for(var i=1;i<=HealthSystem.getMaxHeartAmount(player);i++){if(i<=HealthSystem.getCurrentHeartAmount(player)){heartCanvas.drawImage(this.images[ui_heart],x*this.config.HEART_SIZE+x*this.config.HEART_SPACING,y*this.config.HEART_SIZE,this.config.HEART_SIZE,this.config.HEART_SIZE)}else{heartCanvas.drawImage(this.images[ui_empty_heart],x*this.config.HEART_SIZE+x*this.config.HEART_SPACING,y*this.config.HEART_SIZE,this.config.HEART_SIZE,this.config.HEART_SIZE)}x++;if(i%this.config.HEARTS_PER_ROW==0){y++;x=0}}}}},{key:'fixHeartCanvasSize',value:function fixHeartCanvasSize(player){var heartCanvas=document.getElementById('heartCanvas');var heartAmount=HealthSystem.getMaxHeartAmount(player);var w=(this.config.HEART_SPACING+this.config.HEART_SIZE)*this.config.HEARTS_PER_ROW;var h=(this.config.HEART_SPACING+this.config.HEART_SIZE)*ceil(heartAmount/this.config.HEARTS_PER_ROW);heartCanvas.width=w;heartCanvas.height=h}}]);return UISystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var VisionSystem=function(_System){_inherits(VisionSystem,_System);function VisionSystem(config){_classCallCheck(this,VisionSystem);var _this=_possibleConstructorReturn(this,(VisionSystem.__proto__||Object.getPrototypeOf(VisionSystem)).call(this,[component_display,component_position]));_this.config=config;return _this}_createClass(VisionSystem,[{key:"init",value:function init(engine){this.player=undefined;this.map=undefined}},{key:"run",value:function run(engine){}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_player_moved:case event_entity_moved:case event_begin_level:case event_spawn_enemy_close:this.vision(this.map,this.player);break;}}},{key:"addObject",value:function addObject(object){if(object instanceof Player){this.player=object}else if(object instanceof Level){this.map=object.map.map}else if(!(object instanceof Square)){_get(VisionSystem.prototype.__proto__||Object.getPrototypeOf(VisionSystem.prototype),"addObject",this).call(this,object)}}},{key:"vision",value:function vision(map,player){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=map[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var r=_step.value;var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=r[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var s=_step3.value;s.display.visible=false}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}player.display.visible=true;map[player.position.x][player.position.y].display.visible=true;map[player.position.x][player.position.y].display.discovered=true;for(var octant=0;octant<8;octant++){this.playerSightTriangle(map,octant,player.position.x,player.position.y,this.config.PLAYER_VISION_RANGE)}var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=this.objects[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var e=_step2.value;if(map[e.position.x][e.position.y].display.visible){e.display.visible=true;e.display.discovered=true}else{e.display.visible=false}}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}}},{key:"playerSightTriangle",value:function playerSightTriangle(map,octant,sx,sy,range){var x=1;var shadows=[];var squaresVisible=true;while(x<=range&&squaresVisible){squaresVisible=false;var y=0;var curslope=0;while(curslope<=1){if(!VisionSystem.inShadow(x,y,shadows)){squaresVisible=true;var cur=VisionSystem.getTranslatedSquare(map,octant,x,y,sx,sy);if(cur===undefined){break}cur.display.visible=true;cur.display.discovered=true;if(cur.display.opaque){var firstBlocked=this.getFirstBlocked(map,octant,x,y,sx,sy,shadows);var lastBlocked=this.getBlocked(map,octant,x,y,sx,sy,shadows);var shadowStart=VisionSystem.slope(firstBlocked.x,firstBlocked.y,BOTTOM_RIGHT);var shadowEnd=VisionSystem.slope(lastBlocked.x,lastBlocked.y,TOP_LEFT);shadows.push([shadowStart,shadowEnd])}else{var above=VisionSystem.getTranslatedSquare(map,octant,x,y+1,sx,sy);if(above!==undefined){above.display.discovered=true}}}y++;curslope=VisionSystem.slope(x,y,CENTER_SQUARE)}x++}}},{key:"getFirstBlocked",value:function getFirstBlocked(map,octant,x,y,sx,sy,shadows){var firstBlocked={x:x,y:y};var currentBlocked=VisionSystem.getTranslatedSquare(map,octant,x,y,sx,sy);while(currentBlocked!==undefined&&currentBlocked.display.opaque&&VisionSystem.slope(x,y,CENTER_SQUARE)>0){firstBlocked={x:x,y:y};if(!VisionSystem.inShadow(x,y,shadows)){currentBlocked.display.visible=true;currentBlocked.display.discovered=true}y--;currentBlocked=VisionSystem.getTranslatedSquare(map,octant,x,y,sx,sy)}return firstBlocked}},{key:"getBlocked",value:function getBlocked(map,octant,x,y,sx,sy,shadows){var lastBlocked={x:x,y:y};var currentBlocked=VisionSystem.getTranslatedSquare(map,octant,x,y,sx,sy);while(currentBlocked!==undefined&&currentBlocked.display.opaque&&VisionSystem.slope(x,y,BOTTOM_RIGHT)<1){lastBlocked={x:x,y:y};if(!VisionSystem.inShadow(x,y,shadows)){currentBlocked.display.visible=true;currentBlocked.display.discovered=true}y++;currentBlocked=VisionSystem.getTranslatedSquare(map,octant,x,y,sx,sy)}return lastBlocked}}],[{key:"slope",value:function slope(x,y,CORNER){switch(CORNER){case CENTER_SQUARE:return y/x;case TOP_LEFT:if(x==0){return 1}return(y+.5)/(x-.5);case BOTTOM_RIGHT:return max(0,(y-.5)/(x+.5));case UPPER_BOUND:return(y+PERM)/(x-PERM);case LOWER_BOUND:return(y-PERM)/(x+PERM);}return 1}},{key:"inShadow",value:function inShadow(x,y,shadows){var BR=VisionSystem.slope(x,y,BOTTOM_RIGHT),TL=VisionSystem.slope(x,y,TOP_LEFT);var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=shadows[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var s=_step4.value;if(BR>=s[0]&&TL<=s[1])return true;else if(BR>=s[0]&&BR<=s[1]&&TL>=s[1]){BR=s[1]}else if(BR<=s[0]&&TL>=s[0]&&TL<=s[1]){TL=s[0]}}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return()}}finally{if(_didIteratorError4){throw _iteratorError4}}}return false}},{key:"startSquare",value:function startSquare(x,slopeStart){if(slopeStart==0)return 0;return ceil(x*slopeStart)}},{key:"getTranslatedSquare",value:function getTranslatedSquare(map,octant,x,y,sx,sy){var uc=VisionSystem.translate(octant,x,y);var fx=sx+uc[0];var fy=sy-uc[1];if(Utility.positionInBounds(new PositionComponent(fx,fy),map.length)){return map[fx][fy]}return undefined}},{key:"translate",value:function translate(octant,x,y){return[x*xxcomp[octant]+y*xycomp[octant],x*yxcomp[octant]+y*yycomp[octant]]}},{key:"isOpaque",value:function isOpaque(square){return square.display.opaque}},{key:"lineOfSight",value:function lineOfSight(engine,p1,p2){var LOS_PERM=.5;var map=engine.getMap();if(p1==p2){return true}else if(p1.y==p2.y){var start=p1.x<p2.x?p1:p2;var end=start==p1?p2:p1;var curSquare=map[start.x][start.y];for(var x=start.x;x<=end.x;x++){if(VisionSystem.isOpaque(map[x][start.y])){return false}}}else if(p1.x==p2.x){var _start=p1.y<p2.y?p1:p2;var _end=_start==p1?p2:p1;var _curSquare=map[_start.x][_start.y];for(var y=_start.y;y<=_end.y;y++){if(VisionSystem.isOpaque(map[_start.x][y])){return false}}}else{var _start2=void 0,_end2=void 0,_x=void 0,_y=void 0,slope=void 0,_curSquare2=void 0,direction=void 0;var difX=abs(p1.x-p2.x);var difY=abs(p1.y-p2.y);if(difX<=difY){_start2=p1.x<=p2.x?p1:p2;_end2=_start2==p1?p2:p1;slope=abs(_end2.x-_start2.x)/abs(_end2.y-_start2.y);direction=_start2.y<_end2.y?1:-1;_x=_start2.x;_y=_start2.y;var error=0;while(_x<=_end2.x){if(VisionSystem.isOpaque(map[_x][_y])){return false}if(_y==_end2.y){break}_y+=direction;error+=slope;if(error>.5){_x++;error-=1}}}else{_start2=p1.y<=p2.y?p1:p2;_end2=_start2==p1?p2:p1;slope=abs(_end2.y-_start2.y)/abs(_end2.x-_start2.x);direction=_start2.x<_end2.x?1:-1;_x=_start2.x;_y=_start2.y;var _error=0;while(_y<=_end2.y){if(VisionSystem.isOpaque(map[_x][_y])){return false}if(_x==_end2.x){break}_x+=direction;_error+=slope;if(_error>.5){_y++;_error-=1}}}}return true}}]);return VisionSystem}(System);
"use strict";function Level(map,stairUp,stairDown,depth,torches){this.components=[component_map,component_stair,component_depth];this.map=new MapComponent(map);this.stairUp=new PositionComponent(stairUp.x,stairUp.y);this.stairDown=new PositionComponent(stairDown.x,stairDown.y);this.depth=new DepthComponent(depth);this.torches=torches}
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Square=function Square(x,y,textures,solid,opaque){_classCallCheck(this,Square);this.components=[component_position,component_display,component_texture,component_physical,component_light];this.position=new PositionComponent(x,y);this.display=new DisplayComponent(1,1,opaque);this.textures=textures;this.physical=new PhysicalComponent(solid,1);this.light=new LightComponent};var BlankSquare=function(_Square){_inherits(BlankSquare,_Square);function BlankSquare(x,y){_classCallCheck(this,BlankSquare);return _possibleConstructorReturn(this,(BlankSquare.__proto__||Object.getPrototypeOf(BlankSquare)).call(this,x,y,[],physical_solid,display_transparent))}return BlankSquare}(Square);var WallSquare=function(_Square2){_inherits(WallSquare,_Square2);function WallSquare(x,y){_classCallCheck(this,WallSquare);var textures=[new TextureComponent(texture_wall)];return _possibleConstructorReturn(this,(WallSquare.__proto__||Object.getPrototypeOf(WallSquare)).call(this,x,y,textures,physical_solid,display_opaque))}return WallSquare}(Square);var FloorSquare=function(_Square3){_inherits(FloorSquare,_Square3);function FloorSquare(x,y){_classCallCheck(this,FloorSquare);var textures=[new TextureComponent(texture_floor)];return _possibleConstructorReturn(this,(FloorSquare.__proto__||Object.getPrototypeOf(FloorSquare)).call(this,x,y,textures,physical_non_solid,display_transparent))}return FloorSquare}(Square);var DoorSquare=function(_WallSquare){_inherits(DoorSquare,_WallSquare);function DoorSquare(x,y){_classCallCheck(this,DoorSquare);var _this4=_possibleConstructorReturn(this,(DoorSquare.__proto__||Object.getPrototypeOf(DoorSquare)).call(this,x,y,[],physical_solid,display_opaque));var textures=[new TextureComponent(texture_floor),new TextureComponent(texture_door_closed)];_this4.textures=textures;_this4.opened=false;return _this4}_createClass(DoorSquare,[{key:"open",value:function open(){this.opened=true;this.physical.solid=false;this.display.opaque=false;this.textures[1].textureType=texture_door_open}}]);return DoorSquare}(WallSquare);var LootSquare=function(_Square4){_inherits(LootSquare,_Square4);function LootSquare(x,y){_classCallCheck(this,LootSquare);var textures=[new TextureComponent(texture_floor),new TextureComponent(texture_loot_closed)];var _this5=_possibleConstructorReturn(this,(LootSquare.__proto__||Object.getPrototypeOf(LootSquare)).call(this,x,y,textures,physical_solid,display_transparent));_this5.opened=false;return _this5}_createClass(LootSquare,[{key:"open",value:function open(){this.opened=true;this.textures[1].textureType=texture_loot_open}}]);return LootSquare}(Square);var StairUpSquare=function(_FloorSquare){_inherits(StairUpSquare,_FloorSquare);function StairUpSquare(x,y){_classCallCheck(this,StairUpSquare);var _this6=_possibleConstructorReturn(this,(StairUpSquare.__proto__||Object.getPrototypeOf(StairUpSquare)).call(this,x,y,[],physical_solid,display_transparent));var textures=[new TextureComponent(texture_floor),new TextureComponent(texture_stair_up)];_this6.textures=textures;return _this6}return StairUpSquare}(FloorSquare);var StairDownSquare=function(_FloorSquare2){_inherits(StairDownSquare,_FloorSquare2);function StairDownSquare(x,y){_classCallCheck(this,StairDownSquare);var _this7=_possibleConstructorReturn(this,(StairDownSquare.__proto__||Object.getPrototypeOf(StairDownSquare)).call(this,x,y,[],physical_solid,display_transparent));var textures=[new TextureComponent(texture_floor),new TextureComponent(texture_stair_down)];_this7.textures=textures;return _this7}return StairDownSquare}(FloorSquare);
"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Torch=function Torch(x,y,direction){_classCallCheck(this,Torch);var SIZE=.2;this.components=[component_position,component_direction,component_display,component_light_emitter];this.position=new PositionComponent(x,y);this.direction=new DirectionComponent(direction);var xoff=.5;var yoff=.5;if(direction==direction_up){yoff=1}else if(direction==direction_right){xoff=0}else if(direction==direction_down){yoff=0}else if(direction==direction_left){xoff=1}this.display=new DisplayComponent(SIZE,SIZE,display_transparent,xoff,yoff);this.lightEmitter=new LightEmitterComponent(light_level_torch)};

//# sourceMappingURL=bundle.min.js.map