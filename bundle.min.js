"use strict";var UP=0,RIGHT=1,DOWN=2,LEFT=3;var OPEN=0,CLOSED=1;var entity_player=0,entity_mob=1;var physical_solid=true,physical_non_solid=false;var display_opaque=true,display_transparent=false;var entity_active_range=20;var CENTER_SQUARE=0,TOP_LEFT=1,BOTTOM_RIGHT=2,UPPER_BOUND=3,LOWER_BOUND=4;var PERM=.5;var xxcomp=[1,0,0,-1,-1,0,0,1];var xycomp=[0,1,-1,0,0,-1,1,0];var yxcomp=[0,1,1,0,0,-1,-1,0];var yycomp=[1,0,0,1,-1,0,0,-1];var light_range=8,light_intensity=.07,light_red=230,light_green=150,light_blue=0;var shadow_intensity=.08,shadow_red=10,shadow_green=5,shadow_blue=25,shadow_max=.6;var light_fill_string="rgba("+light_red+","+light_green+","+light_blue+",";var light_level_to_shadow=[];light_level_to_shadow[0]="rgba("+10+", "+0+", "+35+", 0.40";light_level_to_shadow[1]="rgba("+10+", "+2+", "+30+", 0.35";light_level_to_shadow[2]="rgba("+10+", "+4+", "+25+", 0.30";light_level_to_shadow[3]="rgba("+20+", "+6+", "+20+", 0.25";light_level_to_shadow[4]="rgba("+30+", "+8+", "+15+", 0.20";light_level_to_shadow[5]="rgba("+50+", "+10+", "+10+", 0.15";light_level_to_shadow[6]="rgba("+100+", "+30+", "+5+", 0.10";light_level_to_shadow[7]="rgba("+180+", "+50+", "+0+", 0.05";light_level_to_shadow[8]="rgba("+255+", "+70+", "+0+", 0.05";var FLOOR=0,WALL=1,DOOR=2,STAIR_DOWN=3,STAIR_UP=4,LOOT=5;var texture_floor=0,texture_wall=1,texture_door_closed=2,texture_door_open=3,texture_loot_closed=4,texture_loot_open=5,texture_stair_up=6,texture_stair_down=7;var HEART=0;var component_position=0,component_movement=1,component_display=2,component_animation=3,component_actions=4,component_physical=5,component_sprint=6,component_direction=7,component_map=8,component_health=9,component_light=10,component_strength=11,component_intelligence=12,component_magic=13,component_level=14,component_depth=15,component_stair=16,component_combat=17,component_ai=18;var event_new_game=0,event_start_game=1,event_first_level_initiated=2,event_player_generated=3,event_down_level=4,event_up_level=5,event_new_level=6,event_window_resized=7,event_player_moved=10,event_entity_moved=11,event_player_start_sprinting=12,event_player_stop_sprinting=13,event_open_door=14,event_successful_action=20,event_failed_action=21,event_new_animation=30,event_begin_combat=40,event_end_combat=41,event_entity_take_damage=42,event_player_melee_attack=43,event_player_spin_attack=44,event_player_take_damage=45,event_entity_spawned=50,event_spawn_enemy_close=51,event_game_over=1000;var direction_up=0,direction_right=1,direction_down=2,direction_left=3;var animation_idle=0,animation_move_up=1,animation_move_right=2,animation_move_down=3,animation_move_left=4,animation_sprint_up=5,animation_sprint_right=6,animation_sprint_down=7,animation_sprint_left=8,animation_melee_attack_up=9,animation_melee_attack_right=10,animation_melee_attack_down=11,animation_melee_attack_left=12,animation_spin_attack=13;var action_none=-1,action_move=0,action_move_up=1,action_move_right=2,action_move_down=3,action_move_left=4,action_sprint=10,action_sprint_up=11,action_sprint_right=12,action_sprint_down=13,action_sprint_left=14,action_melee_attack=20,action_melee_attack_up=21,action_melee_attack_right=22,action_melee_attack_down=23,action_melee_attack_left=24,action_spin_attack=25;var key_to_action={"w":action_move_up,"a":action_move_left,"s":action_move_down,"d":action_move_right,"e":action_melee_attack,"q":action_spin_attack};var animation_strings_to_constants=[];animation_strings_to_constants["animation_idle"]=animation_idle;animation_strings_to_constants["animation_move_up"]=animation_move_up;animation_strings_to_constants["animation_move_right"]=animation_move_right;animation_strings_to_constants["animation_move_down"]=animation_move_down;animation_strings_to_constants["animation_move_left"]=animation_move_left;animation_strings_to_constants["animation_sprint_up"]=animation_sprint_up;animation_strings_to_constants["animation_sprint_right"]=animation_sprint_right;animation_strings_to_constants["animation_sprint_down"]=animation_sprint_down;animation_strings_to_constants["animation_sprint_left"]=animation_sprint_left;animation_strings_to_constants["animation_melee_attack_up"]=animation_melee_attack_up;animation_strings_to_constants["animation_melee_attack_right"]=animation_melee_attack_right;animation_strings_to_constants["animation_melee_attack_down"]=animation_melee_attack_down;animation_strings_to_constants["animation_melee_attack_left"]=animation_melee_attack_left;animation_strings_to_constants["animation_spin_attack"]=animation_spin_attack;var action_strings_to_constants=[];action_strings_to_constants["action_none"]=action_none;action_strings_to_constants["action_move_up"]=action_move_up;action_strings_to_constants["action_move_right"]=action_move_right;action_strings_to_constants["action_move_down"]=action_move_down;action_strings_to_constants["action_move_left"]=action_move_left;action_strings_to_constants["action_sprint_up"]=action_sprint_up;action_strings_to_constants["action_sprint_right"]=action_sprint_right;action_strings_to_constants["action_sprint_down"]=action_sprint_down;action_strings_to_constants["action_sprint_left"]=action_sprint_left;action_strings_to_constants["action_melee_attack_up"]=action_melee_attack_up;action_strings_to_constants["action_melee_attack_right"]=action_melee_attack_right;action_strings_to_constants["action_melee_attack_down"]=action_melee_attack_down;action_strings_to_constants["action_melee_attack_left"]=action_melee_attack_left;action_strings_to_constants["action_spin_attack"]=action_spin_attack;var action_to_priority=[];action_to_priority[action_none]=0;action_to_priority[action_move_up]=3;action_to_priority[action_move_left]=3;action_to_priority[action_move_down]=3;action_to_priority[action_move_right]=3;action_to_priority[action_melee_attack]=4;action_to_priority[action_spin_attack]=4;var movement_to_sprint=[];movement_to_sprint[action_move_up]=action_sprint_up;movement_to_sprint[action_move_right]=action_sprint_right;movement_to_sprint[action_move_down]=action_sprint_down;movement_to_sprint[action_move_left]=action_sprint_left;var sprint_to_movement=[];sprint_to_movement[action_sprint_up]=action_move_up;sprint_to_movement[action_sprint_right]=action_move_right;sprint_to_movement[action_sprint_down]=action_move_down;sprint_to_movement[action_sprint_left]=action_move_left;var action_to_length=[];action_to_length[action_move_up]=100;action_to_length[action_move_right]=100;action_to_length[action_move_down]=100;action_to_length[action_move_left]=100;action_to_length[action_sprint]=60;action_to_length[action_melee_attack_up]=200;action_to_length[action_melee_attack_right]=200;action_to_length[action_melee_attack_down]=200;action_to_length[action_melee_attack_left]=200;action_to_length[action_spin_attack]=250;var action_to_direction=[];action_to_direction[action_move_up]=direction_up;action_to_direction[action_move_right]=direction_right;action_to_direction[action_move_down]=direction_down;action_to_direction[action_move_left]=direction_left;action_to_direction[action_sprint_up]=direction_up;action_to_direction[action_sprint_right]=direction_right;action_to_direction[action_sprint_down]=direction_down;action_to_direction[action_sprint_left]=direction_left;var direction_to_attack=[];direction_to_attack[direction_up]=action_melee_attack_up;direction_to_attack[direction_right]=action_melee_attack_right;direction_to_attack[direction_down]=action_melee_attack_down;direction_to_attack[direction_left]=action_melee_attack_left;var direction_to_movement=[];direction_to_movement[direction_up]=action_move_up;direction_to_movement[direction_right]=action_move_right;direction_to_movement[direction_down]=action_move_down;direction_to_movement[direction_left]=action_move_left;var direction_to_action=[];direction_to_action[action_move+direction_up]=action_move_up;direction_to_action[action_move+direction_right]=action_move_right;direction_to_action[action_move+direction_down]=action_move_down;direction_to_action[action_move+direction_left]=action_move_left;var action_to_animation=[];action_to_animation[action_none]=animation_idle;action_to_animation[action_move_up]=animation_move_up;action_to_animation[action_move_right]=animation_move_right;action_to_animation[action_move_down]=animation_move_down;action_to_animation[action_move_left]=animation_move_left;action_to_animation[action_sprint_up]=animation_sprint_up;action_to_animation[action_sprint_right]=animation_sprint_right;action_to_animation[action_sprint_down]=animation_sprint_down;action_to_animation[action_sprint_left]=animation_sprint_left;action_to_animation[action_melee_attack_up]=animation_melee_attack_up;action_to_animation[action_melee_attack_right]=animation_melee_attack_right;action_to_animation[action_melee_attack_down]=animation_melee_attack_down;action_to_animation[action_melee_attack_left]=animation_melee_attack_left;action_to_animation[action_spin_attack]=animation_spin_attack;
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var System=function(){function System(componentRequirements){_classCallCheck(this,System);this.objects=[];this.componentRequirements=componentRequirements}_createClass(System,[{key:"addObject",value:function addObject(object){if(this.componentRequirements.length==0)return;else if(Utility.checkComponents(object,this.componentRequirements)){this.objects.push(object)}}},{key:"removeObject",value:function removeObject(object){if(this.objects.indexOf(object)!==-1){this.objects.splice(this.objects.indexOf(object),1)}}},{key:"clearObjects",value:function clearObjects(){this.objects=[]}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){}}]);return System}();
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var PoppsEngine=function(){function PoppsEngine(data){_classCallCheck(this,PoppsEngine);this.init(data)}_createClass(PoppsEngine,[{key:"init",value:function init(data){var config=data.config;var ROOM_POOL=data.room_pool;var STAIR_ROOM_POOL=data.stair_room_pool;var IMAGES=data.images;var PLAYER_DATA=data.player_data;var ENTITY_DATA=data.entity_data;this.systems=[];var tickInterval=undefined;this.systems.push(new InputSystem);this.systems.push(new DisplaySystem(config.display,IMAGES));this.systems.push(new VisionSystem(config.vision));this.systems.push(new ActionSystem);this.systems.push(new MovementSystem);this.systems.push(new LevelSystem(config.level,ROOM_POOL,STAIR_ROOM_POOL));this.systems.push(new EntitySystem(PLAYER_DATA,ENTITY_DATA));this.systems.push(new AnimationSystem(config.animation));this.systems.push(new CombatSystem);this.systems.push(new HealthSystem(config.health));this.systems.push(new AISystem);this.systems.push(new SprintSystem);this.sendEvent(event_new_game);this.sendEvent(event_start_game);window.requestAnimationFrame(this.tick.bind(this))}},{key:"tick",value:function tick(){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.systems[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var s=_step.value;s.run(this)}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}window.requestAnimationFrame(this.tick.bind(this))}},{key:"sendEvent",value:function sendEvent(e,data){if(e==event_game_over){clearInterval(tickInterval)}var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=this.systems[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var s=_step2.value;s.handleEvent(this,e,data)}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}}},{key:"addObject",value:function addObject(object){var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=this.systems[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var s=_step3.value;s.addObject(object)}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}}},{key:"removeObject",value:function removeObject(object){var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=this.systems[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var s=_step4.value;s.removeObject(object)}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return()}}finally{if(_didIteratorError4){throw _iteratorError4}}}}},{key:"clearObjects",value:function clearObjects(){var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=this.systems[Symbol.iterator](),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var s=_step5.value;s.clearObjects()}}catch(err){_didIteratorError5=true;_iteratorError5=err}finally{try{if(!_iteratorNormalCompletion5&&_iterator5.return){_iterator5.return()}}finally{if(_didIteratorError5){throw _iteratorError5}}}}}]);return PoppsEngine}();
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Utility=function(){function Utility(){_classCallCheck(this,Utility)}_createClass(Utility,null,[{key:"collision",value:function collision(o1,o2){return!(o1.top>=o2.bottom||o1.right<=o2.left||o1.bottom<=o2.top||o1.left>=o2.right)}},{key:"checkComponents",value:function checkComponents(object,requirements){for(var i=0;i<requirements.length;i++){if(object.components.indexOf(requirements[i])===-1)return false}return true}},{key:"entityActionSuccessful",value:function entityActionSuccessful(entity){entity.actions.busy=action_length[entity.actions.currentAction];entity.animation.newAnimation=true;entity.animation.animation=action_to_animation[entity.actions.currentAction];entity.actions.failedAction=action_none;entity.actions.lastAction=entity.actions.currentAction;entity.actions.currentAction=action_none}},{key:"entityActionFailed",value:function entityActionFailed(entity){entity.actions.lastAction=action_none;entity.actions.failedAction=entity.actions.currentAction;entity.actions.currentAction=action_none}},{key:"entityWithinRange",value:function entityWithinRange(e1,e2,dist){return abs(e1.position.x-e2.position.x)<dist&&abs(e1.position.y-e2.position.y)<dist}},{key:"entityDistance",value:function entityDistance(e1,e2){return abs(e1.position.x>e2.position.x?e1.collision.left-e2.collision.right:e1.collision.right-e2.collision.left)+abs(e1.position.y>e2.position.y?e1.collision.top-e2.collision.bottom:e1.collision.bottom-e2.collision.top)}},{key:"getDirectionToEntity",value:function getDirectionToEntity(e1,e2){if(e1.position.y>e2.position.y){return direction_up}if(e1.position.x<e2.position.x){return direction_right}if(e1.position.y<e2.position.y){return direction_down}if(e1.position.x>e2.position.x){return direction_left}}},{key:"entityAdjacent",value:function entityAdjacent(entity,otherEntity){if(Utility.collision(new CollisionComponent(entity.collision.top-1,entity.collision.right,entity.collision.top,entity.collision.left),otherEntity.collision)){return direction_up}else if(Utility.collision(new CollisionComponent(entity.collision.top,entity.collision.right+1,entity.collision.bottom,entity.collision.right),otherEntity.collision)){return direction_right}else if(Utility.collision(new CollisionComponent(entity.collision.bottom,entity.collision.right,entity.collision.bottom+1,entity.collision.left),otherEntity.collision)){return direction_down}else if(Utility.collision(new CollisionComponent(entity.collision.top,entity.collision.left,entity.collision.bottom,entity.collision.left-1),otherEntity.collision)){return direction_left}else{return-1}}},{key:"getSquareNeighbors",value:function getSquareNeighbors(x,y,map){neighbors=[];if(x>0){neighbors.push(map[x-1][y])}if(y>0){neighbors.push(map[x][y-1])}if(x<map.length-1){neighbors.push(map[x+1][y])}if(y<map.length-1){neighbors.push(map[x][y+1])}return neighbors}},{key:"getHealthPercent",value:function getHealthPercent(entity){return entity.health.health/entity.health.maxHealth}},{key:"findMobPath",value:function findMobPath(board,mob,player){return findPath(board,board[mob.position.x][mob.position.y],board[player.position.x][player.position.y])}},{key:"walkable",value:function walkable(x,y,map,entity,objects){return Utility.positionInBounds(x,y,map.length)&&Utility.squareTypeIsWalkable(map[x][y],entity)&&!Utility.squareIsOccupied(x,y,entity,objects)}},{key:"positionOnScreen",value:function positionOnScreen(x,y,w,h){return x>-w&&x<width+w&&y>-h&&y<height+h}},{key:"positionInBounds",value:function positionInBounds(x,y,size){return x>=0&&x<size&&y>=0&&y<size}},{key:"squareInBounds",value:function squareInBounds(square,size){return square.position.x>=0&&square.position.x<size&&square.position.y>=0&&square.position.y<size}},{key:"squareTypeIsWalkable",value:function squareTypeIsWalkable(square,entity){return entity instanceof Player?Utility.playerWalkable(square):Utility.mobWalkable(square)}},{key:"playerWalkable",value:function playerWalkable(square){return!square.physical.solid||square instanceof DoorSquare||square instanceof StairUpSquare||square instanceof StairDownSquare}},{key:"mobWalkable",value:function mobWalkable(square){return!square.physical.solid}},{key:"squareIsOccupied",value:function squareIsOccupied(x,y,entity,objects){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var o=_step.value;if(entity!=o){if(Utility.collision(new CollisionComponent(x,y,entity.physical.size),o.collision)){return true}}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}return false}},{key:"directionToPosition",value:function directionToPosition(direction){switch(direction){case direction_up:return new PositionComponent(0,-1);break;case direction_right:return new PositionComponent(1,0);break;case direction_down:return new PositionComponent(0,1);break;case direction_left:return new PositionComponent(-1,0);break;}}},{key:"getPositionInFrontOf",value:function getPositionInFrontOf(entity){var dtp=Utility.directionToPosition(entity.direction.direction);return new PositionComponent(entity.position.x+dtp.x,entity.position.y+dtp.y)}},{key:"isMovementAction",value:function isMovementAction(action){return action>action_move&&action<=action_move_left}},{key:"isSprintAction",value:function isSprintAction(action){return action>action_sprint&&action<=action_sprint_left}},{key:"convertMovementToSprint",value:function convertMovementToSprint(action){switch(action){case action_move_up:return action_sprint_up;break;case action_move_right:return action_sprint_right;break;case action_move_down:return action_sprint_down;break;case action_move_left:return action_sprint_left;break;}}},{key:"convertSprintToMovement",value:function convertSprintToMovement(action){switch(action){case action_sprint_up:return action_move_up;break;case action_sprint_right:return action_move_right;break;case action_sprint_down:return action_move_down;break;case action_sprint_left:return action_move_left;break;}}},{key:"convertAnimationsFromConfig",value:function convertAnimationsFromConfig(animations){var animationsArray=[];for(var a in animations){animationsArray[animation_strings_to_constants[a]]=animations[a]}return animationsArray}},{key:"convertActionsFromConfig",value:function convertActionsFromConfig(actions){var actionsArray=[];for(var i=0;i<actions.length;i++){actionsArray[i]=action_strings_to_constants[actions[i]]}return actionsArray}},{key:"getSquareCode",value:function getSquareCode(x,y,size){return x+y*size}},{key:"getSquareFromCode",value:function getSquareFromCode(map,code){return map[code%map.length][floor(code/map.length)]}}]);return Utility}();var LARGE_VALUE=2147483647;function findPath(board,start,end){var searched=[];var searching=[];var cameFrom={};var distFromStart={};var finalCost={};for(var i=0;i<board.length;i++){for(var j=0;j<board[0].length;j++){distFromStart[board[i][j]]=LARGE_VALUE;finalCost[board[i][j]]=LARGE_VALUE}}searching.push(start);distFromStart[start]=0;finalCost[start]=squareDistance(start,end);cameFrom[Utility.getSquareCode(start.position.x,start.position.y)]=-1;while(searching.length>0){var current=searching[0];var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=searching[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var s=_step2.value;if(finalCost[s]<finalCost[current])current=s}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}if(current==end){return makePath(board,cameFrom,current)};searching.splice(searching.indexOf(current),1);searched.push(current);var currentNeighbors=getNeighbors(board,current);var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=currentNeighbors[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var n=_step3.value;if(searched.includes(n)){continue}else{var estimatedDistFromStart=distFromStart[current]+1;if(!searching.includes(n)){searching.push(n)}else if(estimatedDistFromStart>=distFromStart[n]){continue}cameFrom[Utility.getSquareCode(n.position.x,n.position.y)]=Utility.getSquareCode(current.position.x,current.position.y);distFromStart[n]=estimatedDistFromStart;finalCost[n]=distFromStart[n]+squareDistance(start,end)}}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}}return false}function squareDistance(start,end){return abs(start.position.x-end.position.x)+abs(start.position.y-end.position.y)}function makePath(board,cameFrom,last){var path=[];var current=Utility.getSquareCode(last.position.x,last.position.y);while(cameFrom[current]>0){path.unshift(Utility.getSquareFromCode(board,current));current=cameFrom[current]}path.unshift(Utility.getSquareFromCode(board,current));return path}var PATHFINDING=-1;function getNeighbors(board,square){neighbors=[];if(square.position.x>0&&walkable(entity_mob,board[square.position.x-1][square.position.y])){neighbors.push(board[square.position.x-1][square.position.y])}if(square.position.y>0&&walkable(entity_mob,board[square.position.x][square.position.y-1])){neighbors.push(board[square.position.x][square.position.y-1])}if(square.position.x<board.length-1&&walkable(entity_mob,board[square.position.x+1][square.position.y])){neighbors.push(board[square.position.x+1][square.position.y])}if(square.position.y<board.length-1&&walkable(entity_mob,board[square.position.x][square.position.y+1])){neighbors.push(board[square.position.x][square.position.y+1])}return neighbors}function walkable(e,i){return true}function direction(start,target){if(abs(start[0]-target[0])>=abs(start[1]-target[1])){if(start[0]<target[0])return RIGHT;else if(start[0]>target[0])return LEFT}else{if(start[1]<target[1])return DOWN;else if(start[1]>target[1])return UP}}function dirToSquare(start,target){if(start.position.x>target.position.x){return LEFT}else if(start.position.y>target.position.y){return UP}else if(start.position.x<target.position.x){return RIGHT}else if(start.position.y<target.position.y){return DOWN}else{throw new Error("Cannot determine direction from square"+start+" to "+target)}}
"use strict";function setup(){createCanvas(windowWidth,windowHeight);load()}function load(){var config=loadConfig();var room_pool=loadRoomPools();var images=loadImages();var player_data=loadPlayerData();var entity_data=loadEntityData();var music=loadMusic();var sounds=loadSounds();var data={"config":config,"room_pool":room_pool[0],"stair_room_pool":room_pool[1],"images":images,"player_data":player_data,"entity_data":entity_data,"music":music,"sounds":sounds};var e=new PoppsEngine(data)}function loadConfig(){return loadJSON("/config/config.json")}function loadRoomPools(){return loadJSON("/config/roompool.json")}function loadImages(){var images=[];images.TEXTURES=[];images.TEXTURES[texture_floor]=loadImage("/img/textures/floor0.jpg");images.TEXTURES[texture_wall]=loadImage("/img/textures/wall0.jpg");images.TEXTURES[texture_door_open]=loadImage("/img/textures/doorOpen.png");images.TEXTURES[texture_door_closed]=loadImage("/img/textures/doorClosed.jpg");images.TEXTURES[texture_loot_open]=loadImage("/img/textures/lootOpen.png");images.TEXTURES[texture_loot_closed]=loadImage("/img/textures/lootClosed.png");images.TEXTURES[texture_stair_up]=loadImage("/img/textures/stairUp.png");images.TEXTURES[texture_stair_down]=loadImage("/img/textures/stairDown.png");images.UI=[];images.UI[HEART]=loadImage("/img/icons/heart.png");return images}function loadPlayerData(){return loadJSON("/data/player_data.json")}function loadEntityData(){return loadJSON("/data/entity_data.json")}function loadMusic(){var music=[];music.push(loadAudio("/audio/music/001_0100.wav"));music.push(loadAudio("/audio/music/002_0001.wav"));music.push(loadAudio("/audio/music/003_0101.wav"));music.push(loadAudio("/audio/music/004_1101.wav"));music.push(loadAudio("/audio/music/005_1121.wav"));music.push(loadAudio("/audio/music/006_2121.wav"));music.push(loadAudio("/audio/music/007_0200.wav"));music.push(loadAudio("/audio/music/008_0201.wav"));music.push(loadAudio("/audio/music/009_1201.wav"));music.push(loadAudio("/audio/music/010_1221.wav"));return music}function loadSounds(){}function keyDown(){}function keyUp(){}
"use strict";function PositionComponent(x,y){this.x=x;this.y=y}function HealthComponent(initialHealth){this.maxHealth=initialHealth;this.health=initialHealth}function StrengthComponent(initialStrength){this.strength=initialStrength}function IntelligenceComponent(initialIntelligence){this.intelligence=initialIntelligence}function MagicComponent(initialMagic){this.magic=initialMagic}function CombatComponent(strength,magic,intelligence){this.meleeAttackPower=strength;this.meleeDefensePower=floor(strength/5);this.magicAttackPower=magic*intelligence/2;this.magicDefensePower=strength*magic/8}function DirectionComponent(direction){this.direction=direction}function PhysicalComponent(solid,size){this.solid=solid;this.size=size}function CollisionComponent(top,right,bottom,left){if(left===undefined){this.top=right;this.right=top+bottom;this.bottom=right+bottom;this.left=top}else{this.top=top;this.right=right;this.bottom=bottom;this.left=left}}function MovementComponent(speed){this.speed=speed}function DisplayComponent(texture,width,height,opaque){this.texture=texture;this.width=width;this.height=height;this.visible=false;this.discovered=0;this.opaque=opaque}function LightComponent(){this.lightLevel=0}function AnimationComponent(animations){this.offsetX=0;this.offsetY=0;this.stage=0;this.sprite=undefined;this.animation=animation_idle;this.animations=animations}function ActionComponent(actions,speed){this.busy=0;this.speed=speed;this.availible=actions;this.nextAction=action_none;this.currentAction=action_none;this.lastAction=action_none;this.lastActionFailed=false}function SprintComponent(movesBeforeSprinting){this.movesBeforeSprinting=movesBeforeSprinting;this.sprintCounter=0;this.sprinting=false}function MapComponent(map){this.map=map}function DepthComponent(depth){this.depth=depth}function StairComponent(x,y){this.x=x;this.y=y}function AIComponent(actions,minRange,maxRange){this.actions=actions;this.minRange=minRange;this.maxRange=maxRange}
"use strict";function Entity(x,y,initialDepth,initialHealth,initialStrength,initialMagic,initialIntelligence,size,speed,actions,animations){this.components=[component_position,component_depth,component_health,component_strength,component_magic,component_intelligence,component_direction,component_physical,component_display,component_actions,component_animation,component_combat];this.position=new PositionComponent(x,y);this.depth=new DepthComponent(initialDepth);this.direction=new DirectionComponent(direction_down);this.physical=new PhysicalComponent(physical_solid,size);this.health=new HealthComponent(initialHealth);this.strength=new StrengthComponent(initialStrength);this.magic=new MagicComponent(initialMagic);this.intelligence=new IntelligenceComponent(initialIntelligence);this.combat=new CombatComponent(initialStrength,initialMagic,initialIntelligence);this.display=new DisplayComponent(undefined,size,size,display_transparent);this.animation=new AnimationComponent(animations);this.actions=new ActionComponent(actions,speed)}
"use strict";Mob.prototype=Object.create(Entity.prototype);function Mob(x,y,depth,config,actions,animations){Entity.call(this,x,y,depth,config.health,config.strength,config.magic,config.intelligence,config.size,config.speed,actions,animations);if(config.solid){this.collision=new CollisionComponent(x,y,config.size)}this.components.push(component_ai);this.ai=new AIComponent(actions,config.min_range,config.max_range)}
"use strict";Player.prototype=Object.create(Entity.prototype);function Player(x,y,config,playerClass,actions,animations){Entity.call(this,x,y,0,playerClass.health,playerClass.strength,playerClass.magic,playerClass.intelligence,config.size,config.speed,actions,animations);this.collision=new CollisionComponent(x,y,config.size);this.components.push(component_sprint);this.sprint=new SprintComponent(config.sprint_threshhold)}
"use strict";function Item(){}
"use strict";function generateLevel(CONFIG,depth,ROOM_POOL,STAIR_ROOM_POOL){var startTime=millis();var level=void 0;var rooms=[];var stairUp={x:0,y:0,sector:0};var stairDown={x:0,y:0,sector:0};level=initLevel(CONFIG.DUNGEON_SIZE);rooms.push(generateStairUpRoom(stairUp,CONFIG.DUNGEON_SIZE,STAIR_ROOM_POOL));rooms.push(generateStairDownRoom(stairUp,stairDown,CONFIG.DUNGEON_SIZE,STAIR_ROOM_POOL));generateOtherRooms(level,rooms,CONFIG.DUNGEON_SIZE,CONFIG.ROOM_TRIES,ROOM_POOL);placeRoomsOnLevel(level,rooms);markNodeSquares(level);connectRooms(level,rooms,CONFIG.DUNGEON_SIZE);finalizeLevel(level,stairUp,stairDown);return new Level(level,stairUp,stairDown,depth)}function initLevel(size){var level=new Array(size);for(var i=0;i<size;i++){level[i]=new Array(size);for(var j=0;j<size;j++){level[i][j]=WALL}}return level}function generateStairUpRoom(stairUp,size,STAIR_ROOM_POOL){stairUp.sector=randomInt(8);sectorToCoordinates(stairUp,size);return new Room(random(STAIR_ROOM_POOL),stairUp.x,stairUp.y)}function generateStairDownRoom(stairUp,stairDown,size,STAIR_ROOM_POOL){stairDown.sector=(stairUp.sector+4)%8;sectorToCoordinates(stairDown,size);return new Room(random(STAIR_ROOM_POOL),stairDown.x,stairDown.y)}function sectorToCoordinates(stair,size){switch(stair.sector){case 0:stair.x=floor(size/4);stair.y=floor(size/4);break;case 1:stair.x=2*floor(size/4);stair.y=floor(size/4);break;case 2:stair.x=3*floor(size/4);stair.y=floor(size/4);break;case 3:stair.x=3*floor(size/4);stair.y=2*floor(size/4);break;case 4:stair.x=3*floor(size/4);stair.y=3*floor(size/4);break;case 5:stair.x=2*floor(size/4);stair.y=3*floor(size/4);break;case 6:stair.x=floor(size/4);stair.y=3*floor(size/4);break;case 7:stair.x=floor(size/4);stair.y=2*floor(size/4);break;}}function generateOtherRooms(level,rooms,size,ROOM_TRIES,ROOM_POOL){for(var i=0;i<ROOM_TRIES;i++){tryRoom(level,rooms,size,ROOM_POOL)}}function tryRoom(level,rooms,size,ROOM_POOL){var newRoom=new Room(random(ROOM_POOL),randomInt(size),randomInt(size));if(isValidRoom(rooms,newRoom,size))rooms.push(newRoom)}function isValidRoom(rooms,newRoom,size){if(newRoom.left<0||newRoom.top<0||newRoom.right>size||newRoom.bottom>size)return false;var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=rooms[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var r=_step.value;if(roomsCollide(r,newRoom))return false}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}return true}function roomsCollide(r1,r2){return!(r1.left>r2.right||r1.top>r2.bottom||r1.right<r2.left||r1.bottom<r2.top)}function placeRoomsOnLevel(level,rooms){var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=rooms[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var r=_step2.value;for(var i=0;i<r.width;i++){for(var j=0;j<r.height;j++){level[i+r.left][j+r.top]=r.squares[i][j]}}}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}}function markNodeSquares(level){for(var i=1;i<level.length-1;i+=2){for(var j=1;j<level.length-1;j+=2){if(level[i][j]==WALL)level[i][j]=new Node(i,j,false)}}}function connectRooms(level,rooms,size){var connected=[rooms[0]];var connectedDoors=rooms[0].doors;while(connected.length<rooms.length){var closestRoom=void 0;var closestDistance=void 0;var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=rooms[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var r=_step3.value;if(!connected.includes(r)){closestRoom=r;closestDistance=10000}}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=connected[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var c=_step4.value;var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=rooms[Symbol.iterator](),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var _r=_step5.value;if(connected.includes(_r))continue;else{var currentDistance=roomDistance(c,_r);if(currentDistance<closestDistance){closestRoom=_r;closestDistance=currentDistance}}}}catch(err){_didIteratorError5=true;_iteratorError5=err}finally{try{if(!_iteratorNormalCompletion5&&_iterator5.return){_iterator5.return()}}finally{if(_didIteratorError5){throw _iteratorError5}}}}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return()}}finally{if(_didIteratorError4){throw _iteratorError4}}}connectRoom(level,connected,closestRoom,connectedDoors)}}function roomDistance(r1,r2){return abs(r1.x-r2.x)+abs(r1.y-r2.y)}function connectRoom(level,connected,room,connectedDoors){var roomDoors=room.doors;var closestDoors=[connectedDoors[0],roomDoors[0]];var closestDistance=10000;var adjacent=false;var success=false;var _iteratorNormalCompletion6=true;var _didIteratorError6=false;var _iteratorError6=undefined;try{for(var _iterator6=roomDoors[Symbol.iterator](),_step6;!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=true){var rd=_step6.value;if(includesDoor(connectedDoors,rd)){closestDoors[0]=rd;adjacent=true;success=true;break}else{var _iteratorNormalCompletion8=true;var _didIteratorError8=false;var _iteratorError8=undefined;try{for(var _iterator8=connectedDoors[Symbol.iterator](),_step8;!(_iteratorNormalCompletion8=(_step8=_iterator8.next()).done);_iteratorNormalCompletion8=true){var cd=_step8.value;var currentDistance=doorDistance(rd,cd);if(currentDistance<closestDistance){closestDoors=[cd,rd];closestDistance=currentDistance}}}catch(err){_didIteratorError8=true;_iteratorError8=err}finally{try{if(!_iteratorNormalCompletion8&&_iterator8.return){_iterator8.return()}}finally{if(_didIteratorError8){throw _iteratorError8}}}}}}catch(err){_didIteratorError6=true;_iteratorError6=err}finally{try{if(!_iteratorNormalCompletion6&&_iterator6.return){_iterator6.return()}}finally{if(_didIteratorError6){throw _iteratorError6}}}if(!adjacent){success=makePathBetweenDoors(level,closestDoors[0],closestDoors[1],connectedDoors)}if(success){if(adjacent){level[closestDoors[0][0]][closestDoors[0][1]]=DOOR}else{level[closestDoors[0][0]][closestDoors[0][1]]=DOOR;level[closestDoors[1][0]][closestDoors[1][1]]=DOOR}var _iteratorNormalCompletion7=true;var _didIteratorError7=false;var _iteratorError7=undefined;try{for(var _iterator7=roomDoors[Symbol.iterator](),_step7;!(_iteratorNormalCompletion7=(_step7=_iterator7.next()).done);_iteratorNormalCompletion7=true){var _rd=_step7.value;if(!includesDoor(connectedDoors,_rd)){connectedDoors.push(_rd)}}}catch(err){_didIteratorError7=true;_iteratorError7=err}finally{try{if(!_iteratorNormalCompletion7&&_iterator7.return){_iterator7.return()}}finally{if(_didIteratorError7){throw _iteratorError7}}}connected.push(room)}else{connectedDoors.splice(connectedDoors.indexOf(closestDoors[0]),1);room.doors.splice(room.doors.indexOf(closestDoors[1]),1);connectRoom(level,connected,room,connectedDoors)}}function includesDoor(doorArray,door){var _iteratorNormalCompletion9=true;var _didIteratorError9=false;var _iteratorError9=undefined;try{for(var _iterator9=doorArray[Symbol.iterator](),_step9;!(_iteratorNormalCompletion9=(_step9=_iterator9.next()).done);_iteratorNormalCompletion9=true){var d=_step9.value;if(door[0]==d[0]&&door[1]==d[1])return true}}catch(err){_didIteratorError9=true;_iteratorError9=err}finally{try{if(!_iteratorNormalCompletion9&&_iterator9.return){_iterator9.return()}}finally{if(_didIteratorError9){throw _iteratorError9}}}return false}function doorDistance(d1,d2){return(d1[0]-d2[0])*(d1[0]-d2[0])+(d1[1]-d2[1])*(d1[1]-d2[1])}function makePathBetweenDoors(level,door1,door2,connectedDoors){var searched=[];var searching=[];var distFromStart={};var finalCost={};for(var i=0;i<level.length;i++){for(var j=0;j<level[0].length;j++){distFromStart[level[i][j]]=LARGE_VALUE;finalCost[level[i][j]]=LARGE_VALUE}}var start=getAdjacentNode(level,door1);var end=getAdjacentNode(level,door2);if(start==undefined||end==undefined)return false;searching.push(start);distFromStart[start]=0;finalCost[start]=nodeDistance(start,end);start.cameFrom=undefined;while(searching.length>0){var current=searching[0];var _iteratorNormalCompletion10=true;var _didIteratorError10=false;var _iteratorError10=undefined;try{for(var _iterator10=searching[Symbol.iterator](),_step10;!(_iteratorNormalCompletion10=(_step10=_iterator10.next()).done);_iteratorNormalCompletion10=true){var s=_step10.value;if(finalCost[s]<finalCost[current])current=s}}catch(err){_didIteratorError10=true;_iteratorError10=err}finally{try{if(!_iteratorNormalCompletion10&&_iterator10.return){_iterator10.return()}}finally{if(_didIteratorError10){throw _iteratorError10}}}if(current==end){drawNodePath(level,current,connectedDoors);return true};searching.splice(searching.indexOf(current),1);searched.push(current);var currentNeighbors=getSurroundingNodes(level,current);var _iteratorNormalCompletion11=true;var _didIteratorError11=false;var _iteratorError11=undefined;try{for(var _iterator11=currentNeighbors[Symbol.iterator](),_step11;!(_iteratorNormalCompletion11=(_step11=_iterator11.next()).done);_iteratorNormalCompletion11=true){var n=_step11.value;if(searched.includes(n)){continue}else{var estimatedDistFromStart=distFromStart[current]+1;if(!searching.includes(n)){searching.push(n)}else if(estimatedDistFromStart>=distFromStart[n]){continue}n.cameFrom=current;distFromStart[n]=estimatedDistFromStart;finalCost[n]=distFromStart[n]+nodeDistance(start,end)}}}catch(err){_didIteratorError11=true;_iteratorError11=err}finally{try{if(!_iteratorNormalCompletion11&&_iterator11.return){_iterator11.return()}}finally{if(_didIteratorError11){throw _iteratorError11}}}}return false}function getAdjacentNode(level,door){if(door[0]%2==1&&door[1]%2==1)return level[door[0]][door[1]];if(door[0]>1&&level[door[0]-1][door[1]]instanceof Node)return level[door[0]-1][door[1]];if(door[1]>1&&level[door[0]][door[1]-1]instanceof Node)return level[door[0]][door[1]-1];if(door[0]<level.length-2&&level[door[0]+1][door[1]]instanceof Node)return level[door[0]+1][door[1]];if(door[1]<level.length-2&&level[door[0]][door[1]+1]instanceof Node)return level[door[0]][door[1]+1]}function nodeDistance(start,end){return abs(start.x-end.x)+abs(start.y-end.y)}function getSurroundingNodes(level,node){var neighbors=[];if(node.x>1&&level[node.x-2][node.y]instanceof Node)neighbors.push(level[node.x-2][node.y]);if(node.y>1&&level[node.x][node.y-2]instanceof Node)neighbors.push(level[node.x][node.y-2]);if(node.x<level.length-2&&level[node.x+2][node.y]instanceof Node)neighbors.push(level[node.x+2][node.y]);if(node.y<level.length-2&&level[node.x][node.y+2]instanceof Node)neighbors.push(level[node.x][node.y+2]);return neighbors}function drawNodePath(level,node){level[node.x][node.y].connected=true;while(node.cameFrom!=undefined){fillBetweenNodes(level,node,node.cameFrom);node=node.cameFrom;level[node.x][node.y].connected=true}}function fillBetweenNodes(level,node1,node2){level[node1.x+(node2.x-node1.x)/2][node1.y+(node2.y-node1.y)/2]=FLOOR}function finalizeLevel(level,stairUp,stairDown){level[stairUp.x][stairUp.y]=STAIR_UP;level[stairDown.x][stairDown.y]=STAIR_DOWN;for(var i=0;i<level.length;i++){for(var j=0;j<level.length;j++){if(level[i][j]instanceof Node){if(level[i][j].connected){level[i][j]=FLOOR}else{level[i][j]=WALL}}switch(level[i][j]){case FLOOR:level[i][j]=new FloorSquare(i,j);break;case WALL:level[i][j]=new WallSquare(i,j);break;case DOOR:level[i][j]=new DoorSquare(i,j);break;case STAIR_UP:level[i][j]=new StairUpSquare(i,j);break;case STAIR_DOWN:level[i][j]=new StairDownSquare(i,j);break;case LOOT:level[i][j]=new LootSquare(i,j);break;default:console.log("Not recognized squaretype: "+level[i][j]);level[i][j]=new Square(i,j,level[i][j]);break;}}}}function Node(x,y,connected){this.x=x;this.y=y;this.connected=connected}
"use strict";function Room(template,x,y){this.width=template.width;this.height=template.height;this.left=x-floor(this.width/2);this.top=y-floor(this.height/2);this.left+=this.left%2-1;this.top+=this.top%2-1;this.right=this.left+this.width;this.bottom=this.top+this.height;this.x=this.left+ceil(this.width/2);this.y=this.top+ceil(this.height/2);this.squares=template.squares.slice(0);this.doors=new Array(template.doors.length);for(var i=0;i<this.doors.length;i++){this.doors[i]=[template.doors[i][0]+this.left,template.doors[i][1]+this.top]}}
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var AISystem=function(_System){_inherits(AISystem,_System);function AISystem(){_classCallCheck(this,AISystem);var _this=_possibleConstructorReturn(this,(AISystem.__proto__||Object.getPrototypeOf(AISystem)).call(this,[component_ai]));_this.player;return _this}_createClass(AISystem,[{key:"run",value:function run(engine){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var entity=_step.value;if(Utility.entityDistance(entity,this.player)<entity_active_range){entity.actions.nextAction=this.determineAction(entity,this.player)}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){}},{key:"addObject",value:function addObject(object){if(object instanceof Player){this.player=object}else{_get(AISystem.prototype.__proto__||Object.getPrototypeOf(AISystem.prototype),"addObject",this).call(this,object)}}},{key:"determineAction",value:function determineAction(entity,player){if(Utility.entityDistance(entity,player)<entity.ai.maxRange){return this.getAttackAction(entity,player)}else{return this.getMoveCloserAction(entity,player)}}},{key:"getAttackAction",value:function getAttackAction(entity,player){var dir=Utility.getDirectionToEntity(entity,player);entity.direction.direction=dir;return direction_to_attack[dir]}},{key:"getMoveCloserAction",value:function getMoveCloserAction(entity,player){return direction_to_movement[Utility.getDirectionToEntity(entity,player)]}}]);return AISystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var ActionSystem=function(_System){_inherits(ActionSystem,_System);function ActionSystem(){_classCallCheck(this,ActionSystem);return _possibleConstructorReturn(this,(ActionSystem.__proto__||Object.getPrototypeOf(ActionSystem)).call(this,[component_actions]))}_createClass(ActionSystem,[{key:"run",value:function run(engine){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var entity=_step.value;if(entity.actions.busy>0){entity.actions.busy-=entity.actions.speed}else{this.setCurrentAction(entity,engine)}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_successful_action:this.handleSuccessfulAction(data.entity,engine);break;case event_failed_action:this.handleFailedAction(data.entity,engine);break;}}},{key:"setCurrentAction",value:function setCurrentAction(entity,engine){entity.actions.currentAction=entity.actions.nextAction;entity.actions.nextAction=action_none}},{key:"handleSuccessfulAction",value:function handleSuccessfulAction(entity,engine){entity.actions.busy=action_to_length[entity.actions.currentAction];if(entity.components.includes(component_sprint)){this.handleSprinting(entity,engine)}entity.animation.animation=action_to_animation[entity.actions.currentAction];engine.sendEvent(event_new_animation,entity);entity.actions.lastAction=entity.actions.currentAction;entity.actions.currentAction=action_none}},{key:"handleFailedAction",value:function handleFailedAction(entity,engine){entity.actions.busy=1;entity.actions.lastActionFailed=true;entity.actions.lastAction=entity.actions.currentAction;entity.actions.currentAction=action_none}},{key:"handleSprinting",value:function handleSprinting(entity,engine){if(entity.sprint.sprinting){entity.actions.busy=action_to_length[action_sprint]}}}]);return ActionSystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var AnimationSystem=function(_System){_inherits(AnimationSystem,_System);function AnimationSystem(config){_classCallCheck(this,AnimationSystem);var _this=_possibleConstructorReturn(this,(AnimationSystem.__proto__||Object.getPrototypeOf(AnimationSystem)).call(this,[component_animation]));_this.config=config;_this.animationCounter=0;_this.idleAnimationCounter=0;return _this}_createClass(AnimationSystem,[{key:"run",value:function run(engine){if(this.animationCounter==this.config.ANIMATION_SPEED){this.animationCounter=0;if(this.idleAnimationCounter==this.config.IDLE_ANIMATION_SLOW_FACTOR){this.idleAnimationCounter=0}var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var o=_step.value;o.animation.stage++;if(o.animation.stage==o.animation.animations[o.animation.animation].length){this.startIdleAnimation(o)}this.updateAnimation(o)}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}this.idleAnimationCounter++}this.animationCounter++}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_new_animation:this.startAnimation(data);break;}}},{key:"startIdleAnimation",value:function startIdleAnimation(entity){entity.animation.animation=animation_idle;entity.animation.stage=0;this.updateAnimation(entity)}},{key:"updateAnimation",value:function updateAnimation(entity){entity.animation.offsetX=entity.animation.animations[entity.animation.animation][entity.animation.stage].ox;entity.animation.offsetY=entity.animation.animations[entity.animation.animation][entity.animation.stage].oy;entity.animation.sprite=entity.animation.animations[entity.animation.animation][entity.animation.stage].sprite}},{key:"startAnimation",value:function startAnimation(object){object.animation.stage=0;this.updateAnimation(object)}}]);return AnimationSystem}(System);
"use strict";function AudioManager(){var mm=new MusicManager;var sounds=[]}
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var CombatSystem=function(_System){_inherits(CombatSystem,_System);function CombatSystem(){_classCallCheck(this,CombatSystem);var _this=_possibleConstructorReturn(this,(CombatSystem.__proto__||Object.getPrototypeOf(CombatSystem)).call(this,[component_combat]));_this.player;_this.inCombat=false;_this.combatTimer=0;_this.combatTimerMax=30;return _this}_createClass(CombatSystem,[{key:"run",value:function run(engine){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var entity=_step.value;switch(entity.actions.currentAction){case action_melee_attack:this.determineAttackDirection(entity,this.objects);this.meleeAttack(engine,entity,this.objects);break;case action_melee_attack_up:case action_melee_attack_right:case action_melee_attack_down:case action_melee_attack_left:this.meleeAttack(engine,entity,this.objects);break;case action_spin_attack:this.spinAttack(engine,entity,this.objects);break;}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}if(this.inCombat){if(!this.checkInCombat(this.player,this.objects)){this.combatTimer--;if(this.combatTimer==0){this.endCombat(engine)}}else{this.resetCombatTimer()}}else{if(this.checkInCombat(this.player,this.objects)){this.beginCombat(engine)}}}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){}}},{key:"addObject",value:function addObject(object){if(object instanceof Player){this.player=object}_get(CombatSystem.prototype.__proto__||Object.getPrototypeOf(CombatSystem.prototype),"addObject",this).call(this,object)}},{key:"resetCombatTimer",value:function resetCombatTimer(){this.combatTimer=this.combatTimerMax}},{key:"beginCombat",value:function beginCombat(engine){if(!this.inCombat){engine.sendEvent(event_begin_combat);this.resetCombatTimer();this.inCombat=true}}},{key:"endCombat",value:function endCombat(engine){if(this.inCombat){engine.sendEvent(event_end_combat);this.inCombat=false}}},{key:"checkInCombat",value:function checkInCombat(player,objects){var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=objects[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var o=_step2.value;if(o instanceof Mob&&o.display.visible){return true}}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}return false}},{key:"determineAttackDirection",value:function determineAttackDirection(entity,objects){var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=objects[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var o=_step3.value;var dir=Utility.entityAdjacent(entity,o);if(dir!=-1){entity.direction.direction=dir;entity.actions.currentAction=direction_to_attack[dir]}}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}}},{key:"meleeAttack",value:function meleeAttack(engine,entity,objects){var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=objects[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var o=_step4.value;if(entity!=o){var target=Utility.getPositionInFrontOf(entity);if(Utility.collision(new CollisionComponent(target.x,target.y,entity.physical.size),o.collision)){var healthLost=max(0,entity.combat.meleeAttackPower*1.5-o.combat.meleeDefensePower);if(entity instanceof Player){engine.sendEvent(event_player_melee_attack)}engine.sendEvent(event_entity_take_damage,{"object":o,"healthLost":healthLost});engine.sendEvent(event_successful_action,{"action":entity.actions.currentAction,"entity":entity});this.beginCombat(engine);return}}}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return()}}finally{if(_didIteratorError4){throw _iteratorError4}}}}},{key:"spinAttack",value:function spinAttack(engine,entity,objects){var targets=[];var _iteratorNormalCompletion5=true;var _didIteratorError5=false;var _iteratorError5=undefined;try{for(var _iterator5=objects[Symbol.iterator](),_step5;!(_iteratorNormalCompletion5=(_step5=_iterator5.next()).done);_iteratorNormalCompletion5=true){var o=_step5.value;if(entity!=o&&this.entityAround(entity,o)){targets.push(o)}}}catch(err){_didIteratorError5=true;_iteratorError5=err}finally{try{if(!_iteratorNormalCompletion5&&_iterator5.return){_iterator5.return()}}finally{if(_didIteratorError5){throw _iteratorError5}}}if(targets.length>0){var _iteratorNormalCompletion6=true;var _didIteratorError6=false;var _iteratorError6=undefined;try{for(var _iterator6=targets[Symbol.iterator](),_step6;!(_iteratorNormalCompletion6=(_step6=_iterator6.next()).done);_iteratorNormalCompletion6=true){var _o=_step6.value;var healthLost=max(0,entity.combat.meleeAttackPower-_o.combat.meleeDefensePower);engine.sendEvent(event_entity_take_damage,{"object":_o,"healthLost":healthLost})}}catch(err){_didIteratorError6=true;_iteratorError6=err}finally{try{if(!_iteratorNormalCompletion6&&_iterator6.return){_iterator6.return()}}finally{if(_didIteratorError6){throw _iteratorError6}}}if(entity instanceof Player){engine.sendEvent(event_player_spin_attack)}engine.sendEvent(event_successful_action,{"action":entity.actions.currentAction,"entity":entity});this.beginCombat(engine)}}},{key:"entityAround",value:function entityAround(entity,otherEntity){return Utility.collision(new CollisionComponent(entity.position.x-1,entity.position.y-1,3),otherEntity.collision)}}]);return CombatSystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var DisplaySystem=function(_System){_inherits(DisplaySystem,_System);function DisplaySystem(config,images){_classCallCheck(this,DisplaySystem);var _this=_possibleConstructorReturn(this,(DisplaySystem.__proto__||Object.getPrototypeOf(DisplaySystem)).call(this,[component_position,component_display]));_this.config=config;_this.textures=images.TEXTURES;_this.ui=images.UI;_this.camera={x:0,y:0,shakeOffsetX:0,shakeOffsetY:0,combat:false,sprinting:false,zoom:_this.config.CAMERA_DEFAULT_ZOOM};_this.player;_this.cameraZoomTimer=undefined;_this.cameraShakeTimer=undefined;_this.cameraMoving=false;_this.lightOffset=0;_this.lightOffsetScale=.02;_this.lightOffsetSpeed=600;_this.centerX=floor(width/2);_this.centerY=floor(height/2);_this.gridSize=_this.config.GRID_SIZE;_this.halfGridSize=_this.gridSize/2;return _this}_createClass(DisplaySystem,[{key:"run",value:function run(engine){background(0);this.drawTextures(this.objects);this.drawLights(this.objects);this.drawHealth(this.objects);if(this.cameraMoving){if(this.player.animation.animation==animation_idle){this.cameraMoving=false}this.centerCamera(this.camera,this.player.position,this.player.animation.offsetX,this.player.animation.offsetY)}}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_start_game:this.centerCamera(this.camera,this.player.position);break;case event_up_level:case event_down_level:case event_player_moved:this.cameraMoving=true;break;case event_window_resized:this.resize();break;case event_begin_combat:this.camera.combat=true;this.decideCameraZoomState(this.camera);break;case event_end_combat:this.camera.combat=false;this.decideCameraZoomState(this.camera);break;case event_player_start_sprinting:this.camera.sprinting=true;this.decideCameraZoomState(this.camera);break;case event_player_stop_sprinting:this.camera.sprinting=false;this.decideCameraZoomState(this.camera);break;case event_player_melee_attack:this.shakeCamera(this.camera,this.config.CAMERA_SHAKE_MEDIUM_SMALL);break;case event_player_spin_attack:this.shakeCamera(this.camera,this.config.CAMERA_SHAKE_SMALL);break;case event_player_take_damage:this.shakeCamera(this.camera,this.config.CAMERA_SHAKE_SMALL);break;}}},{key:"addObject",value:function addObject(object){if(object instanceof Player){this.player=object}_get(DisplaySystem.prototype.__proto__||Object.getPrototypeOf(DisplaySystem.prototype),"addObject",this).call(this,object)}},{key:"drawTextures",value:function drawTextures(objects){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var o=_step.value;if(o.display.visible||o.display.discovered>0){var x=this.centerX-this.camera.zoom*(this.gridSize*(this.camera.x-o.position.x))+this.camera.shakeOffsetX;var y=this.centerY-this.camera.zoom*(this.gridSize*(this.camera.y-o.position.y))+this.camera.shakeOffsetY;var w=o.display.width*this.gridSize*this.camera.zoom;var h=o.display.height*this.gridSize*this.camera.zoom;if(Utility.positionOnScreen(x,y,w,h)){this.drawTexture(o,x,y,w,h)}}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}}},{key:"drawTexture",value:function drawTexture(o,x,y,w,h){if(o.components.includes(component_animation)){x+=this.gridSize*o.animation.offsetX;y+=this.gridSize*o.animation.offsetY;var s=o.animation.sprite;if(s==undefined){if(o instanceof Player){fill(255)}else{fill(255,150,100)}rect(x+this.gridSize/8,y+this.gridSize/8,w-this.gridSize/4,h-this.gridSize/4)}else{image(a,x,y,w,h)}}else{var t=o.display.texture;if(t==undefined){fill(255,100,100);rect(x,y,w,h)}else if(t.length>1){var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=t[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var i=_step2.value;image(this.textures[i],x,y,w,h)}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}}else{image(this.textures[t],x,y,w,h)}if(!o.display.visible&&o.display.discovered>0){fill(5,10,0,.2);rect(x,y,w,h)}}}},{key:"drawLights",value:function drawLights(objects){var lightFill=light_fill_string+light_intensity+")";var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=objects[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var o=_step3.value;if(o.display.discovered&&o.components.includes(component_light)){canvas.fillStyle=lightFill;this.lightSquare(o)}}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}}},{key:"lightSquare",value:function lightSquare(o){var x=this.centerX-this.camera.zoom*(this.gridSize*(this.camera.x-o.position.x))+this.camera.shakeOffsetX;var y=this.centerY-this.camera.zoom*(this.gridSize*(this.camera.y-o.position.y))+this.camera.shakeOffsetY;var w=o.display.width*this.gridSize*this.camera.zoom;var h=o.display.height*this.gridSize*this.camera.zoom;rect(x,y,w,h);canvas.fillStyle=light_level_to_shadow[o.light.lightLevel];rect(x,y,w,h)}},{key:"drawHealth",value:function drawHealth(objects){var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=objects[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var o=_step4.value;if(o.components.includes(component_health)&&(o.display.visible||o.display.discovered>0)){var x=this.centerX-this.camera.zoom*(this.gridSize*(this.camera.x-o.position.x))+this.camera.shakeOffsetX;var y=this.centerY-this.camera.zoom*(this.gridSize*(this.camera.y-o.position.y))+this.camera.shakeOffsetY;var healthBarWidth=o.display.width*this.gridSize*this.camera.zoom;if(o instanceof Player){this.drawPlayerHealth(o)}else{this.drawMobHealth(o,x,y,healthBarWidth)}}}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return()}}finally{if(_didIteratorError4){throw _iteratorError4}}}}},{key:"drawPlayerHealth",value:function drawPlayerHealth(player){var HEART_SIZE=30;var HEART_OFFSET=20;var x=0,y=0;for(var i=1;i<=this.player.health.health;i++){image(this.ui[HEART],x*HEART_SIZE+HEART_OFFSET,y*HEART_SIZE+HEART_OFFSET,HEART_SIZE,HEART_SIZE);x++;if(i%15==0){y++;x=0}}}},{key:"drawMobHealth",value:function drawMobHealth(mob,x,y,healthBarWidth){var HEALTH_BAR_OFFSET=3;var HEALTH_BAR_HEIGHT=4;var xoff=this.gridSize*mob.animation.offsetX;var yoff=this.gridSize*mob.animation.offsetY;healthBarWidth=healthBarWidth-this.gridSize/4;fill(40,0,0);rect(xoff+x+this.gridSize/8,yoff+y-HEALTH_BAR_OFFSET,healthBarWidth,HEALTH_BAR_HEIGHT);healthBarWidth=healthBarWidth*Utility.getHealthPercent(mob);fill(50,220,120);rect(xoff+x+this.gridSize/8,yoff+y-HEALTH_BAR_OFFSET,healthBarWidth,HEALTH_BAR_HEIGHT)}},{key:"centerCamera",value:function centerCamera(camera,position){var offsetX=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var offsetY=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;camera.x=position.x+offsetX;camera.y=position.y+offsetY}},{key:"decideCameraZoomState",value:function decideCameraZoomState(camera){if(camera.combat){if(camera.sprinting){this.changeZoom(camera,this.config.CAMERA_ZOOM_STEPS_SLOW,this.config.CAMERA_COMBAT_ZOOM)}else{this.changeZoom(camera,this.config.CAMERA_ZOOM_STEPS_MEDIUM,this.config.CAMERA_COMBAT_ZOOM)}}else if(camera.sprinting){this.changeZoom(camera,this.config.CAMERA_ZOOM_STEPS_MEDIUM,this.config.CAMERA_SPRINT_ZOOM)}else{this.changeZoom(camera,this.config.CAMERA_ZOOM_STEPS_MEDIUM,this.config.CAMERA_DEFAULT_ZOOM)}}},{key:"changeZoom",value:function changeZoom(camera,steps,zoom){if(camera.zoom!=zoom){clearTimeout(this.cameraZoomTimer);this.recursiveZoom(camera,this.config.CAMERA_ZOOM_SPEED,zoom,(zoom-camera.zoom)/steps)}}},{key:"recursiveZoom",value:function recursiveZoom(camera,speed,zoom,dif){var self=this;if(dif<=0&&zoom-camera.zoom>=0){camera.zoom=zoom;return}else if(dif>0&&zoom-camera.zoom<=0){camera.zoom=zoom;return}else{camera.zoom+=dif;this.cameraZoomTimer=setTimeout(function(){self.recursiveZoom(camera,speed,zoom,dif)},speed)}}},{key:"shakeCamera",value:function shakeCamera(camera,shakeAmount){var self=this;clearTimeout(this.cameraShakeTimer);if(shakeAmount>0){camera.shakeOffestX=(shakeAmount%2==0?-1:1)*(randomInt(0,shakeAmount*this.config.CAMERA_SHAKE_MULTIPLIER)+this.config.CAMERA_SHAKE_CONSTANT);camera.shakeOffsetY=random(-1,1)*this.config.CAMERA_SHAKE_CONSTANT/2*shakeAmount;this.cameraShakeTimer=setTimeout(function(){self.shakeCamera(camera,shakeAmount-1)},this.config.CAMERA_SHAKE_SPEED)}else{camera.shakeOffsetX=0;camera.shakeOffsetY=0;this.cameraShakeTimer=undefined}}},{key:"resize",value:function resize(){resizeCanvas(window.innerWidth,window.innerHeight);this.centerX=floor(width/2);this.centerY=floor(height/2)}}]);return DisplaySystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var EntitySystem=function(_System){_inherits(EntitySystem,_System);function EntitySystem(player_data,entity_data){_classCallCheck(this,EntitySystem);var _this=_possibleConstructorReturn(this,(EntitySystem.__proto__||Object.getPrototypeOf(EntitySystem)).call(this,[component_actions]));_this.playerData=player_data;_this.entityData=entity_data;_this.entities=[];_this.levels=[];_this.depth=0;_this.player;return _this}_createClass(EntitySystem,[{key:"run",value:function run(engine){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var e=_step.value;if(e instanceof Mob){}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_first_level_initiated:this.generatePlayer(engine,this.levels[0].stairUp);this.generateEnemies(engine,this.depth);break;case event_new_level:this.generateEnemies(engine,this.depth+1);break;case event_up_level:this.depth--;this.updateEntities(engine);break;case event_down_level:this.depth++;this.updateEntities(engine);break;case event_spawn_enemy_close:var config=this.entityData[random(Object.keys(this.entityData))];this.generateEnemy(engine,this.player.position.x-randomInt(-4,4),this.player.position.y-randomInt(2,4),this.depth,config);break;}}},{key:"addObject",value:function addObject(object){if(object instanceof Level){this.levels.push(object)}else{_get(EntitySystem.prototype.__proto__||Object.getPrototypeOf(EntitySystem.prototype),"addObject",this).call(this,object)}}},{key:"removeObject",value:function removeObject(object){var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=this.entities[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var level=_step2.value;if(level.includes(object)){level.splice(level.indexOf(object),1)}}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}_get(EntitySystem.prototype.__proto__||Object.getPrototypeOf(EntitySystem.prototype),"removeObject",this).call(this,object)}},{key:"generatePlayer",value:function generatePlayer(engine,position){var animations=Utility.convertAnimationsFromConfig(this.playerData.animations);var actions=Utility.convertActionsFromConfig(this.playerData.actions);var config=this.playerData;var playerClass=this.playerData.classes.warrior;this.player=new Player(position.x,position.y,config,playerClass,actions,animations);engine.sendEvent(event_player_generated);engine.addObject(this.player)}},{key:"generateEnemies",value:function generateEnemies(engine,depth){var config=this.entityData[random(Object.keys(this.entityData))];this.entities[depth]=[];var numEntities=depth+7;while(numEntities>0){var entityPosition=this.findSafeSpawnLocation(config.size,this.entities[depth],this.levels[depth].map.map);if(entityPosition!=undefined){this.generateEnemy(engine,entityPosition.x,entityPosition.y,depth,config)}numEntities--}}},{key:"generateEnemy",value:function generateEnemy(engine,x,y,depth,config){var animations=Utility.convertAnimationsFromConfig(config.animations);var actions=Utility.convertActionsFromConfig(config.actions);if(this.safeSpawnLocation(x,y,config.size,this.entities[depth],this.levels[depth].map.map)){var mob=new Mob(x,y,depth,config,actions,animations);if(config.sprint_threshhold!==undefined){mob.components.push(component_sprint);mob.sprint=new SprintComponent(config.sprint_threshhold)}this.entities[depth].push(mob);engine.addObject(mob);engine.sendEvent(event_entity_spawned,mob);return true}return false}},{key:"findSafeSpawnLocation",value:function findSafeSpawnLocation(size,entities,map){var validSquares=[];for(var i=0;i<map.length;i++){for(var j=0;j<map[0].length;j++){if(this.safeSpawnLocation(i,j,size,entities,map)){validSquares.push(map[i][j].position)}}}return random(validSquares)}},{key:"safeSpawnLocation",value:function safeSpawnLocation(x,y,size,entities,map){for(var i=x;i<x+size;i++){for(var j=y;j<y+size;j++){if(map[i][j].physical.solid){return false}}}var col=new CollisionComponent(x,y,size);var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=entities[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var e=_step3.value;if(Utility.collision(col,e.collision)){return false}}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}return true}},{key:"updateEntities",value:function updateEntities(engine){var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=this.entities[this.depth][Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var e=_step4.value;engine.addObject(e)}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return()}}finally{if(_didIteratorError4){throw _iteratorError4}}}engine.addObject(this.player)}}]);return EntitySystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var HealthSystem=function(_System){_inherits(HealthSystem,_System);function HealthSystem(config){_classCallCheck(this,HealthSystem);var _this=_possibleConstructorReturn(this,(HealthSystem.__proto__||Object.getPrototypeOf(HealthSystem)).call(this,[component_health]));_this.config=config;_this.healthRegenCounter=0;_this.healthRegen=true;return _this}_createClass(HealthSystem,[{key:"run",value:function run(engine){if(this.healthRegen){if(this.healthRegenCounter%this.config.HEALTH_REGEN_TIMER==0){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var o=_step.value;if(o.health.health<o.health.maxHealth){o.health.health++}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}this.healthRegenCounter=1}this.healthRegenCounter++}}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_entity_take_damage:if(data.object instanceof Player){engine.sendEvent(event_player_take_damage)}this.applyDamage(engine,data.object,data.healthLost);break;case event_begin_combat:this.healthRegen=false;break;case event_end_combat:this.healthRegen=true;break;}}},{key:"applyDamage",value:function applyDamage(engine,object,healthLost){object.health.health-=healthLost;this.checkDead(engine,object)}},{key:"checkDead",value:function checkDead(engine,object){if(object.health.health<=0){engine.removeObject(object);if(object instanceof Player){engine.sendEvent(event_game_over)}}}}]);return HealthSystem}(System);
'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var InputSystem=function(_System){_inherits(InputSystem,_System);function InputSystem(){_classCallCheck(this,InputSystem);var _this=_possibleConstructorReturn(this,(InputSystem.__proto__||Object.getPrototypeOf(InputSystem)).call(this,[]));_this.player;_this.mobSpawnCooldown=0;return _this}_createClass(InputSystem,[{key:'run',value:function run(engine){if(keys.includes('n')&&this.mobSpawnCooldown<=0){this.mobSpawnCooldown=10;engine.sendEvent(event_spawn_enemy_close,this.player)}if(this.mobSpawnCooldown>0){this.mobSpawnCooldown--}this.player.actions.nextAction=this.determineAction()}},{key:'addObject',value:function addObject(object){if(object instanceof Player){this.player=object}}},{key:'determineAction',value:function determineAction(){var action=action_none;if(keys.length>0){var highestPriority=0;var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=keys[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var k=_step.value;var a=key_to_action[k];var priority=action_to_priority[a];priority=this.fixPriority(this.player,a,priority);if(priority>highestPriority){action=a;highestPriority=priority}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}}return action}},{key:'fixPriority',value:function fixPriority(player,a,priority){if(this.actionEqualsLastAction(player,a)){if(player.actions.lastActionFailed){return 0}else{return priority-1}}return priority}},{key:'actionEqualsLastAction',value:function actionEqualsLastAction(player,a){return player.actions.lastAction==a}}]);return InputSystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var LevelSystem=function(_System){_inherits(LevelSystem,_System);function LevelSystem(config,room_pool,stair_room_pool){_classCallCheck(this,LevelSystem);var _this=_possibleConstructorReturn(this,(LevelSystem.__proto__||Object.getPrototypeOf(LevelSystem)).call(this,[]));_this.config=config;_this.roomPool=room_pool;_this.stairRoomPool=stair_room_pool;_this.player;_this.depth=0;_this.levels=[];return _this}_createClass(LevelSystem,[{key:"run",value:function run(engine){}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_down_level:this.handleDownLevel(engine);break;case event_up_level:this.handleUpLevel(engine);break;case event_new_game:this.handleNewGame(engine);break;}}},{key:"addObject",value:function addObject(object){if(object instanceof Player){this.player=object}_get(LevelSystem.prototype.__proto__||Object.getPrototypeOf(LevelSystem.prototype),"addObject",this).call(this,object)}},{key:"handleNewGame",value:function handleNewGame(engine){this.newLevel(engine,0);this.updateLevel(engine);engine.sendEvent(event_first_level_initiated)}},{key:"newLevel",value:function newLevel(engine,depth){var level=generateLevel(this.config,depth,this.roomPool,this.stairRoomPool);this.levels.push(level);return level}},{key:"handleDownLevel",value:function handleDownLevel(engine){engine.clearObjects();this.depth++;if(this.depth==this.levels.length){this.newLevel(engine,this.depth);this.updateLevel(engine);engine.sendEvent(event_new_level)}else{this.updateLevel(engine)}this.fixPlayerPosition(this.levels[this.depth].stairUp)}},{key:"handleUpLevel",value:function handleUpLevel(engine){engine.clearObjects();if(this.depth>0){this.depth--;this.updateLevel(engine);this.fixPlayerPosition(this.levels[this.depth].stairDown)}}},{key:"updateLevel",value:function updateLevel(engine){var level=this.levels[this.depth];engine.addObject(level);for(var i=0;i<this.levels[this.depth].map.map.length;i++){for(var j=0;j<this.levels[this.depth].map.map.length;j++){engine.addObject(level.map.map[i][j])}}}},{key:"fixPlayerPosition",value:function fixPlayerPosition(stair){this.player.position.x=stair.x;this.player.position.y=stair.y}}]);return LevelSystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var MovementSystem=function(_System){_inherits(MovementSystem,_System);function MovementSystem(){_classCallCheck(this,MovementSystem);var _this=_possibleConstructorReturn(this,(MovementSystem.__proto__||Object.getPrototypeOf(MovementSystem)).call(this,[component_position,component_physical,component_actions]));_this.map;_this.depth=0;return _this}_createClass(MovementSystem,[{key:"run",value:function run(engine){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var o=_step.value;switch(o.actions.currentAction){case action_move_up:case action_move_right:case action_move_down:case action_move_left:this.move(engine,this.map,o,this.objects);break;}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}}},{key:"handleEvent",value:function handleEvent(engine,eventID){switch(eventID){case event_up_level:this.depth--;break;case event_down_level:this.depth++;break;}}},{key:"addObject",value:function addObject(object){if(object instanceof Level){this.map=object.map.map}else{_get(MovementSystem.prototype.__proto__||Object.getPrototypeOf(MovementSystem.prototype),"addObject",this).call(this,object)}}},{key:"move",value:function move(engine,map,entity,objects){var targetX=entity.position.x;var targetY=entity.position.y;switch(entity.actions.currentAction){case action_move_up:targetY--;break;case action_move_right:targetX++;break;case action_move_down:targetY++;break;case action_move_left:targetX--;break;default:console.log("No direction");break;}entity.direction.direction=action_to_direction[entity.actions.currentAction];var walkable=true;for(var i=targetX;i<targetX+entity.physical.size;i++){for(var j=targetY;j<targetY+entity.physical.size;j++){if(!Utility.walkable(i,j,map,entity,objects)){walkable=false}}}if(walkable){entity.position.x=targetX;entity.position.y=targetY;entity.collision.top=targetY;entity.collision.right=targetX+entity.physical.size;entity.collision.bottom=targetY+entity.physical.size;entity.collision.left=targetX;if(entity instanceof Player){this.playerWalkEvents(engine,entity,map[targetX][targetY])}engine.sendEvent(event_successful_action,{"action":entity.actions.currentAction,"entity":entity})}else{entity.actions.lastAction=entity.actions.currentAction;entity.actions.currentAction=action_none}}},{key:"playerWalkEvents",value:function playerWalkEvents(engine,player,square){if(square instanceof StairUpSquare&&this.depth>0){engine.sendEvent(event_up_level)}else if(square instanceof StairDownSquare){engine.sendEvent(event_down_level)}else if(square instanceof DoorSquare){square.open()}engine.sendEvent(event_player_moved)}}]);return MovementSystem}(System);
"use strict";function MusicManager(){var music=MUSIC;MUSIC=null;var currentLoop=music[0];var loop=function loop(){currentLoop.ended=function(){currentLoop=playSound(music[randomInt(music.length)]);loop()}};var init=function(){}()}
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var SprintSystem=function(_System){_inherits(SprintSystem,_System);function SprintSystem(){_classCallCheck(this,SprintSystem);var _this=_possibleConstructorReturn(this,(SprintSystem.__proto__||Object.getPrototypeOf(SprintSystem)).call(this,[component_sprint]));_this.sprintTimer=[];_this.sprintTimerMax=20;_this.combat=false;return _this}_createClass(SprintSystem,[{key:"run",value:function run(engine){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.objects[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var entity=_step.value;if(!this.combat){this.decrementSprintCounter(entity);this.determineSprintState(engine,entity)}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_successful_action:if(!this.combat&&data.entity.components.includes(component_sprint)){this.sprintHandler(engine,data.entity,data.action)}break;case event_begin_combat:this.combat=true;this.stopAllSprinting(engine);break;case event_end_combat:this.combat=false;break;}}},{key:"addObject",value:function addObject(object){if(object.components.includes(component_sprint)){_get(SprintSystem.prototype.__proto__||Object.getPrototypeOf(SprintSystem.prototype),"addObject",this).call(this,object);this.sprintTimer[object]=0}}},{key:"sprintHandler",value:function sprintHandler(engine,entity,action){if(Utility.isMovementAction(action)){if(entity.sprint.sprintCounter<entity.sprint.movesBeforeSprinting){entity.sprint.sprintCounter++}this.resetSprintTimer(entity)}else{if(entity.sprint.sprintCounter>0){entity.sprint.sprintCounter--}}this.determineSprintState(engine,entity)}},{key:"determineSprintState",value:function determineSprintState(engine,entity){if(entity.sprint.sprinting){if(entity.sprint.sprintCounter<entity.sprint.movesBeforeSprinting){this.stopSprinting(engine,entity)}}else if(!entity.sprint.sprinting&&entity.sprint.sprintCounter==entity.sprint.movesBeforeSprinting){this.startSprinting(engine,entity)}}},{key:"startSprinting",value:function startSprinting(engine,entity){if(entity instanceof Player){engine.sendEvent(event_player_start_sprinting)}entity.sprint.sprinting=true;this.resetSprintTimer(entity)}},{key:"stopSprinting",value:function stopSprinting(engine,entity){if(entity instanceof Player){engine.sendEvent(event_player_stop_sprinting)}entity.sprint.sprinting=false;entity.sprint.sprintCounter=0}},{key:"resetSprintTimer",value:function resetSprintTimer(entity){this.sprintTimer[entity]=this.sprintTimerMax}},{key:"decrementSprintCounter",value:function decrementSprintCounter(entity){if(entity.sprint.sprintCounter>0){this.sprintTimer[entity]--;if(this.sprintTimer[entity]<=0){entity.sprint.sprintCounter--;this.resetSprintTimer(entity)}}}},{key:"stopAllSprinting",value:function stopAllSprinting(engine){var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=this.objects[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var entity=_step2.value;this.stopSprinting(engine,entity)}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}}}]);return SprintSystem}(System);
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var System=function(){function System(componentRequirements){_classCallCheck(this,System);this.objects=[];this.componentRequirements=componentRequirements}_createClass(System,[{key:"addObject",value:function addObject(object){if(this.componentRequirements.length==0)return;else if(Utility.checkComponents(object,this.componentRequirements)){this.objects.push(object)}}},{key:"removeObject",value:function removeObject(object){if(this.objects.indexOf(object)!==-1){this.objects.splice(this.objects.indexOf(object),1)}}},{key:"clearObjects",value:function clearObjects(){this.objects=[]}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){}}]);return System}();
"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var VisionSystem=function(_System){_inherits(VisionSystem,_System);function VisionSystem(config){_classCallCheck(this,VisionSystem);var _this=_possibleConstructorReturn(this,(VisionSystem.__proto__||Object.getPrototypeOf(VisionSystem)).call(this,[]));_this.player;_this.map;_this.entities=[];_this.config=config;return _this}_createClass(VisionSystem,[{key:"run",value:function run(engine){}},{key:"handleEvent",value:function handleEvent(engine,eventID,data){switch(eventID){case event_start_game:case event_player_moved:case event_down_level:case event_up_level:case event_entity_spawned:this.vision(this.map,this.player);break;}}},{key:"addObject",value:function addObject(object){if(object instanceof Player){this.player=object}else if(object instanceof Level){this.map=object.map.map}else if(object instanceof Mob){this.entities.push(object)}}},{key:"vision",value:function vision(map,player){var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=map[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var r=_step.value;var _iteratorNormalCompletion3=true;var _didIteratorError3=false;var _iteratorError3=undefined;try{for(var _iterator3=r[Symbol.iterator](),_step3;!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=true){var s=_step3.value;s.display.visible=false;if(s.display.discovered>0){s.display.discovered--};if(s.components.includes(component_light)){s.light.lightLevel=0}}}catch(err){_didIteratorError3=true;_iteratorError3=err}finally{try{if(!_iteratorNormalCompletion3&&_iterator3.return){_iterator3.return()}}finally{if(_didIteratorError3){throw _iteratorError3}}}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}player.display.visible=true;map[player.position.x][player.position.y].display.visible=true;map[player.position.x][player.position.y].display.discovered=this.config.DISCOVERED_MAX;map[player.position.x][player.position.y].light.lightLevel=light_range;for(var octant=0;octant<8;octant++){this.playerSightTriangle(map,octant,player.position.x,player.position.y,this.config.PLAYER_VISION_RANGE);this.lightTriangle(map,octant,player.position.x,player.position.y,light_range)}var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=this.entities[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var e=_step2.value;if(map[e.position.x][e.position.y].display.visible){e.display.visible=true;e.display.discovered=true}else{e.display.visible=false}}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}}},{key:"lightTriangle",value:function lightTriangle(map,octant,sx,sy,range){var x=1;var shadows=[];var squaresVisible=true;while(x<=range&&squaresVisible){squaresVisible=false;var y=0;var curslope=0;while(curslope<=1){if(!this.inShadow(x,y,shadows)){squaresVisible=true;var cur=this.getTranslatedSquare(map,octant,x,y,sx,sy);if(cur===undefined){break}cur.light.lightLevel=range-x;if(cur.display.opaque){var firstBlocked=this.getFirstBlockedLight(map,octant,x,y,sx,sy,shadows,range);var lastBlocked=this.getBlockedLight(map,octant,x,y,sx,sy,shadows,range);var shadowStart=this.slope(firstBlocked.x,firstBlocked.y,BOTTOM_RIGHT);var shadowEnd=this.slope(lastBlocked.x,lastBlocked.y,TOP_LEFT);shadows.push([shadowStart,shadowEnd])}else{var above=this.getTranslatedSquare(map,octant,x,y+1,sx,sy);if(above!==undefined){}}}y++;curslope=this.slope(x,y,CENTER_SQUARE)}x++}}},{key:"getFirstBlockedLight",value:function getFirstBlockedLight(map,octant,x,y,sx,sy,shadows,range){var firstBlocked={x:x,y:y};var currentBlocked=this.getTranslatedSquare(map,octant,x,y,sx,sy);while(currentBlocked!==undefined&&currentBlocked.display.opaque&&this.slope(x,y,CENTER_SQUARE)>0){firstBlocked={x:x,y:y};if(!this.inShadow(x,y,shadows)){currentBlocked.light.lightLevel=range-x}y--;currentBlocked=this.getTranslatedSquare(map,octant,x,y,sx,sy)}return firstBlocked}},{key:"getBlockedLight",value:function getBlockedLight(map,octant,x,y,sx,sy,shadows,range){var lastBlocked={x:x,y:y};var currentBlocked=this.getTranslatedSquare(map,octant,x,y,sx,sy);while(currentBlocked!==undefined&&currentBlocked.display.opaque&&this.slope(x,y,BOTTOM_RIGHT)<1){lastBlocked={x:x,y:y};if(!this.inShadow(x,y,shadows)){currentBlocked.light.lightLevel=range-x}y++;currentBlocked=this.getTranslatedSquare(map,octant,x,y,sx,sy)}return lastBlocked}},{key:"playerSightTriangle",value:function playerSightTriangle(map,octant,sx,sy,range){var x=1;var shadows=[];var squaresVisible=true;while(x<=range&&squaresVisible){squaresVisible=false;var y=0;var curslope=0;while(curslope<=1){if(!this.inShadow(x,y,shadows)){squaresVisible=true;var cur=this.getTranslatedSquare(map,octant,x,y,sx,sy);if(cur===undefined){break}cur.display.visible=true;cur.display.discovered=this.config.DISCOVERED_MAX;if(cur.display.opaque){var firstBlocked=this.getFirstBlocked(map,octant,x,y,sx,sy,shadows);var lastBlocked=this.getBlocked(map,octant,x,y,sx,sy,shadows);var shadowStart=this.slope(firstBlocked.x,firstBlocked.y,BOTTOM_RIGHT);var shadowEnd=this.slope(lastBlocked.x,lastBlocked.y,TOP_LEFT);shadows.push([shadowStart,shadowEnd])}else{var above=this.getTranslatedSquare(map,octant,x,y+1,sx,sy);if(above!==undefined){above.display.discovered=this.config.DISCOVERED_MAX}}}y++;curslope=this.slope(x,y,CENTER_SQUARE)}x++}}},{key:"slope",value:function slope(x,y,CORNER){switch(CORNER){case CENTER_SQUARE:return y/x;case TOP_LEFT:if(x==0){return 1}return(y+.5)/(x-.5);case BOTTOM_RIGHT:return max(0,(y-.5)/(x+.5));case UPPER_BOUND:return(y+PERM)/(x-PERM);case LOWER_BOUND:return(y-PERM)/(x+PERM);}return 1}},{key:"getFirstBlocked",value:function getFirstBlocked(map,octant,x,y,sx,sy,shadows){var firstBlocked={x:x,y:y};var currentBlocked=this.getTranslatedSquare(map,octant,x,y,sx,sy);while(currentBlocked!==undefined&&currentBlocked.display.opaque&&this.slope(x,y,CENTER_SQUARE)>0){firstBlocked={x:x,y:y};if(!this.inShadow(x,y,shadows)){currentBlocked.display.visible=true;currentBlocked.display.discovered=this.config.DISCOVERED_MAX}y--;currentBlocked=this.getTranslatedSquare(map,octant,x,y,sx,sy)}return firstBlocked}},{key:"getBlocked",value:function getBlocked(map,octant,x,y,sx,sy,shadows){var lastBlocked={x:x,y:y};var currentBlocked=this.getTranslatedSquare(map,octant,x,y,sx,sy);while(currentBlocked!==undefined&&currentBlocked.display.opaque&&this.slope(x,y,BOTTOM_RIGHT)<1){lastBlocked={x:x,y:y};if(!this.inShadow(x,y,shadows)){currentBlocked.display.visible=true;currentBlocked.display.discovered=this.config.DISCOVERED_MAX}y++;currentBlocked=this.getTranslatedSquare(map,octant,x,y,sx,sy)}return lastBlocked}},{key:"inShadow",value:function inShadow(x,y,shadows){var BR=this.slope(x,y,BOTTOM_RIGHT),TL=this.slope(x,y,TOP_LEFT);var _iteratorNormalCompletion4=true;var _didIteratorError4=false;var _iteratorError4=undefined;try{for(var _iterator4=shadows[Symbol.iterator](),_step4;!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=true){var s=_step4.value;if(BR>=s[0]&&TL<=s[1])return true;else if(BR>=s[0]&&BR<=s[1]&&TL>=s[1]){BR=s[1]}else if(BR<=s[0]&&TL>=s[0]&&TL<=s[1]){TL=s[0]}}}catch(err){_didIteratorError4=true;_iteratorError4=err}finally{try{if(!_iteratorNormalCompletion4&&_iterator4.return){_iterator4.return()}}finally{if(_didIteratorError4){throw _iteratorError4}}}return false}},{key:"startSquare",value:function startSquare(x,slopeStart){if(slopeStart==0)return 0;return ceil(x*slopeStart)}},{key:"getTranslatedSquare",value:function getTranslatedSquare(map,octant,x,y,sx,sy){var uc=this.translate(octant,x,y);var fx=sx+uc[0];var fy=sy-uc[1];if(Utility.positionInBounds(fx,fy,map.length)){return map[fx][fy]}return undefined}},{key:"translate",value:function translate(octant,x,y){return[x*xxcomp[octant]+y*xycomp[octant],x*yxcomp[octant]+y*yycomp[octant]]}}]);return VisionSystem}(System);
"use strict";function Level(map,stairUp,stairDown,depth){this.components=[component_map,component_stair,component_depth];this.map=new MapComponent(map);this.stairUp=new StairComponent(stairUp.x,stairUp.y);this.stairDown=new StairComponent(stairDown.x,stairDown.y);this.depth=new DepthComponent(depth)}
"use strict";function Square(x,y,texture,solid,opaque){this.components=[component_position,component_display,component_physical,component_light];this.position=new PositionComponent(x,y);this.display=new DisplayComponent(texture,1,1,opaque);this.physical=new PhysicalComponent(solid,1);this.light=new LightComponent}WallSquare.prototype=Object.create(Square.prototype);function WallSquare(x,y){Square.call(this,x,y,texture_wall,physical_solid,display_opaque)}FloorSquare.prototype=Object.create(Square.prototype);function FloorSquare(x,y){Square.call(this,x,y,texture_floor,physical_non_solid,display_transparent)}DoorSquare.prototype=Object.create(Square.prototype);function DoorSquare(x,y){Square.call(this,x,y,texture_door_closed,physical_solid,display_opaque);this.opened=false}DoorSquare.prototype.open=function(){this.opened=true;this.physical.solid=false;this.display.texture=[texture_floor,texture_door_open];this.display.opaque=false};LootSquare.prototype=Object.create(Square.prototype);function LootSquare(x,y){Square.call(this,x,y,[texture_floor,texture_loot_closed],physical_solid,display_transparent);this.opened=false}LootSquare.prototype.open=function(){this.opened=true;this.display.texture=[texture_floor,texture_loot_open]};StairUpSquare.prototype=Object.create(Square.prototype);function StairUpSquare(x,y){Square.call(this,x,y,[texture_floor,texture_stair_up],physical_solid,display_transparent)}StairDownSquare.prototype=Object.create(Square.prototype);function StairDownSquare(x,y){Square.call(this,x,y,[texture_floor,texture_stair_down],physical_solid,display_transparent)}

//# sourceMappingURL=bundle.min.js.map